// smartMenuGen/lib/prompt-builder.js
// èšåˆå¤©æ°”ã€å¿ƒæƒ…ã€å®¶åº­ç”»åƒã€å†å²ä¸å€™é€‰èœè°±ï¼Œç”Ÿæˆ system + user prompt
// v2: æ·±åº¦å¿ƒæƒ…å¥—é¤æ¨è + Kimi è”ç½‘æœç´¢æŒ‡å¼•

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   å¸¸é‡ä¸æ˜ å°„è¡¨
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/**
 * ä¸­æ–‡ â†’ è‹±æ–‡æšä¸¾ fallback (æ—§ç‰ˆå®¢æˆ·ç«¯å…¼å®¹)
 * spec v1.1: "å¼€å¿ƒ" â†’ "celebratory", "ç–²æƒ«" â†’ "exhausted" ç­‰
 */
const MOOD_CN_MAP = {
  'å¼€å¿ƒ': 'celebratory',
  'ç–²æƒ«': 'exhausted',
  'æƒ³åƒè½»é£Ÿ': 'health_conscious',
  'é¦‹äº†': 'craving_heavy',
  'éšä¾¿': 'random',
};

/**
 * æ¯ç§å¿ƒæƒ…å¯¹åº”çš„ AI æ¨èç­–ç•¥
 * label   â€” ä¸­æ–‡æ˜¾ç¤ºå
 * goal    â€” æ ¸å¿ƒç›®æ ‡æè¿°
 * rules   â€” å…·ä½“é€‰èœè§„åˆ™ï¼ˆæ³¨å…¥ user messageï¼‰
 * dietStyleOverride â€” å¿ƒæƒ…å¯è¦†ç›–çš„ dietStyleï¼ˆä»…å½“ç”¨æˆ·åŸå§‹å€¼ä¸º home æ—¶ç”Ÿæ•ˆï¼‰
 */
const MOOD_STRATEGY = {
  exhausted: {
    label: 'ç–²æƒ«',
    goal: 'å¿«æ‰‹çœåŠ›ã€é«˜è›‹ç™½æ¢å¤ä½“åŠ›',
    rules: [
      'ä¼˜å…ˆé€‰æ‹© cook_minutes â‰¤ 20 çš„èœå“ï¼ˆæ ‡ç­¾ä¸­å« quick è€…åŠ åˆ†ï¼‰',
      'ä¼˜å…ˆ cook_type ä¸º stir_fry æˆ– steamï¼ˆå¿«ç‚’/è’¸ = å°‘æ­¥éª¤ã€å°‘æ²¹çƒŸï¼‰',
      'å¥—é¤æ€»çƒ¹é¥ªæ—¶é—´åº”æ§åˆ¶åœ¨ 30 åˆ†é’Ÿä»¥å†…',
      'é€‚å½“åå‘é«˜è›‹ç™½é£Ÿæï¼ˆé¸¡è‚‰ã€é±¼ã€è›‹ã€è±†è…ï¼‰å¸®åŠ©æ¢å¤ç²¾åŠ›',
      'é¿å…éœ€è¦é•¿æ—¶é—´ç‚–ç…®ï¼ˆstewï¼‰æˆ–å¤æ‚å·¥åºçš„èœå¼',
    ],
    dietStyleOverride: 'quick',
  },
  celebratory: {
    label: 'å¼€å¿ƒ / åº†ç¥',
    goal: 'ä¸°ç››å¤§é¤ã€è‰²é¦™å‘³ä¿±å…¨',
    rules: [
      'å¯å¤§èƒ†é€‰æ‹© cook_minutes è¾ƒé«˜çš„ç¡¬èœï¼ˆçº¢çƒ§ã€ç‚–ç…²å‡å¯ï¼‰',
      'è¤èœåº”é€‰ä¸åŒä¸»æ–™ç±»å‹ï¼ˆå¦‚ä¸€é¸¡ä¸€é±¼ï¼‰ï¼Œå¢åŠ èœå“ä¸°å¯Œåº¦',
      'æ­é…è‡³å°‘ä¸€é“ã€Œè‰²å½©é²œè‰³ã€æˆ–ã€Œæœ‰ä»ªå¼æ„Ÿã€çš„èœï¼ˆå¦‚ç³–é†‹ç±»ã€å¹²é”…ç±»ï¼‰',
      'å¦‚æœ‰æ±¤å“éœ€æ±‚ï¼Œä¼˜å…ˆæ¨èç‚–å“ / ç…²æ±¤ï¼Œå¢åŠ å®´å¸­æ„Ÿ',
      'æ•´ä½“é£å‘³å¯å¤§èƒ†å¯¹æ¯”æ­é…ï¼ˆå¦‚é…¸ç”œ + å’¸é²œï¼‰ï¼Œé¿å…å…¨éƒ¨åŒä¸€å£å‘³',
    ],
    dietStyleOverride: 'rich',
  },
  health_conscious: {
    label: 'æƒ³åƒè½»é£Ÿ',
    goal: 'ä½æ²¹ä½ç›ã€æ¸…æ·¡å…»ç”Ÿ',
    rules: [
      'ä¼˜å…ˆ cook_type ä¸º steam æˆ– cold_dressï¼ˆè’¸ / å‡‰æ‹Œï¼‰',
      'ä¼˜å…ˆ flavor_profile ä¸º light æˆ– sour_fresh çš„æ¸…æ·¡èœå“',
      'è”¬èœç±»èœå“ï¼ˆmeat=vegetableï¼‰å æ¯”åº”å°½é‡é«˜',
      'é¿å… flavor_profile ä¸º spicy æˆ– salty_umami çš„é‡å£å‘³èœå“',
      'å¯æ¨èç™½ç¼ã€æ¸…è’¸ã€æ²™æ‹‰ç±»èœå¼',
    ],
    dietStyleOverride: 'light',
  },
  craving_heavy: {
    label: 'é¦‹äº† / æƒ³è§£é¦‹',
    goal: 'ä¸‹é¥­ç¡¬èœã€æ»¡è¶³å‘³è•¾',
    rules: [
      'ä¼˜å…ˆ flavor_profile ä¸º salty_umami æˆ– spicy çš„èœå“',
      'è‚‰ç±»èœå“åº”é€‰å‘³é“æµ“éƒçš„åšæ³•ï¼ˆçº¢çƒ§ã€é…±ç„–ã€å¹²ç…¸ï¼‰',
      'ä¼˜å…ˆ cook_type ä¸º stir_fry æˆ– braiseï¼ˆç…ç‚’ / çº¢çƒ§ï¼‰',
      'è‡³å°‘ä¸€é“ç»å…¸ä¸‹é¥­èœï¼ˆå¦‚å®«ä¿é¸¡ä¸ã€çº¢çƒ§è‚‰ã€é±¼é¦™è‚‰ä¸ç­‰ï¼‰',
      'ç´ èœä¹Ÿåº”é€‰é£å‘³çªå‡ºçš„ï¼ˆå¦‚å¹²ç…¸ã€è’œè“‰ã€é…¸è¾£å£å‘³ï¼‰',
    ],
    dietStyleOverride: 'rich',
  },
  random: {
    label: 'éšä¾¿',
    goal: 'å‡è¡¡æ­é…ã€å£å‘³å¤šæ ·',
    rules: [
      'ä¸é™„åŠ ç‰¹æ®Šåå‘ï¼Œå®Œå…¨æŒ‰ç”¨æˆ· preference å’Œèœå“å¤šæ ·æ€§é€‰æ‹©',
      'æ³¨é‡è¤ç´ æ­é…çš„å£å‘³å·®å¼‚åŒ–ï¼ˆé¿å…å…¨éƒ¨å’¸é²œæˆ–å…¨éƒ¨æ¸…æ·¡ï¼‰',
      'ä¼˜å…ˆé€‰æ‹© flavor_profile ä¸é‡å¤çš„èœå“ç»„åˆ',
    ],
    dietStyleOverride: null,
  },
};

/** çƒ¹é¥ªæ–¹å¼ä¸­æ–‡æ ‡ç­¾ */
const COOK_LABELS = {
  stir_fry: 'ç‚’',
  stew: 'ç‚–/ç…²',
  steam: 'è’¸',
  cold_dress: 'å‡‰æ‹Œ',
  fry: 'ç…/ç‚¸',
  braise: 'çº¢çƒ§/ç„–',
  boil: 'ç…®',
};

/** é£å‘³ç”»åƒä¸­æ–‡æ ‡ç­¾ */
const FLAVOR_LABELS = {
  salty_umami: 'å’¸é²œ',
  light: 'æ¸…æ·¡',
  spicy: 'è¾£',
  sweet_sour: 'é…¸ç”œ',
  sour_fresh: 'é…¸çˆ½',
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   è¾…åŠ©å‡½æ•°
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/**
 * å½’ä¸€åŒ–å¿ƒæƒ…å€¼ï¼šæ”¯æŒä¸­æ–‡ â†’ è‹±æ–‡æšä¸¾æ˜ å°„
 * @param {string} mood
 * @returns {string} æ ‡å‡†æšä¸¾å€¼
 */
function normalizeMood(mood) {
  if (!mood) return 'random';
  const val = String(mood).trim();
  if (MOOD_STRATEGY[val]) return val;          // å·²æ˜¯æ ‡å‡†æšä¸¾
  return MOOD_CN_MAP[val] || 'random';         // ä¸­æ–‡æ˜ å°„æˆ–å…œåº•
}

/**
 * æ ¹æ®å¤©æ°”ä¿¡æ¯ç”Ÿæˆ AI å¯ç†è§£çš„é¥®é£Ÿå»ºè®®
 * @param {Object} weather - { text, temp }
 * @returns {string} å¤©æ°”é¥®é£Ÿå»ºè®®æ–‡æ¡ˆ
 */
function getWeatherHint(weather) {
  if (!weather || (!weather.text && weather.temp == null)) return '';
  const hints = [];
  const temp = weather.temp;
  const text = weather.text || '';

  // æ¸©åº¦åŒºé—´ â†’ èœå¼å»ºè®®
  if (temp != null) {
    if (temp <= 5) {
      hints.push('æ°”æ¸©å¾ˆä½ï¼ˆâ‰¤5Â°Cï¼‰ï¼Œé€‚åˆç‚–æ±¤ã€çº¢çƒ§ã€ç ‚é”…ç­‰æš–èº«èœï¼Œçƒ­æ±¤åŠ åˆ†');
    } else if (temp <= 15) {
      hints.push('å¤©æ°”åå‡‰ï¼ˆ5-15Â°Cï¼‰ï¼Œç…²æ±¤å’Œç‚’èœéƒ½åˆé€‚ï¼Œå¯æ­é…ä¸€é“æ¸©çƒ­æ±¤å“');
    } else if (temp <= 25) {
      hints.push('æ°”æ¸©é€‚ä¸­ï¼ˆ15-25Â°Cï¼‰ï¼Œèœå¼é€‰æ‹©ç©ºé—´å¤§ï¼Œè¤ç´ å‡è¡¡å³å¯');
    } else if (temp <= 33) {
      hints.push('å¤©æ°”åçƒ­ï¼ˆ25-33Â°Cï¼‰ï¼Œä¼˜å…ˆå‡‰æ‹Œã€æ¸…è’¸ã€å¿«ç‚’ç­‰æ¸…çˆ½èœå¼');
    } else {
      hints.push('é«˜æ¸©é…·æš‘ï¼ˆ>33Â°Cï¼‰ï¼Œå»ºè®®å‡‰æ‹Œ/å†·é£Ÿä¸ºä¸»ï¼Œé¿å…æ²¹è…»ï¼Œæ³¨æ„è¡¥å……æ°´åˆ†');
    }
  }

  // å¤©æ°”çŠ¶å†µ â†’ é¢å¤–å»ºè®®
  if (text.includes('é›¨') || text.includes('é›ª')) {
    hints.push('é›¨é›ªå¤©ï¼Œæš–èº«æ±¤å“å’Œç‚–èœæ›´èƒ½å¸¦æ¥æ…°è—‰æ„Ÿ');
  }
  if (text.includes('é˜´') || text.includes('å¤šäº‘')) {
    hints.push('é˜´å¤©é€‚åˆè‰²å½©ä¸°å¯Œçš„èœå“ï¼Œæå‡ç”¨é¤æ„‰æ‚¦æ„Ÿ');
  }
  if (text.includes('é£') || text.includes('å¤§é£')) {
    hints.push('å¤§é£å¤©é€‚åˆçƒ­é£Ÿä¸ºä¸»ï¼Œç‚–ç…®ç±»èœå“');
  }

  return hints.join('ï¼›');
}

/**
 * è·å–å½“å‰å­£èŠ‚çš„é£Ÿæå»ºè®®å…³é”®è¯ï¼ˆä¾›è”ç½‘æœç´¢å‚è€ƒï¼‰
 * @returns {string}
 */
function getSeasonalHint() {
  const month = new Date().getMonth() + 1; // 1-12
  if (month >= 3 && month <= 5) return 'æ˜¥å­£ï¼ˆæ—¶ä»¤ï¼šæ˜¥ç¬‹ã€è èœã€é¦™æ¤¿ã€è±Œè±†ç­‰ï¼‰';
  if (month >= 6 && month <= 8) return 'å¤å­£ï¼ˆæ—¶ä»¤ï¼šä¸ç“œã€è‹¦ç“œã€èŒ„å­ã€æ¯›è±†ç­‰ï¼‰';
  if (month >= 9 && month <= 11) return 'ç§‹å­£ï¼ˆæ—¶ä»¤ï¼šè²è—•ã€å±±è¯ã€æ —å­ã€å—ç“œç­‰ï¼‰';
  return 'å†¬å­£ï¼ˆæ—¶ä»¤ï¼šç™½èåœã€å¤§ç™½èœã€å†¬ç¬‹ã€ç¾Šè‚‰ç­‰ï¼‰';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   æ ¸å¿ƒ Prompt æ„å»º
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/**
 * æ„å»º system prompt â€” å®šä¹‰ AI è§’è‰²ä¸å†³ç­–æ¡†æ¶
 * @returns {string}
 */
function buildSystemPrompt() {
  return `ä½ æ˜¯ã€Œæ¡ŒåŒæ­¥ã€App çš„å®¶åº­æ™šé¤ AI æ­é…é¡¾é—®ã€‚ä½ å…¼å…·ä¸“ä¸šè¥å…»å¸ˆè§†è§’å’Œä¸­å¼å®¶å¸¸èœæ­é…ç»éªŒã€‚ä½ çš„è¡¨è¾¾é£æ ¼åƒä¸€ä½æ‡‚è¥å…»çš„è€æœ‹å‹ï¼Œä¸“ä¸šä½†ä¸ç«¯ç€ï¼Œæ¸©æš–è€Œä¸å•°å—¦ã€‚

ä½ çš„æ ¸å¿ƒä»»åŠ¡ï¼šæ ¹æ®ç”¨æˆ·å½“ä¸‹çš„å¤©æ°”ã€å¿ƒæƒ…ã€å®¶åº­ç”»åƒå’Œå¿Œå£ï¼Œä»å€™é€‰èœè°±ä¸­ç²¾å‡†æŒ‘é€‰å‡ºä¸€ç»„æœ€å®Œç¾çš„ã€Œå¿ƒæƒ…å¥—é¤ã€ã€‚

## å†³ç­–æ¡†æ¶ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åˆ—ï¼‰

### P0 â€” çº¢çº¿çº¦æŸï¼ˆä¸å¯è¿åï¼‰
- **å¿Œå£/è¿‡æ•**ï¼šç”¨æˆ·æ ‡æ³¨çš„å¿Œå£é£Ÿæå¿…é¡»ä¸¥æ ¼æ’é™¤ï¼Œé›¶å®¹å¿
- **å¥—é¤ç»“æ„**ï¼šå¿…é¡»ç²¾ç¡®æ»¡è¶³ç”¨æˆ·è¦æ±‚çš„ã€ŒNè¤ + Nç´  + Næ±¤ã€ç»“æ„
- **ID åˆæ³•æ€§**ï¼šè¿”å›çš„æ¯ä¸ª recipeId å¿…é¡»æ¥è‡ªç”¨æˆ·æä¾›çš„å€™é€‰åˆ—è¡¨

### P1 â€” å¿ƒæƒ…é€‚é…
- æ ¹æ®ç”¨æˆ·å½“å‰å¿ƒæƒ…ï¼ˆexhausted/celebratory/health_conscious/craving_heavy/randomï¼‰ï¼Œæ‰§è¡Œå¯¹åº”çš„é€‰èœç­–ç•¥
- ç”¨æˆ·æ¶ˆæ¯ä¸­ä¼šç»™å‡ºè¯¦ç»†çš„å¿ƒæƒ…ç­–ç•¥è§„åˆ™ï¼Œè¯·ä¸¥æ ¼éµå¾ª

### P2 â€” å¤©æ°”é€‚é…
- å¯’å†·/é›¨é›ªå¤© â†’ ç‚–æ±¤ã€çº¢çƒ§ã€æš–èº«èœå“ä¼˜å…ˆ
- ç‚çƒ­/æ™´å¤© â†’ å‡‰æ‹Œã€æ¸…è’¸ã€å¿«ç‚’ç­‰æ¸…çˆ½èœå“ä¼˜å…ˆ
- å¯ç»“åˆè”ç½‘æœç´¢æŸ¥çœ‹å½“å­£æ—¶ä»¤é£Ÿææ¨èï¼Œä¼˜å…ˆåº”å­£èœå“

### P3 â€” è¥å…»ä¸å£å‘³å¹³è¡¡
- åŒå¥—é¤ä¸­ flavor_profile å°½é‡ä¸é‡å¤ï¼ˆå¦‚ä¸è¦ä¸¤é“éƒ½æ˜¯å’¸é²œï¼‰
- åŒå¥—é¤ä¸­ cook_type å°½é‡ä¸é‡å¤ï¼ˆå¦‚ä¸è¦ä¸¤é“éƒ½æ˜¯ç‚’ï¼‰
- åŒå¥—é¤ä¸­ meatï¼ˆä¸»æ–™ç±»å‹ï¼‰å°½é‡ä¸é‡å¤ï¼ˆå¦‚ä¸è¦ä¸¤é“éƒ½ç”¨é¸¡è‚‰ï¼‰
- è¤èœæä¾›è›‹ç™½è´¨ï¼Œç´ èœæä¾›è†³é£Ÿçº¤ç»´+ç»´ç”Ÿç´ ï¼Œæ±¤å“è¡¥å……æ°´åˆ†

### P4 â€” çµæ„Ÿç¯®å­ä¼˜å…ˆ
- å¦‚æœç”¨æˆ·æä¾›äº†"çµæ„Ÿç¯®å­"ï¼ˆç”¨æˆ·ä¸»åŠ¨æ”¶è—æˆ–å†°ç®±åŒ¹é…çš„èœè°±ï¼‰ï¼Œåœ¨æ»¡è¶³å¥—é¤ç»“æ„å’Œçº¢çº¿çº¦æŸçš„å‰æä¸‹ï¼Œä¼˜å…ˆä»ç¯®å­ä¸­é€‰æ‹©
- ç¯®å­ä¸­ priority ä¸º "high" çš„èœè°±ï¼ˆå†°ç®±å³å°†è¿‡æœŸé£Ÿæï¼‰ï¼Œåº”æœ€ä¼˜å…ˆä½¿ç”¨
- ç¯®å­ä¸­çš„èœè°±å¯èƒ½ä¸åœ¨å€™é€‰åˆ—è¡¨ä¸­ï¼ˆå¤–éƒ¨å¯¼å…¥ï¼‰ï¼Œæ­¤æ—¶å¯ç›´æ¥ä½¿ç”¨ç¯®å­ä¸­çš„èœè°± ID å’Œåç§°
- ç¯®å­åªæ˜¯ä¼˜å…ˆå»ºè®®ï¼Œä¸æ˜¯å¼ºåˆ¶çº¦æŸã€‚å¦‚æœç¯®å­ä¸­çš„èœä¸é€‚åˆå½“å‰å¥—é¤ç»“æ„/å¿ƒæƒ…/å¿Œå£ï¼Œå¯ä»¥è·³è¿‡

### P5 â€” å»é‡
- å¦‚æœç”¨æˆ·æä¾›äº†æœ€è¿‘åšè¿‡çš„èœåï¼Œé¿å¼€åŒåèœå’Œç›¸ä¼¼ä¸»æ–™çš„èœ

### P6 â€” è”ç½‘å¢å¼ºï¼ˆå¯é€‰ï¼‰
å½“ä½ éœ€è¦é¢å¤–çš„é¥®é£Ÿæ­é…çµæ„Ÿæ—¶ï¼Œå¯ä½¿ç”¨è”ç½‘æœç´¢è·å–ï¼š
- å½“å­£æ—¶ä»¤é£Ÿææ¨è
- ç‰¹å®šå¿ƒæƒ…/å¤©æ°”ä¸‹çš„è¥å…»æ­é…å»ºè®®
- ç»å…¸èœå“ç»„åˆå‚è€ƒ
æ³¨æ„ï¼šè”ç½‘æœç´¢æ˜¯è¾…åŠ©æ‰‹æ®µï¼Œæœ€ç»ˆæ¨èå¿…é¡»ä»å€™é€‰åˆ—è¡¨ä¸­é€‰æ‹©ã€‚

## è¾“å‡ºæ ¼å¼

**ä¸¥æ ¼è¿”å›çº¯ JSONï¼Œä¸è¦åŒ…å«ä»»ä½• markdown æ ‡è®°ã€ä»£ç å—å›´æ æˆ–é¢å¤–æ–‡å­—ï¼š**
{
  "reasoning": "ç”¨æœ‹å‹èŠå¤©çš„è¯­æ°”ï¼Œäº²åˆ‡åœ°å‘Šè¯‰ç”¨æˆ·ä»Šå¤©ä¸ºä»€ä¹ˆé€‰äº†è¿™å‡ é“èœï¼ˆ2-3å¥ï¼Œâ‰¤100å­—ï¼‰ã€‚è¦ä½“ç°è¥å…»æ­é…çš„ç”¨å¿ƒï¼Œä½†ä¸è¦ç”¨æœ¯è¯­ï¼Œåƒè·Ÿå®¶äººè¯´è¯ä¸€æ ·è‡ªç„¶æ¸©æš–ã€‚ä¾‹ï¼š'å¤©å†·äº†æ¥ç¢—æš–æš–çš„é±¼ç‰‡ï¼Œé…ä¸ªé…¸ç”œçš„ç•ªèŒ„ç‚’è›‹ï¼Œç®€å•åˆå¼€èƒƒï¼Œæ­£å¥½æš–æš–èº«å­ã€‚'å¦‚æœç”¨äº†çµæ„Ÿç¯®å­ä¸­çš„èœè°±ï¼Œè‡ªç„¶åœ°æä¸€å¥ä¸ºä»€ä¹ˆé€‰äº†å®ƒã€‚",
  "recipeIds": ["id1", "id2", ...],
  "dishHighlights": { "id1": "è¿™é“èœçš„äº®ç‚¹æˆ–é€‰æ‹©ç†ç”±ï¼ˆâ‰¤20å­—ï¼‰", "id2": "..." }
}

dishHighlights ä¸ºå¯é€‰å­—æ®µï¼Œä¸ºæ¯é“èœç»™å‡ºä¸€å¥ç®€çŸ­çš„é€‰æ‹©ç†ç”±ï¼ˆå¦‚"æ¥è‡ªçµæ„Ÿç¯®ï¼Œå†°ç®±æœ‰ç°æˆé£Ÿæ"ã€"ç–²æƒ«æ—¶å¿«æ‰‹è’¸èœæœ€çœåŠ›"ï¼‰ã€‚
recipeIds é¡ºåºå¿…é¡»ä¸¥æ ¼éµå¾ªï¼šå…ˆæ‰€æœ‰è¤èœ â†’ å†æ‰€æœ‰ç´ èœ â†’ æœ€åæ±¤ï¼ˆè‹¥æœ‰ï¼‰ã€‚`;
}

/**
 * æ„å»º user message â€” æ³¨å…¥æ‰€æœ‰ä¸Šä¸‹æ–‡ä¿¡æ¯
 * @param {Object} opts
 * @param {Object} opts.preference  - ç”¨æˆ·åå¥½
 * @param {string} opts.mood        - å¿ƒæƒ…ï¼ˆæ ‡å‡†æšä¸¾æˆ–ä¸­æ–‡ï¼‰
 * @param {Object} opts.weather     - { text, temp }
 * @param {string} [opts.recentDishNames] - æœ€è¿‘åšè¿‡çš„èœåï¼ˆé€—å·åˆ†éš”ï¼‰
 * @param {Array}  opts.candidates  - å€™é€‰èœè°±ç²¾ç®€å¯¹è±¡æ•°ç»„
 * @returns {string}
 */
function buildUserMessage(opts) {
  const { preference, mood, weather, recentDishNames, candidates, basketItems } = opts;
  const meatCount = preference.meatCount || 1;
  const vegCount = preference.vegCount || 1;
  const soupCount = preference.soupCount || 0;
  const total = meatCount + vegCount + soupCount;

  const normalizedMood = normalizeMood(mood);
  const strategy = MOOD_STRATEGY[normalizedMood] || MOOD_STRATEGY.random;
  const weatherHint = getWeatherHint(weather);
  const seasonalHint = getSeasonalHint();

  const parts = [];

  // â”€â”€ Section 1: å®¶åº­ç”»åƒ â”€â”€
  parts.push('## å®¶åº­ç”»åƒ');
  parts.push(`- ç”¨é¤äººæ•°ï¼š${preference.adultCount || 2} ä½æˆäºº`);
  if (preference.hasBaby) {
    parts.push(`- å®å®ï¼š${preference.babyMonth || 12} æœˆé¾„ï¼ˆéœ€è¾…é£Ÿå…¼å®¹ï¼Œé¿å…è¾£æ¤’ã€èŠ±æ¤’ã€æ•´é¢—åšæœã€è¿‡ç¡¬é£Ÿæï¼‰`);
  }
  parts.push(`- å¥—é¤ç»“æ„ï¼š${meatCount} è¤ + ${vegCount} ç´ ${soupCount ? ' + 1 æ±¤' : ''}ï¼ˆå…± ${total} é“èœï¼‰`);

  if (preference.avoidList && preference.avoidList.length > 0) {
    parts.push(`- âš ï¸ ä¸¥æ ¼å¿Œå£ï¼š${preference.avoidList.join('ã€')}ï¼ˆçº¢çº¿ï¼å¿…é¡»æ’é™¤å«è¿™äº›æˆåˆ†çš„æ‰€æœ‰èœï¼‰`);
  }

  // é¥®é£Ÿé£æ ¼ï¼šå¿ƒæƒ…å¯è¦†ç›–é»˜è®¤ home
  const effectiveStyle = (preference.dietStyle === 'home' && strategy.dietStyleOverride)
    ? strategy.dietStyleOverride
    : preference.dietStyle;
  if (effectiveStyle && effectiveStyle !== 'home') {
    const styleLabels = { light: 'æ¸…æ·¡å…»ç”Ÿ', rich: 'ä¸°ç››å¤§é¤', quick: 'å¿«æ‰‹çœæ—¶' };
    parts.push(`- é¥®é£Ÿé£æ ¼ï¼š${styleLabels[effectiveStyle] || effectiveStyle}`);
  }

  if (preference.isTimeSave) {
    parts.push('- â± çœæ—¶æ¨¡å¼å·²å¼€å¯ï¼šä¼˜å…ˆé€‰æ‹© cook_minutes ä½çš„èœå“');
  }

  // â”€â”€ Section 2: å¤©æ°”ä¸Šä¸‹æ–‡ â”€â”€
  parts.push('');
  parts.push('## ä»Šæ—¥å¤©æ°”');
  if (weather && (weather.text || weather.temp != null)) {
    const tempStr = weather.temp != null ? ` ${weather.temp}Â°C` : '';
    parts.push(`- å®å†µï¼š${weather.text || 'æœªçŸ¥'}${tempStr}`);
    if (weatherHint) parts.push(`- é¥®é£Ÿå»ºè®®ï¼š${weatherHint}`);
  } else {
    parts.push('- å¤©æ°”ä¿¡æ¯ä¸å¯ç”¨ï¼Œè¯·å¿½ç•¥å¤©æ°”å› ç´ ');
  }
  parts.push(`- å½“å‰å­£èŠ‚ï¼š${seasonalHint}`);

  // â”€â”€ Section 3: å¿ƒæƒ… + é€‰èœç­–ç•¥ â”€â”€
  parts.push('');
  parts.push(`## ä»Šæ—¥å¿ƒæƒ…ï¼š${strategy.label}`);
  parts.push(`ğŸ¯ æ­é…ç›®æ ‡ï¼š${strategy.goal}`);
  parts.push('');
  parts.push('è¯·ä¸¥æ ¼æ‰§è¡Œä»¥ä¸‹é€‰èœç­–ç•¥ï¼š');
  strategy.rules.forEach((rule, i) => {
    parts.push(`${i + 1}. ${rule}`);
  });

  // â”€â”€ Section 3.5: çµæ„Ÿç¯®å­ï¼ˆç”¨æˆ·æ”¶è— / å†°ç®±åŒ¹é…çš„å¤‡é€‰èœè°±ï¼Œå¿…å¸¦ sourceDetailï¼‰â”€â”€
  if (Array.isArray(basketItems) && basketItems.length > 0) {
    parts.push('');
    parts.push('## çµæ„Ÿç¯®å­ï¼ˆç”¨æˆ·ä¸»åŠ¨æ”¶è—çš„å¤‡é€‰èœè°±ï¼Œè¯·ä¼˜å…ˆè€ƒè™‘ï¼‰');
    const highPriority = basketItems.filter(b => b.priority === 'high');
    const normalPriority = basketItems.filter(b => b.priority !== 'high');
    const fmt = (b) => `- ${b.name}ï¼ˆID: ${b.id}ï¼Œæ¥æº: ${b.source}ï¼Œæ¥æºè¯´æ˜: ${b.sourceDetail || b.source || '-'}ï¼‰`;
    if (highPriority.length > 0) {
      parts.push('âš¡ é«˜ä¼˜å…ˆï¼ˆå†°ç®±é£Ÿæå³å°†è¿‡æœŸï¼Œè¯·åŠ¡å¿…ä¼˜å…ˆä½¿ç”¨ï¼‰ï¼š');
      highPriority.forEach(b => { parts.push(fmt(b)); });
    }
    if (normalPriority.length > 0) {
      parts.push('æ™®é€šä¼˜å…ˆï¼ˆç”¨æˆ·æ”¶è—ï¼Œå°½é‡é€‰ç”¨ï¼‰ï¼š');
      normalPriority.forEach(b => { parts.push(fmt(b)); });
    }
    parts.push('æ³¨æ„ï¼šç¯®å­ä¸­çš„èœè°± ID å¯èƒ½ä¸åœ¨å€™é€‰åˆ—è¡¨ä¸­ï¼ˆæ¥è‡ªå¤–éƒ¨å¯¼å…¥ï¼‰ï¼Œä½†å¦‚æœ ID åŒ¹é…å€™é€‰åˆ—è¡¨ä¸­çš„èœè°±ï¼Œåº”ä¼˜å…ˆé€‰æ‹©ã€‚');
    parts.push('ã€å¿…è¾¾ã€‘reasoning è¯æœ¯ä¸­å¿…é¡»ä½“ç°ã€Œæˆ‘çœ‹åˆ°äº†ä½ çš„çµæ„Ÿã€å¹¶ç‚¹åå…·ä½“æ¥æºï¼ˆå¦‚ï¼šæ¥è‡ªå†°ç®±åŒ¹é…ã€å°çº¢ä¹¦å¯¼å…¥ã€èœè°±åº“æ”¶è—ç­‰ï¼‰ï¼Œä¸ä¸Šè¿°æ¥æºè¯´æ˜ä¸€è‡´ã€‚');
  }

  // â”€â”€ Section 4: å»é‡ â”€â”€
  if (recentDishNames) {
    parts.push('');
    parts.push('## æœ€è¿‘åšè¿‡çš„èœï¼ˆè¯·é¿å…é‡å¤æˆ–ç›¸ä¼¼ä¸»æ–™ï¼‰');
    parts.push(recentDishNames);
  }

  // â”€â”€ Section 5: å€™é€‰èœè°± â”€â”€
  parts.push('');
  const candidateCount = (candidates || []).length;
  parts.push(`## å€™é€‰èœè°±ï¼ˆå…± ${candidateCount} é“ï¼Œè¯·ä¸¥æ ¼åªä»ä¸­é€‰æ‹©ï¼‰`);

  // ç²¾ç®€å€™é€‰åˆ—è¡¨ï¼Œæœ€å¤š 80 æ¡ï¼ŒèŠ‚çœ token
  const simplified = (candidates || []).slice(0, 80).map((r) => {
    const isSoup = r.dish_type === 'soup' || (r.name && r.name.includes('æ±¤'));
    const isVeg = r.meat === 'vegetable';
    const obj = {
      id: r.id || r._id,
      name: r.name,
      ç±»å‹: isVeg ? 'ç´ ' : (isSoup ? 'æ±¤' : 'è¤'),
      çƒ¹é¥ª: COOK_LABELS[r.cook_type] || r.cook_type || '-',
      é£å‘³: FLAVOR_LABELS[r.flavor_profile] || r.flavor_profile || '-',
    };
    if (r.cook_minutes) obj.è€—æ—¶ = r.cook_minutes + 'min';
    if (r.tags && r.tags.length > 0) obj.æ ‡ç­¾ = r.tags.join(',');
    return obj;
  });
  parts.push(JSON.stringify(simplified, null, 0));

  // â”€â”€ Section 6: è¾“å‡ºæŒ‡ä»¤ â”€â”€
  parts.push('');
  parts.push('## è¯·è¾“å‡º');
  parts.push(`ç»¼åˆä»¥ä¸Šå¤©æ°”ã€å¿ƒæƒ…ã€å®¶åº­ç”»åƒï¼Œä»å€™é€‰åˆ—è¡¨ä¸­é€‰å‡ºæ°å¥½ ${total} é“èœï¼Œç»„æˆä¸€ä»½å®Œç¾çš„ã€Œ${strategy.label}å¿ƒæƒ…å¥—é¤ã€ã€‚`);
  parts.push(`é¡ºåºï¼š${meatCount} ä¸ªè¤èœ id â†’ ${vegCount} ä¸ªç´ èœ id${soupCount ? ' â†’ 1 ä¸ªæ±¤ id' : ''}ã€‚`);
  parts.push('è¿”å›çº¯ JSONï¼š{ "reasoning": "ç”¨æœ‹å‹èŠå¤©çš„è¯­æ°”ï¼Œäº²åˆ‡å‘Šè¯‰ç”¨æˆ·ä»Šå¤©ä¸ºä»€ä¹ˆé€‰äº†è¿™å‡ é“èœï¼ˆ2-3å¥ï¼Œâ‰¤100å­—ï¼Œè‡ªç„¶æ¸©æš–ï¼Œä¸ç”¨æœ¯è¯­ã€‚å¦‚é€‰äº†çµæ„Ÿç¯®å­ä¸­çš„èœï¼Œè‡ªç„¶åœ°æä¸€å¥ä¸ºä»€ä¹ˆé€‰äº†å®ƒï¼‰", "recipeIds": ["id1", ...], "dishHighlights": { "id1": "é€‰æ‹©ç†ç”±ï¼ˆâ‰¤20å­—ï¼‰", ... } }');

  return parts.join('\n');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   å¯¼å‡º
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

module.exports = {
  buildSystemPrompt,
  buildUserMessage,
  normalizeMood,
  getWeatherHint,
  getSeasonalHint,
  MOOD_STRATEGY,
  MOOD_CN_MAP,
  COOK_LABELS,
  FLAVOR_LABELS,
};
