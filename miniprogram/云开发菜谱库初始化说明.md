# 云开发菜谱库初始化说明

## 概述

TableSync 支持从云数据库动态拉取菜谱数据，实现菜谱的在线更新，无需更新小程序代码。

## 1. 菜谱 JSON 模型（爱料理结构）

- **主料 / 调料分块**：`main_ingredients`（主料）、`seasonings`（调料），便于 UI 分块显示。
- **步骤必带图**：每个 `steps[i]` 含 `step_image_url`，用于步骤页沉浸式头部或步骤图。

完整字段见 `data/recipeSchema.js` 顶部注释；示例数据见 `data/recipeSchema.sample.json`。

## 2. 开通云开发

1. 微信开发者工具 → 云开发 → 开通并创建环境，记下**环境 ID**。
2. 在 `project.config.json` 中可配置（可选）：
   ```json
   "cloudfunctionRoot": "cloudfunctions/"
   ```
3. 若需指定环境，在 `miniprogram/utils/cloudInitRecipes.js` 中修改 `DEFAULT_ENV` 为你的环境 ID；留空则使用项目默认环境。

## 3. 初始化数据库

**方式一：控制台执行（推荐）**

1. 真机或模拟器运行小程序。
2. 打开调试器 → Console，执行：
   ```js
   getApp().initRecipesCollection()
   ```
3. 若集合已有数据仍要追加示例，执行：
   ```js
   getApp().initRecipesCollection({ force: true })
   ```

**方式二：指定环境**

```js
getApp().initRecipesCollection({ env: '你的环境ID', force: true })
```

**方式三：云开发控制台手动导入**

1. 云开发 → 数据库 → 新建集合 `recipes`。
2. 在集合中「导入」→ 选择 JSON 文件，可使用 `data/recipeSchema.sample.json` 中的一条（需拆成单条文档格式，或使用控制台支持的 JSON 数组导入）。

## 4. 集合与权限

- **集合名**：`recipes`（大人与宝宝菜谱可同集合，用 `type: 'adult' | 'baby'` 区分；或拆成 `recipes` / `baby_recipes`）。
- **权限**：按需在云开发控制台设置「仅创建者可读写」或「所有用户可读」等。

初始化完成后，可在云开发控制台「数据库」中查看 `recipes` 集合及文档。

## 5. 菜谱封面图：语义化命名规范（半自动 AI 资产流水线）

为让代码自动拼出封面图地址、避免硬编码，约定云存储中图片按「菜名 → 拼音短横线」命名。

- **命名格式**：`{菜名对应 slug}.jpg`，小写、短横线分隔。示例：杭椒牛柳 → `hang-jiao-niu-liu.jpg`。
- **映射表**：`miniprogram/data/recipeCoverSlugs.js` 中的 `RECIPE_NAME_TO_SLUG`，与 `recipes.js` 的 `name` 一一对应。
- **代码用法**：`imgUrl = getRecipeCoverImageUrl(item.name)` 或 `getRecipeCoverImage(item.name)`，自动得到 `{BASE_URL}/{slug}.jpg`。
- **兜底**：未在表中配置的菜名使用 `basic_cut_0_3_ar4.5.jpeg`。
- **新增菜**：在 `recipeCoverSlugs.js` 的 `RECIPE_NAME_TO_SLUG` 增加一行「菜名 → slug」，上传同名 `.jpg` 到云存储即可。
- **本地图源**：大图源文件放在项目根目录 `recipe_photos_source/`（不打包进小程序，避免主包超 2MB）；运行时封面图从云存储加载。

## 6. 云端菜谱同步功能

小程序启动时会自动从云数据库同步菜谱，实现在线更新菜谱库。

### 6.1 工作原理

1. **启动时同步**：`app.js` 在 `onLaunch` 时初始化 `cloudRecipeService`，异步拉取云端菜谱
2. **本地缓存**：拉取的菜谱存储在 `localStorage`，下次启动时可快速加载
3. **增量更新**：基于 `updateTime` 字段，仅拉取有变化的菜谱
4. **离线兜底**：网络不可用时，使用本地 `recipes.js` 作为数据源

### 6.2 数据源优先级

```
云端缓存（内存） → 本地缓存（localStorage） → 本地 recipes.js
```

### 6.3 控制台操作

```js
// 查看同步状态
getApp().getCloudSyncState()

// 手动触发同步
getApp().syncCloudRecipes()

// 强制全量刷新
getApp().syncCloudRecipes({ forceRefresh: true })

// 清除本地缓存
getApp().clearRecipeCache()
```

### 6.4 在页面中使用

```js
var menuData = require('../../data/menuData.js');

// 获取数据源信息
var sourceInfo = menuData.getDataSourceInfo();
console.log('数据源:', sourceInfo.source); // 'cloud' 或 'local'
console.log('大人菜谱数:', sourceInfo.adultCount);
console.log('宝宝菜谱数:', sourceInfo.babyCount);

// 检查是否有云端数据
var hasCloud = menuData.hasCloudData();

// 手动触发同步
menuData.syncCloudRecipes().then(function(result) {
  console.log('同步完成', result);
});
```

### 6.5 云端菜谱字段规范

云端菜谱除了支持本地 `recipes.js` 的所有字段外，还支持以下字段：

| 字段 | 类型 | 说明 |
|------|------|------|
| `_id` | String | 云数据库自动生成的文档 ID |
| `updateTime` | Date | 更新时间，用于增量同步 |
| `createTime` | Date | 创建时间 |
| `main_ingredients` | Array | 主料列表（爱料理结构） |
| `seasonings` | Array | 调料列表（爱料理结构） |

**注意**：云端菜谱的 `main_ingredients` + `seasonings` 会自动合并为本地格式的 `ingredients`。

### 6.6 新增云端菜谱

1. 在云开发控制台 → 数据库 → `recipes` 集合
2. 添加新文档，参考 `data/recipeSchema.js` 中的字段规范
3. 必填字段：`id`、`name`、`type`（'adult' 或 'baby'）、`taste`、`meat`
4. 设置 `updateTime` 为当前时间，下次用户打开小程序时会自动同步

### 6.7 为什么真机（手机）上看不到云端菜谱？

可能原因与处理方式：

1. **缓存是按设备存的**  
   模拟器/开发者工具和手机是**不同设备**，Storage 互不共享。在电脑上同步过的云端菜谱不会自动出现在手机上，手机必须**自己**成功拉取并写入一次本地缓存。

2. **首次同步失败后之前不会重试**  
   之前逻辑是：只要执行过一次「首次全量同步」就把标记写入，下次启动不再强制全量刷新。若当时网络异常、云未开通或权限问题导致同步失败，手机会一直用本地精简版，看不到云端菜谱。  
   **已做修改**：只有同步**成功**（且拿到数据）后才写入该标记，真机首次同步失败时，下次冷启动会再次尝试全量同步。

3. **真机网络或云环境异常**  
   - 手机需能正常访问微信云开发（检查网络、VPN、公司网络是否限制）。  
   - 确认云开发环境已开通，且 `cloudInitRecipes.js` 里 `DEFAULT_ENV` 与云控制台环境一致。  
   - 若集合权限为「仅创建者可读写」，真机登录的微信账号需与创建该环境的账号一致（开发者账号一致时一般没问题）。

4. **建议操作（真机想看云端菜谱时）**  
   - 保证手机联网，完全关闭小程序后重新打开，等待几秒让同步跑完再操作。  
   - **不依赖 vConsole**：在首页**长按底部「TableSync」**，会触发强制同步并在弹窗中显示：本次从云端拉取条数、当前合计、是否来自云端，或错误信息。  
   - 若弹窗显示「本次从云端拉取: 大人 0 条 宝宝 0 条」且「未从云端拉取」，说明同步未报错但云端未返回数据，请检查：云开发控制台 → 数据库 → recipes 集合是否有 type 为 adult/baby 的文档、环境 ID 是否与 `cloudInitRecipes.js` 中一致。  
   - 若需在控制台执行：真机调试时打开 vConsole，执行 `getApp().syncCloudRecipes({ forceRefresh: true })`，再执行 `getApp().getCloudSyncState()` 查看是否有 `error`。  
   - 若仍无数据，在云开发控制台查看「数据库 → recipes 集合」是否有 type 为 adult/baby 的文档。

### 6.8 为什么有些菜谱（如拍黄瓜）没有做菜步骤？

**结论：是正常现象。** 做菜步骤（及完整食材）依赖「完整版菜谱」，而本地 `data/recipes.js` 是**精简版**。

- **本地 recipes.js**（由 `tools/slim-recipes.js` 生成）：只保留菜单生成算法需要的字段（id、name、meat、taste、cook_minutes 等），**不含** `steps`、完整 `ingredients`、`baby_variant` 等。文件头注释已说明：「完整数据从云端获取；离线时此文件支持算法运行，但无法显示步骤和购物清单。」
- **步骤从哪里来**：取菜谱时优先用「云端同步后的缓存」；若云端有该菜的完整文档（含 `steps` 数组），则会显示步骤；若云端没有该菜或文档里没有 `steps`，则回退到本地精简版，**没有步骤**。
- **拍黄瓜**：在本地精简版里只有一条记录（id: `a-veg-4`），没有 `steps`。若云数据库里还没有上传过「拍黄瓜」的完整版（含 steps），或用户尚未同步到，步骤就会显示为「需联网获取」或缺失。
- **如何让某道菜显示步骤**：
  1. 在云开发控制台 → 数据库 → `recipes` 集合中，确保存在该菜谱的文档（`id` 与本地一致，如 `a-veg-4`），且文档内包含 `steps` 数组。
  2. 用户端：打开小程序并保持联网，启动时会自动同步；或调用 `getApp().syncCloudRecipes({ forceRefresh: true })` 强制全量刷新后再进入做饭步骤页。

### 6.9 相关文件

| 文件 | 说明 |
|------|------|
| `utils/cloudRecipeService.js` | 云端菜谱同步服务核心 |
| `utils/cloudInitRecipes.js` | 云开发初始化与数据库导入 |
| `data/menuGenerator.js` | 菜单生成逻辑（支持云端数据源） |
| `data/menuData.js` | 对外统一接口（支持云端数据源） |
