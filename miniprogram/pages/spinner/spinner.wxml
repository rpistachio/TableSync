<wxs src="./spinner.wxs" module="utils" />
<view class="spinner-page">
  <!-- ä¸Šä¸‹æ–‡æ‘˜è¦æ¡ -->
  <view class="context-bar">
    <text class="context-text">{{contextSummary}}</text>
  </view>

  <!-- å¿ƒæƒ…è¾“å…¥åŒº -->
  <view class="mood-section">
    <text class="mood-label">ä»Šæ—¥å¿ƒæƒ…</text>
    <view class="mood-cards">
      <view
        wx:for="{{moodOptions}}"
        wx:key="value"
        class="mood-card {{selectedMood === item.value ? 'is-active' : ''}}"
        data-value="{{item.value}}"
        bindtap="onMoodTap"
      >
        <text class="mood-emoji">{{item.emoji}}</text>
        <text class="mood-text">{{item.label}}</text>
      </view>
    </view>
    <view class="mood-custom-wrap">
      <input
        class="mood-custom-input"
        placeholder="è¯´ç‚¹åˆ«çš„..."
        value="{{moodCustom}}"
        bindinput="onMoodCustomInput"
      />
    </view>
  </view>

  <!-- æŠ˜å å¼åå¥½é…ç½® -->
  <view class="pref-section-wrap">
    <view class="pref-header-row" bindtap="onTogglePrefPanel">
      <text class="pref-header-text">åå¥½é…ç½®</text>
      <text class="pref-header-arrow {{prefPanelExpanded ? 'is-expanded' : ''}}">â–¾</text>
    </view>
    <view class="pref-body {{prefPanelExpanded ? 'is-expanded' : ''}}">
      <view class="selection-group">
        <text class="group-label">å®¶åº­æˆå‘˜</text>
        <view class="people-picker">
          <view
            wx:for="{{adultCountOptions}}"
            wx:key="*this"
            class="people-item {{adultCount >= item ? 'is-lit' : ''}}"
            data-count="{{item}}"
            bindtap="onAdultCountTap"
          >
            <text class="people-icon">ğŸ‘¤</text>
          </view>
        </view>
        <text class="people-count-label">{{adultCount}} äºº</text>
      </view>
      <view class="selection-group">
        <text class="group-label">è¤ç´ æ­é…</text>
        <view class="combo-stack">
          <view wx:for="{{comboOptions}}" wx:key="label" class="combo-btn {{item.meatCount === meatCount && item.vegCount === vegCount ? 'is-active' : ''}}" data-meat="{{item.meatCount}}" data-veg="{{item.vegCount}}" bindtap="onComboTap">
            <text class="combo-text">{{item.label}}</text>
            <text wx:if="{{item.tag && (item.tag !== 'å®å®é€‚é…' || hasBaby)}}" class="combo-tag">{{item.tag}}</text>
          </view>
        </view>
        <view class="nutrition-tip" wx:if="{{nutritionTip}}">
          <text class="nutrition-tip-icon">ğŸ¥—</text>
          <text class="nutrition-tip-text">{{nutritionTip}}</text>
        </view>
      </view>
      <view class="selection-group custom-taste-header">
        <text class="group-label">å®šåˆ¶å£å‘³</text>
      </view>
      <view class="capsule-bar">
        <view class="capsule-item {{expandedPanel === 'soup' ? 'is-expanded' : ''}} {{wantSoup ? 'has-value' : ''}}" data-panel="soup" bindtap="onCapsuleTap">
          <text class="capsule-text">{{soupCapsuleText}}</text>
          <text class="capsule-arrow {{expandedPanel === 'soup' ? 'is-up' : ''}}">â–¾</text>
        </view>
        <view class="capsule-item {{expandedPanel === 'baby' ? 'is-expanded' : ''}} {{hasBaby ? 'has-value' : ''}}" data-panel="baby" bindtap="onCapsuleTap">
          <text class="capsule-text">{{babyCapsuleText}}</text>
          <text class="capsule-arrow {{expandedPanel === 'baby' ? 'is-up' : ''}}">â–¾</text>
        </view>
        <view class="capsule-item {{expandedPanel === 'pref' ? 'is-expanded' : ''}} {{prefHasValue ? 'has-value' : ''}}" data-panel="pref" bindtap="onCapsuleTap">
          <text class="capsule-text">{{prefCapsuleText}}</text>
          <text class="capsule-arrow {{expandedPanel === 'pref' ? 'is-up' : ''}}">â–¾</text>
        </view>
        <view class="capsule-item {{expandedPanel === 'diet' ? 'is-expanded' : ''}} {{dietHasValue ? 'has-value' : ''}}" data-panel="diet" bindtap="onCapsuleTap">
          <text class="capsule-text">{{dietCapsuleText}}</text>
          <text class="capsule-arrow {{expandedPanel === 'diet' ? 'is-up' : ''}}">â–¾</text>
        </view>
      </view>
      <view class="dropdown-panel {{expandedPanel === 'soup' ? 'is-open' : ''}}">
        <view class="dropdown-inner soup-option-row">
          <view class="soup-option-btn {{wantSoup && soupType === 'meat' ? 'is-active' : ''}}" data-option="meat" bindtap="onSoupOptionTap">
            <text>è¤æ±¤</text>
          </view>
          <view class="soup-option-btn {{wantSoup && soupType === 'veg' ? 'is-active' : ''}}" data-option="veg" bindtap="onSoupOptionTap">
            <text>ç´ æ±¤</text>
          </view>
          <view class="soup-option-btn {{!wantSoup ? 'is-active' : ''}}" data-option="none" bindtap="onSoupOptionTap">
            <text>ä¸è¦æ±¤</text>
          </view>
        </view>
      </view>
      <view class="dropdown-panel {{expandedPanel === 'baby' ? 'is-open' : ''}}">
        <view class="dropdown-inner">
          <view class="baby-age-stack">
            <view wx:for="{{babyAgeOptions}}" wx:key="value" class="baby-age-card {{hasBaby && item.value === babyMonth ? 'is-active' : ''}}" data-value="{{item.value}}" bindtap="onBabyAgeTap">
              <text class="baby-age-card-label">{{item.label}}</text>
              <text class="baby-age-card-sub">{{item.sub}}</text>
            </view>
          </view>
          <view class="baby-none-btn {{!hasBaby ? 'is-active' : ''}}" bindtap="onBabyNoneTap">
            <text>ä¸éœ€è¦</text>
          </view>
        </view>
      </view>
      <view class="dropdown-panel {{expandedPanel === 'pref' ? 'is-open' : ''}}">
        <view class="dropdown-inner">
          <view class="pref-tag-group">
            <view wx:for="{{avoidOptions}}" wx:key="value" class="pref-tag {{utils.includes(userPreference.avoidList, item.value) ? 'is-selected' : ''}}" data-value="{{item.value}}" bindtap="onAvoidTap">
              <text>{{item.label}}</text>
            </view>
          </view>
        </view>
      </view>
      <view class="dropdown-panel {{expandedPanel === 'diet' ? 'is-open' : ''}}">
        <view class="dropdown-inner">
          <view class="pref-tag-group">
            <view wx:for="{{dietOptions}}" wx:key="value" class="pref-tag {{userPreference.dietStyle === item.value ? 'is-selected' : ''}}" data-value="{{item.value}}" bindtap="onDietTap">
              <text>{{item.label}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- å¼€å§‹ç”ŸæˆæŒ‰é’® -->
  <view class="cta-wrap" wx:if="{{!hasMenusForWheel}}">
    <button class="premium-btn" bindtap="onStartGenerate">å¼€å§‹ç”Ÿæˆ</button>
  </view>

  <!-- è½¬ç›˜åŒºåŸŸ -->
  <view class="spinner-container {{hasMenusForWheel ? 'has-wheel' : ''}}">
    <block wx:if="{{hasMenusForWheel && outerDishes.length > 0}}">
      <view class="center-logo {{spinning ? 'spinning' : ''}}" bindtap="startSpin">
        <image
          class="logo-image"
          src="cloud://cloud1-7g5mdmib90e9f670.636c-cloud1-7g5mdmib90e9f670-1401654193/logo/logo-remove-removebg-preview.png"
          mode="aspectFit"
        />
        <text class="start-hint" wx:if="{{!spinning && !stopped}}">ç‚¹å‡»å¼€å§‹</text>
      </view>
      <view class="wheel-ring outer-ring" style="transform: rotate({{outerRotation}}deg);">
        <view wx:for="{{outerDishes}}" wx:key="index" class="wheel-sector {{index === outerTarget ? 'target-sector' : ''}}" style="transform: rotate({{index * 45}}deg);">
          <text class="sector-text">{{item}}</text>
        </view>
      </view>
      <view class="wheel-ring middle-ring" style="transform: rotate({{middleRotation}}deg);">
        <view wx:for="{{middleDishes}}" wx:key="index" class="wheel-sector {{index === middleTarget ? 'target-sector' : ''}}" style="transform: rotate({{index * 45}}deg);">
          <text class="sector-text">{{item}}</text>
        </view>
      </view>
      <view class="wheel-ring inner-ring" style="transform: rotate({{innerRotation}}deg);">
        <view wx:for="{{innerDishes}}" wx:key="index" class="wheel-sector {{index === innerTarget ? 'target-sector' : ''}}" style="transform: rotate({{index * 45}}deg);">
          <text class="sector-text">{{item}}</text>
        </view>
      </view>
      <view class="indicator-arrow"></view>
    </block>
    <view class="wheel-placeholder" wx:else>
      <text class="wheel-placeholder-text">é…ç½®åå¥½åç‚¹å‡»ã€Œå¼€å§‹ç”Ÿæˆã€</text>
    </view>
  </view>
</view>
