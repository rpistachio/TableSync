<wxs src="./spinner.wxs" module="utils" />
<view class="spinner-page">
  <view wx:if="{{isZenMode}}" class="zen-loading">
    <text class="zen-loading-text">æ­£åœ¨ç”Ÿæˆä»Šæ™šèœå•...</text>
  </view>

  <block wx:if="{{!isZenMode}}">
    <!-- ä¸Šä¸‹æ–‡æ‘˜è¦æ¡ï¼šå¤©æ°”+æ—¶æ®µé»˜è®¤å»ºè®®ï¼ˆæ— æ‰‹åŠ¨å¿ƒæƒ…é€‰æ‹©ï¼‰ -->
    <view class="context-bar">
      <text class="context-text">{{contextSummary}}</text>
    </view>

  <!-- çµæ„Ÿç¯®å­ä¼˜å…ˆç­–ç•¥ï¼ˆç¯®å­éç©ºæ—¶æ˜¾ç¤ºï¼‰ -->
  <view class="priority-section" wx:if="{{basketCount > 0}}">
    <text class="priority-label">ä¼˜å…ˆè€ƒè™‘</text>
    <view class="priority-switches">
      <view class="priority-item {{priorityImported ? 'is-active' : ''}}" bindtap="onTogglePriorityImported">
        <text class="priority-item-icon">ğŸ“•</text>
        <text class="priority-item-text">æˆ‘ä¿å­˜çš„èœè°±</text>
        <text class="priority-count">{{importedBasketCount}}</text>
      </view>
      <view class="priority-item {{priorityFridge ? 'is-active' : ''}}" bindtap="onTogglePriorityFridge">
        <text class="priority-item-icon">ğŸ§Š</text>
        <text class="priority-item-text">æ¶ˆè€—å†°ç®±é£Ÿæ</text>
        <text class="priority-count">{{fridgeBasketCount}}</text>
      </view>
    </view>
  </view>

  <!-- Phase Cï¼šæœ€è¿‘å¸¸åšï¼Œä¸€é”®åŠ å…¥çµæ„Ÿç¯® -->
  <view class="history-quick-bar" wx:if="{{historyQuickList.length > 0}}" bindtap="onAddHistoryQuick">
    <text class="history-quick-label">æœ€è¿‘å¸¸åš</text>
    <text class="history-quick-names">{{historyQuickList[0].name}}{{historyQuickList[1] ? 'ã€' + historyQuickList[1].name : ''}}{{historyQuickList[2] ? 'ã€' + historyQuickList[2].name : ''}}</text>
    <text class="history-quick-cta">åŠ å…¥çµæ„Ÿç¯®</text>
    <text class="history-quick-arrow">â€º</text>
  </view>

  <!-- æŠ˜å å¼åå¥½é…ç½® -->
  <view class="pref-section-wrap">
    <view class="pref-header-row" bindtap="onTogglePrefPanel">
      <text class="pref-header-text">åå¥½é…ç½®</text>
      <text class="pref-header-arrow {{prefPanelExpanded ? 'is-expanded' : ''}}">â–¾</text>
    </view>
    <view class="pref-body {{prefPanelExpanded ? 'is-expanded' : ''}}">
      <view class="selection-group">
        <text class="group-label">å®¶åº­æˆå‘˜</text>
        <view class="people-picker">
          <view
            wx:for="{{adultCountOptions}}"
            wx:key="*this"
            class="people-item {{adultCount >= item ? 'is-lit' : ''}}"
            data-count="{{item}}"
            bindtap="onAdultCountTap"
          >
            <text class="people-icon">ğŸ‘¤</text>
          </view>
        </view>
        <text class="people-count-label">{{adultCount}} äºº</text>
      </view>
      <view class="selection-group">
        <text class="group-label">è¤ç´ æ­é…</text>
        <view class="combo-stack">
          <view wx:for="{{comboOptions}}" wx:key="label" class="combo-btn {{item.meatCount === meatCount && item.vegCount === vegCount ? 'is-active' : ''}}" data-meat="{{item.meatCount}}" data-veg="{{item.vegCount}}" bindtap="onComboTap">
            <text class="combo-text">{{item.label}}</text>
            <text wx:if="{{item.tag && (item.tag !== 'å®å®é€‚é…' || hasBaby)}}" class="combo-tag">{{item.tag}}</text>
          </view>
        </view>
        <view class="nutrition-tip" wx:if="{{nutritionTip}}">
          <text class="nutrition-tip-icon">ğŸ¥—</text>
          <text class="nutrition-tip-text">{{nutritionTip}}</text>
        </view>
      </view>
      <view class="selection-group custom-taste-header">
        <text class="group-label">å®šåˆ¶å£å‘³</text>
      </view>
      <view class="capsule-bar">
        <view class="capsule-item {{expandedPanel === 'soup' ? 'is-expanded' : ''}} {{wantSoup ? 'has-value' : ''}}" data-panel="soup" bindtap="onCapsuleTap">
          <text class="capsule-text">{{soupCapsuleText}}</text>
          <text class="capsule-arrow {{expandedPanel === 'soup' ? 'is-up' : ''}}">â–¾</text>
        </view>
        <view class="capsule-item {{expandedPanel === 'baby' ? 'is-expanded' : ''}} {{hasBaby ? 'has-value' : ''}}" data-panel="baby" bindtap="onCapsuleTap">
          <text class="capsule-text">{{babyCapsuleText}}</text>
          <text class="capsule-arrow {{expandedPanel === 'baby' ? 'is-up' : ''}}">â–¾</text>
        </view>
        <view class="capsule-item {{expandedPanel === 'pref' ? 'is-expanded' : ''}} {{prefHasValue ? 'has-value' : ''}}" data-panel="pref" bindtap="onCapsuleTap">
          <text class="capsule-text">{{prefCapsuleText}}</text>
          <text class="capsule-arrow {{expandedPanel === 'pref' ? 'is-up' : ''}}">â–¾</text>
        </view>
        <view class="capsule-item {{expandedPanel === 'diet' ? 'is-expanded' : ''}} {{dietHasValue ? 'has-value' : ''}}" data-panel="diet" bindtap="onCapsuleTap">
          <text class="capsule-text">{{dietCapsuleText}}</text>
          <text class="capsule-arrow {{expandedPanel === 'diet' ? 'is-up' : ''}}">â–¾</text>
        </view>
      </view>
      <view class="dropdown-panel {{expandedPanel === 'soup' ? 'is-open' : ''}}">
        <view class="dropdown-inner soup-option-row">
          <view class="soup-option-btn {{wantSoup && soupType === 'meat' ? 'is-active' : ''}}" data-option="meat" bindtap="onSoupOptionTap">
            <text>è¤æ±¤</text>
          </view>
          <view class="soup-option-btn {{wantSoup && soupType === 'veg' ? 'is-active' : ''}}" data-option="veg" bindtap="onSoupOptionTap">
            <text>ç´ æ±¤</text>
          </view>
          <view class="soup-option-btn {{!wantSoup ? 'is-active' : ''}}" data-option="none" bindtap="onSoupOptionTap">
            <text>ä¸è¦æ±¤</text>
          </view>
        </view>
      </view>
      <view class="dropdown-panel {{expandedPanel === 'baby' ? 'is-open' : ''}}">
        <view class="dropdown-inner">
          <view class="baby-age-stack">
            <view wx:for="{{babyAgeOptions}}" wx:key="value" class="baby-age-card {{hasBaby && item.value === babyMonth ? 'is-active' : ''}}" data-value="{{item.value}}" bindtap="onBabyAgeTap">
              <text class="baby-age-card-label">{{item.label}}</text>
              <text class="baby-age-card-sub">{{item.sub}}</text>
            </view>
          </view>
          <view class="baby-none-btn {{!hasBaby ? 'is-active' : ''}}" bindtap="onBabyNoneTap">
            <text>ä¸éœ€è¦</text>
          </view>
        </view>
      </view>
      <view class="dropdown-panel {{expandedPanel === 'pref' ? 'is-open' : ''}}">
        <view class="dropdown-inner">
          <view class="pref-tag-group">
            <view wx:for="{{avoidOptions}}" wx:key="value" class="pref-tag {{utils.includes(userPreference.avoidList, item.value) ? 'is-selected' : ''}}" data-value="{{item.value}}" bindtap="onAvoidTap">
              <text>{{item.label}}</text>
            </view>
          </view>
        </view>
      </view>
      <view class="dropdown-panel {{expandedPanel === 'diet' ? 'is-open' : ''}}">
        <view class="dropdown-inner">
          <view class="pref-tag-group">
            <view wx:for="{{dietOptions}}" wx:key="value" class="pref-tag {{userPreference.dietStyle === item.value ? 'is-selected' : ''}}" data-value="{{item.value}}" bindtap="onDietTap">
              <text>{{item.label}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- å¼€å§‹ç”ŸæˆæŒ‰é’® -->
  <view class="cta-wrap" wx:if="{{!isGenerating}}">
    <button class="premium-btn" bindtap="onStartGenerate">å¼€å§‹ç”Ÿæˆ</button>
  </view>

  <!-- ç”Ÿæˆä¸­çŠ¶æ€ (Kitchen Story é£æ ¼: å±…ä¸­æ–‡æ¡ˆ + å¾®åŠ¨ç”») -->
  <view class="generating-state" wx:if="{{isGenerating}}">
    <view class="generating-dot-wrap">
      <view class="generating-dot"></view>
      <view class="generating-dot"></view>
      <view class="generating-dot"></view>
    </view>
    <text class="generating-text">æ­£åœ¨ä¸ºæ‚¨æŒ‘é€‰...</text>
  </view>
  </block>
</view>
