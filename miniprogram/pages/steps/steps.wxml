<view class="steps-container cook-mode {{isAyiMode ? 'ayi-mode' : ''}} {{isHelperRole ? 'helper-role' : ''}}">
  <!-- 执行者模式：顶部唯一标题 + 可折叠食材准备 -->
  <view wx:if="{{isHelperRole && helperTitle}}" class="helper-role-header">
    <text class="helper-role-title">{{helperTitle}}</text>
    <view wx:if="{{helperIngredientsList.length > 0}}" class="helper-ingredients-panel">
      <view class="helper-ingredients-head" bindtap="toggleHelperIngredients">
        <text class="helper-ingredients-label">食材准备</text>
        <text class="helper-ingredients-toggle">{{helperIngredientsExpanded ? '收起' : '展开'}}</text>
      </view>
      <view wx:if="{{helperIngredientsExpanded}}" class="helper-ingredients-list">
        <view wx:for="{{helperIngredientsList}}" wx:key="name" class="helper-ingredient-item">
          <text class="helper-ingredient-name">{{item.name}}</text>
          <text class="helper-ingredient-amount">{{item.amount}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- Layer 1: 极简头部 -->
  <view class="cook-header">
    <view class="progress-bar-track">
      <view class="progress-bar-fill" style="{{progressBarStyle}}"></view>
    </view>
    <view class="header-info">
      <text class="step-counter">{{currentStepIndexDisplay}}/{{totalSteps}}</text>
      <text class="current-dish-name">{{currentStepSubtitle}}</text>
    </view>
    <scroll-view wx:if="{{!isAyiMode && rhythmRings.length > 0}}" class="rhythm-ring-row" scroll-x enable-flex enhanced show-scrollbar="{{false}}">
      <view
        wx:for="{{rhythmRings}}"
        wx:key="name"
        class="rhythm-ring accent-{{index % 6}} {{item.isActive ? 'is-active' : ''}} {{item.isPulsing ? 'is-pulsing' : ''}}"
        style="{{item.ringStyle}}"
      >
        <view class="ring-inner">
          <text class="ring-percent">{{item.percent}}%</text>
          <text class="ring-label">{{item.name}}</text>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- Layer 2: 浮动并行状态条 -->
  <view wx:if="{{!isAyiMode && activeParallelTasks.length > 0}}" class="parallel-float-bar" bindtap="toggleGanttSheet">
    <scroll-view scroll-x class="parallel-scroll" enhanced show-scrollbar="{{false}}">
      <view class="parallel-chip-row">
        <view wx:for="{{activeParallelTasks}}" wx:key="stepId" class="parallel-chip">
          <text class="chip-dot"></text>
          <text class="chip-name">{{item.activeTaskName}}</text>
          <text class="chip-time">{{item.remainingMinutes}}'</text>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- Layer 3: 聚焦步骤区 -->
  <view class="focus-area">
    <!-- 上一步摘要 -->
    <view wx:if="{{prevStep}}" class="step-peek prev" bindtap="goPrevStep">
      <text class="peek-check">✓</text>
      <text class="peek-text">{{prevStep.title}}</text>
    </view>

    <!-- 当前步骤聚焦卡 -->
    <view class="focus-card {{currentStep.completed ? 'is-done' : ''}}">
      <!-- 阶段纤细标签 -->
      <text wx:if="{{!isAyiMode && currentPhaseLabel}}" class="phase-chip {{currentPhaseType}}">{{currentPhaseLabel}}</text>
      <!-- 疲惫模式：空气炸锅步骤设备标识 -->
      <view wx:if="{{isTiredMode && currentStepDevice === 'air_fryer'}}" class="device-chip device-chip-airfryer">空气炸锅</view>

      <!-- 步骤标题 -->
      <text class="focus-title">{{currentStep.title}}</text>

      <!-- 次动作提示 -->
      <view wx:if="{{!isAyiMode && secondaryHint}}" class="focus-secondary">
        <text class="secondary-label">并行节拍</text>
        <text class="secondary-text">{{secondaryHint}}</text>
      </view>

      <!-- 并行提示（内联） -->
      <view wx:if="{{currentStep.parallelContext}}" class="focus-parallel-hint">
        <text class="parallel-hint-text">{{currentStep.parallelContext.hint}}</text>
        <text wx:if="{{currentStep.parallelContext.remainingMinutes != null}}" class="parallel-hint-timer">
          {{currentStep.parallelContext.remainingMinutes}}'
        </text>
      </view>

      <!-- 指令正文 -->
      <view class="focus-body">
        <view
          wx:for="{{currentStep.details}}"
          wx:for-item="line"
          wx:key="index"
          class="focus-line {{line.isBabyPortion ? 'baby-portion-action' : ''}}"
        >
          <rich-text class="focus-line-text" nodes="{{line.richText}}"></rich-text>
        </view>
      </view>

      <!-- 调料横滚 -->
      <view wx:if="{{currentStep.showSeasoningsList}}" class="focus-seasonings">
        <scroll-view class="seasoning-scroll" scroll-x enhanced show-scrollbar="{{false}}">
          <view class="seasoning-row">
            <view wx:for="{{currentStep.seasoningsList}}" wx:for-item="ing" wx:key="name" class="ing-tag">
              <text class="n">{{ing.name}}</text>
              <text class="a">{{ing.amount}}</text>
            </view>
          </view>
        </scroll-view>
      </view>

      <!-- 时长提示 -->
      <view wx:if="{{!isAyiMode && currentStep.duration}}" class="focus-duration">
        <text class="duration-icon">⏱</text>
        <text class="duration-text">约 {{currentStep.duration}} 分钟</text>
      </view>

      <!-- 云端步骤缺失时：重新加载入口与错误提示 -->
      <view wx:if="{{showOfflineHint}}" class="offline-reload-area">
        <button wx:if="{{!stepsReloading}}" class="offline-reload-btn" type="plain" catchtap="retryLoadStepsFromCloud">重新加载步骤</button>
        <view wx:if="{{stepsReloading}}" class="offline-reload-loading">正在从云端加载…</view>
        <text wx:if="{{stepsSyncError}}" class="offline-reload-error">{{stepsSyncError}}</text>
      </view>
    </view>

    <!-- 下一步预览 -->
    <view wx:if="{{nextStep}}" class="step-peek next" bindtap="goNextStep">
      <text class="peek-label">下一步</text>
      <text class="peek-text">{{nextStep.title}}</text>
    </view>
  </view>

  <!-- 底部流水线预览 -->
  <view wx:if="{{!isAyiMode && pipelineSteps.length > 0}}" class="pipeline-preview">
    <view class="pipeline-header">
      <text class="pipeline-title">流水线预览</text>
      <text class="pipeline-sub">{{completedCount}}/{{totalSteps}} 已完成</text>
    </view>
    <scroll-view scroll-x class="pipeline-scroll" enhanced show-scrollbar="{{false}}">
      <view class="pipeline-row">
        <view
          wx:for="{{pipelineSteps}}"
          wx:key="id"
          class="pipeline-block {{item.isCompleted ? 'is-completed' : ''}} {{item.isCurrent ? 'is-current' : ''}}"
        >
          <text class="pipeline-label">{{item.shortTitle}}</text>
          <view wx:if="{{item.isCompleted}}" class="pipeline-sticker">完成</view>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- 底部操作栏 -->
  <view class="bottom-action-bar">
    <view class="action-prev {{!prevStep ? 'disabled' : ''}}" bindtap="goPrevStep">
      <text class="action-prev-text">上一步</text>
    </view>
    <button
      class="action-main {{currentStep.completed ? 'is-done' : ''}}"
      catchtap="markCurrentCompleted"
    >
      <text class="action-main-text">{{isAyiMode ? '做好了，下一步' : (currentStep.completed ? '✓ 已完成' : '完成此步')}}</text>
    </button>
    <view class="action-list" bindtap="toggleStepList">
      <text class="action-list-icon">☰</text>
    </view>
  </view>

  <!-- 步骤列表 Bottom Sheet -->
  <view wx:if="{{showStepList}}" class="sheet-mask" bindtap="toggleStepList"></view>
  <view class="bottom-sheet {{showStepList ? 'is-open' : ''}}">
    <view class="sheet-header">
      <text class="sheet-title">全部步骤</text>
      <text class="sheet-close" bindtap="toggleStepList">收起</text>
    </view>
    <scroll-view scroll-y class="sheet-scroll">
      <view
        wx:for="{{allViewSteps}}"
        wx:key="id"
        class="sheet-step-item {{item.completed ? 'is-completed' : ''}} {{index === currentIndex ? 'is-current' : ''}}"
        bindtap="onJumpToStep"
        data-index="{{index}}"
      >
        <view class="sheet-step-check">
          <text class="sheet-check-icon">{{item.completed ? '✓' : (index + 1)}}</text>
        </view>
        <view class="sheet-step-info">
          <text class="sheet-step-title">{{item.title}}</text>
          <text wx:if="{{item.duration}}" class="sheet-step-meta">{{item.duration}}'</text>
        </view>
      </view>
    </scroll-view>
    <view class="sheet-footer" wx:if="{{!isHelperRole}}">
      <button class="sheet-share-btn" open-type="share">分享今日菜单</button>
    </view>
  </view>

  <!-- 甘特图 Bottom Sheet -->
  <view wx:if="{{!isAyiMode && showGanttSheet}}" class="sheet-mask" bindtap="toggleGanttSheet"></view>
  <view wx:if="{{!isAyiMode}}" class="bottom-sheet gantt-sheet {{showGanttSheet ? 'is-open' : ''}}">
    <view class="sheet-header">
      <text class="sheet-title">厨房统筹总览</text>
      <text class="sheet-close" bindtap="toggleGanttSheet">收起</text>
    </view>
    <scroll-view scroll-y class="sheet-scroll">
      <view wx:if="{{activeParallelTasks.length > 0}}" class="gantt-section">
        <view wx:for="{{activeParallelTasks}}" wx:key="stepId" class="gantt-task-row">
          <text class="gantt-task-name">{{item.activeTaskName}}</text>
          <view class="gantt-bar-track">
            <view class="gantt-bar-fill" style="{{item.barWidthStyle}}"></view>
          </view>
          <text class="gantt-task-time">{{item.remainingMinutes}}'</text>
        </view>
      </view>
      <view wx:if="{{activeParallelTasks.length === 0}}" class="gantt-empty">
        <text class="gantt-empty-text">当前没有并行进行的任务</text>
      </view>
    </scroll-view>
  </view>

  <!-- 贴纸即时掉落 -->
  <sticker-drop
    visible="{{showStickerDrop}}"
    queue="{{stickerDropQueue}}"
    bindclose="onStickerDropClose"
  />
</view>
