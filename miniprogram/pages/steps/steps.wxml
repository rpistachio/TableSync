<view class="steps-container">
  <view class="steps-header">
    <image wx:if="{{currentStepImage}}" class="header-ambient-bg" src="{{currentStepImage}}" mode="aspectFill" />
    <view class="header-mask"></view>
    
    <view class="header-content">
      <view class="hero-section">
        <view class="progress-visual">
          <view class="progress-ring" style="background: conic-gradient(#E8A87C {{progressPercentage}}%, rgba(255,255,255,0.2) 0%)"></view>
          <image wx:if="{{currentStepImage}}" class="dish-mini-img" src="{{currentStepImage}}" mode="aspectFill" />
        </view>
        
        <view class="step-info">
          <text class="progress-text">{{progressPercentage}}% · {{completedCount}}/{{totalSteps}} 步</text>
          <text class="step-main-title">{{currentStepTitle}}</text>
          <text class="step-sub-title">{{currentStepSubtitle}}</text>
        </view>
      </view>
    </view>
  </view>

  <view class="page-content">
    <view class="timeline-container">
      <view
        wx:for="{{steps}}"
        wx:key="id"
        class="timeline-item {{item.stepType}} {{item.completed ? 'completed' : ''}} {{index === (steps.length - 1) ? 'is-last' : ''}} {{index === currentIndex ? 'active' : ''}}"
        id="step-{{item.id}}"
        bindtap="onStepTap"
        data-index="{{index}}"
      >
        <!-- 阶段横幅（支持文案配置） -->
        <view wx:if="{{item.isPhaseStart}}" class="phase-banner {{item.phaseType}}">
          <view class="phase-banner-main">
            <view class="phase-icon"></view>
            <view class="phase-texts">
              <text class="phase-title">{{item.phaseTitle}}</text>
              <text wx:if="{{item.phaseSubtitle}}" class="phase-subtitle">{{item.phaseSubtitle}}</text>
            </view>
          </view>
        </view>

        <!-- 左侧时间轴线 -->
        <view class="timeline-rail">
          <view class="timeline-dot {{item.stepType === 'prep' ? 'dot-knife' : 'dot-fire'}}"></view>
          <view class="timeline-line {{item.stepType === 'prep' ? 'line-dashed' : 'line-solid'}}"></view>
          <!-- 宝宝分支 -->
          <view class="baby-branch" wx:if="{{item.roleTag === '宝宝餐'}}">
            <view class="baby-dot"></view>
          </view>
        </view>

        <!-- 右侧步骤卡片 -->
        <view class="timeline-content">
          <view class="step-card {{item.completed ? 'completed' : ''}} {{index === (steps.length - 1) ? 'is-last' : ''}}">
            <view class="step-card__header">
              <view class="step-card__title-row">
                <text class="step-card__title">{{item.title}}</text>
                <view class="tag-group">
                  <text wx:if="{{item.roleTag === '成人餐'}}" class="mini-badge adult">大人</text>
                  <text wx:if="{{item.roleTag === '宝宝餐'}}" class="mini-badge baby">宝宝</text>
                  <block wx:if="{{item.roleTag === '成人+宝宝'}}">
                    <text class="mini-badge adult">大人</text>
                    <text class="mini-badge baby">宝宝</text>
                  </block>
                  <text wx:if="{{item.knifeWorkLabel}}" class="mini-badge knife">{{item.knifeWorkLabel}}</text>
                </view>
              </view>
              <view wx:if="{{item.duration != null}}" class="step-card__meta-mini">
                <text class="meta-time">{{item.duration}}'</text>
              </view>
            </view>

            <view class="step-card__body">
              <!-- 并行上下文提示 -->
              <view wx:if="{{item.parallelContext}}" class="context-pill">
                <text class="pill-text">{{item.parallelContext.hint}}</text>
                <text wx:if="{{item.parallelContext.remainingMinutes != null}}" class="pill-timer">
                  {{item.parallelContext.remainingMinutes}}'
                </text>
              </view>

              <view class="step-details condensed">
                <view
                  wx:for="{{item.details}}"
                  wx:for-item="line"
                  wx:key="index"
                  class="detail-line {{line.isBabyPortion ? 'baby-portion-action' : ''}}"
                >
                  <!-- 使用 rich-text 渲染 HTML，彻底避免嵌套 text 导致动词孤立成行 -->
                  <rich-text class="detail-line-text" nodes="{{line.richText}}"></rich-text>
                </view>
              </view>

              <view wx:if="{{item.showSeasoningsList}}" class="seasoning-inline">
                <scroll-view class="seasoning-scroll" scroll-x="true" show-scrollbar="false">
                  <view class="seasoning-row">
                    <view wx:for="{{item.seasoningsList}}" wx:for-item="ing" wx:key="name" class="ing-tag">
                      <text class="n">{{ing.name}}</text>
                      <text class="a">{{ing.amount}}</text>
                    </view>
                  </view>
                </scroll-view>
              </view>

              <button
                class="step-action-btn {{item.completed ? 'is-done' : ''}}"
                catchtap="markCompleted"
                data-id="{{item.id}}"
              >
                {{item.completed ? '已达成' : '完成'}}
              </button>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <view class="share-footer">
    <button class="share-btn" open-type="share">分享今日菜单</button>
  </view>
</view>