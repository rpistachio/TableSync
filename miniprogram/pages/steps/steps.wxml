<view class="steps-container">
  <view class="steps-header">
    <image wx:if="{{currentStepImage && currentStepImage.length > 0}}" class="header-ambient-bg" src="{{currentStepImage}}" mode="aspectFill" />
    <view class="header-mask"></view>
    
    <view class="header-content">
      <view class="hero-section">
        <view class="progress-visual">
          <view class="progress-ring" style="background: conic-gradient(#E8A87C {{progressPercentage}}%, rgba(255,255,255,0.2) 0%)"></view>
          <image wx:if="{{currentStepImage && currentStepImage.length > 0}}" class="dish-mini-img" src="{{currentStepImage}}" mode="aspectFill" />
        </view>
        
        <view class="step-info">
          <text class="progress-text">{{progressPercentage}}% Â· {{completedCount}}/{{totalSteps}} æ­¥</text>
          <text class="step-main-title">{{currentStepTitle}}</text>
          <text class="step-sub-title">{{currentStepSubtitle}}</text>
        </view>
      </view>
    </view>
  </view>

  <view class="page-content">
    <view class="timeline-container">
      <view
        wx:for="{{steps}}"
        wx:key="id"
        class="timeline-item {{item.stepType}} {{item.completed ? 'completed' : ''}} {{index === (steps.length - 1) ? 'is-last' : ''}} {{index === currentIndex ? 'active' : ''}}"
        id="step-{{item.id}}"
        bindtap="onStepTap"
        data-index="{{index}}"
      >
        <!-- é˜¶æ®µæ¨ªå¹…ï¼ˆæ”¯æŒæ–‡æ¡ˆé…ç½®ï¼‰ -->
        <view wx:if="{{item.isPhaseStart}}" class="phase-banner {{item.phaseType}}">
          <view class="phase-banner-main">
            <view class="phase-icon">
              <text wx:if="{{item.phaseType === 'prep'}}">ğŸ¥¬</text>
              <text wx:elif="{{item.phaseType === 'long_term'}}">ğŸ²</text>
              <text wx:elif="{{item.phaseType === 'gap'}}">âš¡</text>
              <text wx:elif="{{item.phaseType === 'cook'}}">ğŸ”¥</text>
              <text wx:elif="{{item.phaseType === 'finish'}}">ğŸ½ï¸</text>
            </view>
            <view class="phase-texts">
              <text class="phase-title">{{item.phaseTitle}}</text>
              <text wx:if="{{item.phaseSubtitle}}" class="phase-subtitle">{{item.phaseSubtitle}}</text>
            </view>
          </view>
        </view>

        <!-- å·¦ä¾§æ—¶é—´è½´çº¿ -->
        <view class="timeline-rail">
          <view class="timeline-dot {{item.stepType === 'prep' ? 'dot-knife' : 'dot-fire'}}"></view>
          <view class="timeline-line {{item.stepType === 'prep' ? 'line-dashed' : 'line-solid'}}"></view>
          <!-- å®å®åˆ†æ”¯ -->
          <view class="baby-branch" wx:if="{{item.roleTag === 'å®å®é¤'}}">
            <view class="baby-dot">ğŸ¼</view>
          </view>
        </view>

        <!-- å³ä¾§æ­¥éª¤å¡ç‰‡ -->
        <view class="timeline-content">
          <view class="step-card {{item.completed ? 'completed' : ''}} {{index === (steps.length - 1) ? 'is-last' : ''}}">
            <view class="step-card__header">
              <view class="step-card__title-row">
                <text class="step-card__title">{{item.title}}</text>
                <view class="tag-group">
                  <text wx:if="{{item.roleTag === 'æˆäººé¤'}}" class="mini-badge adult">å¤§äºº</text>
                  <text wx:if="{{item.roleTag === 'å®å®é¤'}}" class="mini-badge baby">å®å®</text>
                  <block wx:if="{{item.roleTag === 'æˆäºº+å®å®'}}">
                    <text class="mini-badge adult">å¤§äºº</text>
                    <text class="mini-badge baby">å®å®</text>
                  </block>
                  <text wx:if="{{item.knifeWorkLabel}}" class="mini-badge knife">{{item.knifeWorkLabel}}</text>
                </view>
              </view>
              <view wx:if="{{item.duration != null}}" class="step-card__meta-mini">
                <text class="meta-time">ğŸ•’ {{item.duration}}'</text>
              </view>
            </view>

            <view class="step-card__body">
              <!-- å¹¶è¡Œä¸Šä¸‹æ–‡æç¤º -->
              <view wx:if="{{item.parallelContext}}" class="context-pill">
                <text class="pill-text">{{item.parallelContext.hint}}</text>
                <text wx:if="{{item.parallelContext.remainingMinutes != null}}" class="pill-timer">
                  {{item.parallelContext.remainingMinutes}}'
                </text>
              </view>

              <view class="step-details condensed">
                <view
                  wx:for="{{item.details}}"
                  wx:for-item="line"
                  wx:key="index"
                  class="detail-line {{line.isBabyPortion ? 'baby-portion-action' : ''}}"
                >
                  <!-- ä½¿ç”¨ rich-text æ¸²æŸ“ï¼Œé¿å…åµŒå¥— <text> åœ¨éƒ¨åˆ†è®¾å¤‡ä¸Šå¯¼è‡´æ„å¤–æ¢è¡Œ -->
                  <rich-text class="detail-line-text" nodes="{{line.richTextHtml}}"></rich-text>
                </view>
              </view>

              <view wx:if="{{item.showSeasoningsList}}" class="seasoning-inline">
                <scroll-view class="seasoning-scroll" scroll-x="true" show-scrollbar="false">
                  <view class="seasoning-row">
                    <view wx:for="{{item.seasoningsList}}" wx:for-item="ing" wx:key="name" class="ing-tag">
                      <text class="n">{{ing.name}}</text>
                      <text class="a">{{ing.amount}}</text>
                    </view>
                  </view>
                </scroll-view>
              </view>

              <button
                class="step-action-btn {{item.completed ? 'is-done' : ''}}"
                catchtap="markCompleted"
                data-id="{{item.id}}"
              >
                {{item.completed ? 'å·²è¾¾æˆ' : 'å®Œæˆ'}}
              </button>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <view class="share-footer">
    <button class="share-btn" open-type="share">åˆ†äº«ä»Šæ—¥èœå•</button>
  </view>
</view>