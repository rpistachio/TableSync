<view class="steps-container cook-mode {{isAyiMode ? 'ayi-mode' : ''}} {{isHelperRole ? 'helper-role' : ''}}">
  <!-- æ‰§è¡Œè€…æ¨¡å¼ï¼šé¡¶éƒ¨å”¯ä¸€æ ‡é¢˜ + å¯æŠ˜å é£Ÿæå‡†å¤‡ -->
  <view wx:if="{{isHelperRole && helperTitle}}" class="helper-role-header">
    <!-- æ–¹æ¡ˆ5ï¼šèƒŒæ™¯æ’ç”» + æ¸å˜é®ç½© -->
    <image wx:if="{{helperHeaderBgUrl}}" class="helper-header-bg" src="{{helperHeaderBgUrl}}" mode="aspectFill" />
    <view class="helper-header-mask"></view>
    <view class="helper-header-content">
      <text class="helper-role-title">{{helperTitle}}</text>
      <view wx:if="{{helperIngredientsList.length > 0}}" class="helper-ingredients-panel">
        <view class="helper-ingredients-head" bindtap="toggleHelperIngredients">
          <text class="helper-ingredients-label">é£Ÿæå‡†å¤‡</text>
          <text class="helper-ingredients-toggle">{{helperIngredientsExpanded ? 'æ”¶èµ·' : 'å±•å¼€'}}</text>
        </view>
        <view wx:if="{{helperIngredientsExpanded}}" class="helper-ingredients-list">
          <view wx:for="{{helperIngredientsList}}" wx:key="name" class="helper-ingredient-item">
            <text class="helper-ingredient-name">{{item.name}}</text>
            <text class="helper-ingredient-amount">{{item.amount}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- è‡ªå·±åšæ¨¡å¼ï¼šæ°›å›´ hero + èƒŒæ™¯æ’ç”»ï¼ˆå±•å¼€â†’æŠ˜å åŠ¨ç”»ï¼‰ -->
  <view wx:if="{{!isHelperRole && !isAyiMode && selfCookDishNames}}" class="self-cook-hero {{heroCollapsed ? 'is-collapsed' : ''}}">
    <image wx:if="{{selfCookBgUrl}}" class="self-cook-hero-bg" src="{{selfCookBgUrl}}" mode="aspectFill" />
    <view class="self-cook-hero-mask"></view>
    <view class="self-cook-hero-content">
      <text class="self-cook-greeting">ä»Šæ—¥èœå•</text>
      <text class="self-cook-dishes">{{selfCookDishNames}}</text>
      <text class="self-cook-encourage">å…± {{totalSteps}} æ­¥ï¼Œè·Ÿç€èµ°å°±å¥½</text>
    </view>
  </view>

  <!-- Layer 1: æç®€å¤´éƒ¨ -->
  <view class="cook-header">
    <view class="progress-bar-track">
      <view class="progress-bar-fill" style="{{progressBarStyle}}"></view>
    </view>
    <view class="header-info">
      <text class="step-counter">{{currentStepIndexDisplay}}/{{totalSteps}}</text>
      <text class="current-dish-name">{{currentStepSubtitle}}</text>
    </view>
    <scroll-view wx:if="{{!isAyiMode && rhythmRings.length > 0}}" class="rhythm-ring-row" scroll-x enable-flex enhanced show-scrollbar="{{false}}">
      <view
        wx:for="{{rhythmRings}}"
        wx:key="name"
        class="rhythm-ring accent-{{index % 6}} {{item.isActive ? 'is-active' : ''}} {{item.isPulsing ? 'is-pulsing' : ''}}"
        style="{{item.ringStyle}}"
      >
        <view class="ring-inner">
          <text class="ring-percent">{{item.percent}}%</text>
          <text class="ring-label">{{item.name}}</text>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- Layer 2: æµ®åŠ¨å¹¶è¡ŒçŠ¶æ€æ¡ -->
  <view wx:if="{{showPaywallEntry && !isAyiMode && activeParallelTasks.length > 0}}" class="parallel-float-bar" bindtap="toggleGanttSheet">
    <scroll-view scroll-x class="parallel-scroll" enhanced show-scrollbar="{{false}}">
      <view class="parallel-chip-row">
        <view wx:for="{{activeParallelTasks}}" wx:key="stepId" class="parallel-chip">
          <text class="chip-dot"></text>
          <text class="chip-name">{{item.activeTaskName}}</text>
          <text class="chip-time">{{item.remainingMinutes}}'</text>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- Layer 3: èšç„¦æ­¥éª¤åŒº -->
  <view class="focus-area">
    <!-- ä¸Šä¸€æ­¥æ‘˜è¦ -->
    <view wx:if="{{prevStep}}" class="step-peek prev" bindtap="goPrevStep">
      <text class="peek-check">âœ“</text>
      <text class="peek-text">{{prevStep.title}}</text>
    </view>

    <!-- é‡Œç¨‹ç¢‘ï¼šå¤‡èœå®Œæˆ â†’ æ­£å¼å¼€ç«ï¼ˆå…¨å±è¿‡æ¸¡å¡ç‰‡ï¼‰ -->
    <view wx:if="{{currentStep.isMilestone}}" class="milestone-card {{currentStep.completed ? 'is-done' : ''}}">
      <text class="milestone-title">å‡†å¤‡å°±ç»ª</text>
      <text class="milestone-desc">æ‰€æœ‰é£Ÿæå·²å°±ç»ªï¼Œæˆ‘ä»¬æ­£å¼å¼€ç«</text>
      <view wx:if="{{!currentStep.completed}}" class="milestone-action" bindtap="markCurrentCompleted">
        <text class="milestone-btn-text">å¼€å§‹çƒ¹é¥ª</text>
      </view>
    </view>

    <!-- å½“å‰æ­¥éª¤èšç„¦å¡ï¼ˆéé‡Œç¨‹ç¢‘ï¼‰ -->
    <view wx:if="{{!currentStep.isMilestone}}" class="focus-card {{currentStep.completed ? 'is-done' : ''}}">
      <!-- é˜¶æ®µçº¤ç»†æ ‡ç­¾ -->
      <text wx:if="{{(!isAyiMode || isHelperRole) && currentPhaseLabel}}" class="phase-chip {{currentPhaseType}}">{{currentPhaseLabel}}</text>
      <!-- ç–²æƒ«æ¨¡å¼ï¼šç©ºæ°”ç‚¸é”…æ­¥éª¤è®¾å¤‡æ ‡è¯† -->
      <view wx:if="{{isTiredMode && currentStepDevice === 'air_fryer'}}" class="device-chip device-chip-airfryer">ç©ºæ°”ç‚¸é”…</view>

      <!-- æ­¥éª¤æ ‡é¢˜ -->
      <text class="focus-title">{{currentStep.title}}</text>

      <!-- æ¬¡åŠ¨ä½œæç¤º -->
      <view wx:if="{{(!isAyiMode || isHelperRole) && secondaryHint}}" class="focus-secondary">
        <text class="secondary-label">å¹¶è¡ŒèŠ‚æ‹</text>
        <text class="secondary-text">{{secondaryHint}}</text>
      </view>

      <!-- å¹¶è¡Œæç¤ºï¼ˆå†…è”ï¼‰ -->
      <view wx:if="{{currentStep.parallelContext}}" class="focus-parallel-hint">
        <text class="parallel-hint-text">{{currentStep.parallelContext.hint}}</text>
        <text wx:if="{{currentStep.parallelContext.remainingMinutes != null}}" class="parallel-hint-timer">
          {{currentStep.parallelContext.remainingMinutes}}'
        </text>
      </view>

      <!-- æŒ‡ä»¤æ­£æ–‡ -->
      <view class="focus-body">
        <view
          wx:for="{{currentStep.details}}"
          wx:for-item="line"
          wx:key="index"
          class="focus-line {{line.isBabyPortion ? 'baby-portion-action' : ''}}"
        >
          <rich-text class="focus-line-text" nodes="{{line.richText}}"></rich-text>
        </view>
      </view>

      <!-- è°ƒæ–™æ¨ªæ»š -->
      <view wx:if="{{currentStep.showSeasoningsList}}" class="focus-seasonings">
        <scroll-view class="seasoning-scroll" scroll-x enhanced show-scrollbar="{{false}}">
          <view class="seasoning-row">
            <view wx:for="{{currentStep.seasoningsList}}" wx:for-item="ing" wx:key="name" class="ing-tag">
              <text class="n">{{ing.name}}</text>
              <text class="a">{{ing.amount}}</text>
            </view>
          </view>
        </scroll-view>
      </view>

      <!-- æ—¶é•¿æç¤º -->
      <view wx:if="{{(!isAyiMode || isHelperRole) && currentStep.duration}}" class="focus-duration">
        <text class="duration-icon">â±</text>
        <text class="duration-text">çº¦ {{currentStep.duration}} åˆ†é’Ÿ</text>
      </view>

      <!-- äº‘ç«¯æ­¥éª¤ç¼ºå¤±æ—¶ï¼šé‡æ–°åŠ è½½å…¥å£ä¸é”™è¯¯æç¤º -->
      <view wx:if="{{showOfflineHint}}" class="offline-reload-area">
        <button wx:if="{{!stepsReloading}}" class="offline-reload-btn" type="plain" catchtap="retryLoadStepsFromCloud">é‡æ–°åŠ è½½æ­¥éª¤</button>
        <view wx:if="{{stepsReloading}}" class="offline-reload-loading">æ­£åœ¨ä»äº‘ç«¯åŠ è½½â€¦</view>
        <text wx:if="{{stepsSyncError}}" class="offline-reload-error">{{stepsSyncError}}</text>
      </view>
    </view>

    <!-- ä¸‹ä¸€æ­¥é¢„è§ˆ -->
    <view wx:if="{{nextStep}}" class="step-peek next" bindtap="goNextStep">
      <text class="peek-label">ä¸‹ä¸€æ­¥</text>
      <text class="peek-text">{{nextStep.title}}</text>
    </view>
  </view>

  <!-- åº•éƒ¨æ“ä½œæ  -->
  <view class="bottom-action-bar">
    <view class="action-prev {{!prevStep ? 'disabled' : ''}}" bindtap="goPrevStep">
      <text class="action-prev-text">ä¸Šä¸€æ­¥</text>
    </view>
    <button
      class="action-main {{currentStep.completed ? 'is-done' : ''}}"
      catchtap="markCurrentCompleted"
    >
      <text class="action-main-text">{{currentStep.isMilestone && !currentStep.completed ? 'å¼€å§‹çƒ¹é¥ª' : (isAyiMode ? 'åšå¥½äº†ï¼Œä¸‹ä¸€æ­¥' : (currentStep.completed ? 'âœ“ å·²å®Œæˆ' : 'å®Œæˆæ­¤æ­¥'))}}</text>
    </button>
    <view class="action-delay" catchtap="onDelayCurrentStep">
      <text class="action-delay-text">ç­‰æˆ‘ä¸€ä¸‹ +3'</text>
    </view>
    <view wx:if="{{showPaywallEntry && !isAyiMode}}" class="action-gantt" bindtap="toggleGanttSheet">
      <text class="action-gantt-icon">â±</text>
    </view>
    <view class="action-list" bindtap="toggleStepList">
      <text class="action-list-icon">â˜°</text>
    </view>
  </view>

  <!-- æ­¥éª¤åˆ—è¡¨ Bottom Sheet -->
  <view wx:if="{{showStepList}}" class="sheet-mask" bindtap="toggleStepList"></view>
  <view class="bottom-sheet {{showStepList ? 'is-open' : ''}}">
    <view class="sheet-header">
      <text class="sheet-title">å…¨éƒ¨æ­¥éª¤</text>
      <text class="sheet-close" bindtap="toggleStepList">æ”¶èµ·</text>
    </view>
    <scroll-view scroll-y class="sheet-scroll">
      <view
        wx:for="{{allViewSteps}}"
        wx:key="id"
        class="sheet-step-item {{item.completed ? 'is-completed' : ''}} {{index === currentIndex ? 'is-current' : ''}}"
        bindtap="onJumpToStep"
        data-index="{{index}}"
      >
        <view class="sheet-step-check">
          <text class="sheet-check-icon">{{item.completed ? 'âœ“' : (index + 1)}}</text>
        </view>
        <view class="sheet-step-info">
          <text class="sheet-step-title">{{item.title}}</text>
          <text wx:if="{{item.duration}}" class="sheet-step-meta">{{item.duration}}'</text>
        </view>
      </view>
    </scroll-view>
    <view class="sheet-footer" wx:if="{{!isHelperRole}}">
      <button class="sheet-share-btn" open-type="share">åˆ†äº«ä»Šæ—¥èœå•</button>
    </view>
  </view>

  <!-- VIP ä»˜è´¹å¼•å¯¼ï¼ˆé VIP ç‚¹å‡»ç”˜ç‰¹å›¾æ—¶å¼¹å‡ºï¼Œè®¾å¤‡éš”ç¦»ï¼‰ -->
  <vip-paywall visible="{{showVipPaywall}}" bindclose="onPaywallClose" bindunlock="onPaywallUnlock" />

  <!-- ç”˜ç‰¹å›¾ Bottom Sheet -->
  <view wx:if="{{!isAyiMode && showGanttSheet}}" class="sheet-mask" bindtap="toggleGanttSheet"></view>
  <view wx:if="{{!isAyiMode}}" class="bottom-sheet gantt-sheet {{showGanttSheet ? 'is-open' : ''}}">
    <view class="sheet-header">
      <text class="sheet-title">å¨æˆ¿ç»Ÿç­¹æ€»è§ˆ</text>
      <text class="sheet-close" bindtap="toggleGanttSheet">æ”¶èµ·</text>
    </view>
    <scroll-view scroll-y class="sheet-scroll">
      <!-- æ¨ªå‘æ³³é“å›¾ï¼ˆå¤šèœå¹¶è¡Œæ—¶æœ‰ startAt/endAtï¼‰ -->
      <block wx:if="{{ganttData.lanes && ganttData.lanes.length > 0}}">
        <view class="gantt-stats">
          <text class="gantt-stats-text">é¢„è®¡ {{ganttData.totalMinutes}} åˆ†é’Ÿå®Œæˆ</text>
          <text wx:if="{{ganttData.savedMinutes > 0}}" class="gantt-stats-saved">æ¯”ä¸²è¡ŒèŠ‚çœ {{ganttData.savedMinutes}} åˆ†é’Ÿ</text>
        </view>
        <view class="gantt-timeline-wrap">
          <view class="gantt-time-ruler">
            <text wx:for="{{5}}" wx:key="*this" class="gantt-time-tick">{{ganttData.totalMinutes * index / 4}}'</text>
          </view>
          <scroll-view scroll-x class="gantt-lanes-scroll" enhanced show-scrollbar="{{false}}">
            <view class="gantt-lanes-inner" style="min-width: {{ganttData.totalMinutes * 12}}rpx;">
              <view wx:for="{{ganttData.lanes}}" wx:key="device" class="gantt-lane">
                <view class="gantt-lane-label">
                  <view class="gantt-lane-dot" style="background: {{item.color}}"></view>
                  <text class="gantt-lane-name">{{item.label}}</text>
                </view>
                <view class="gantt-lane-bars">
                  <view
                    wx:for="{{item.bars}}"
                    wx:for-item="bar"
                    wx:key="stepIndex"
                    class="gantt-bar {{bar.isCurrent ? 'gantt-bar-current' : ''}} {{bar.completed ? 'gantt-bar-done' : ''}}"
                    style="left: {{bar.leftPercent}}; width: {{bar.widthPercent}}; background: {{bar.color}};"
                    data-step-index="{{bar.stepIndex}}"
                    catchtap="onGanttBarTap"
                  >
                    <text class="gantt-bar-name">{{bar.name}}</text>
                    <text wx:if="{{bar.completed}}" class="gantt-bar-check">âœ“</text>
                  </view>
                </view>
              </view>
            </view>
          </scroll-view>
        </view>
      </block>
      <!-- é™çº§ï¼šæŒ‰èœå“åˆ†ç»„çš„æ­¥éª¤åˆ—è¡¨ï¼ˆæ— æ³³é“æ—¶ï¼Œå¯ç‚¹å‡»è·³è½¬ï¼‰ -->
      <block wx:elif="{{ganttRecipes.length > 0}}">
        <view class="gantt-section">
          <view wx:for="{{ganttRecipes}}" wx:key="name" class="gantt-recipe-group">
            <view class="gantt-recipe-header">
              <text class="gantt-recipe-name">{{item.name}}</text>
              <text class="gantt-recipe-progress">{{item.completedCount}}/{{item.totalCount}}</text>
              <text wx:if="{{item.totalMinutes > 0}}" class="gantt-recipe-time">çº¦{{item.totalMinutes}}'</text>
            </view>
            <view class="gantt-bar-track">
              <view class="gantt-bar-fill" style="{{item.barWidthStyle}}"></view>
            </view>
            <view class="gantt-step-list">
              <view wx:for="{{item.steps}}" wx:for-item="step" wx:key="id" class="gantt-step-item {{step.completed ? 'is-done' : ''}} {{step.isCurrent ? 'is-current' : ''}}" data-step-index="{{step.stepIndex}}" catchtap="onGanttBarTap">
                <text class="gantt-step-dot">{{step.completed ? 'âœ“' : (step.isCurrent ? 'â—' : 'â—‹')}}</text>
                <text class="gantt-step-title">{{step.title}}</text>
                <text wx:if="{{step.duration}}" class="gantt-step-dur">{{step.duration}}'</text>
              </view>
            </view>
          </view>
        </view>
      </block>
      <view wx:if="{{!(ganttData.lanes && ganttData.lanes.length > 0) && ganttRecipes.length === 0}}" class="gantt-empty">
        <text class="gantt-empty-text">æš‚æ— æ­¥éª¤æ•°æ®</text>
      </view>
    </scroll-view>
  </view>

  <!-- è´´çº¸å³æ—¶æ‰è½ -->
  <sticker-drop
    visible="{{showStickerDrop}}"
    queue="{{stickerDropQueue}}"
    bindclose="onStickerDropClose"
  />

  <!-- åšå®Œé¥­åéšå¼åé¦ˆ -->
  <view class="postcook-overlay" wx:if="{{showPostCookFeedback}}">
    <view class="postcook-card {{postCookFeedbackFade ? 'postcook-fade-in' : ''}}">
      <text class="postcook-title">è¿™æ¡Œèœæ€ä¹ˆæ ·ï¼Ÿ</text>
      <text class="postcook-subtitle">ä½ çš„åé¦ˆå¸®æˆ‘æ›´æ‡‚ä½ çš„èƒƒ</text>
      <view class="postcook-options">
        <view class="postcook-option" data-feedback="like" bindtap="onPostCookFeedback">
          <text class="postcook-option-icon">ğŸ˜‹</text>
          <text class="postcook-option-label">å¾ˆå–œæ¬¢</text>
        </view>
        <view class="postcook-option" data-feedback="ok" bindtap="onPostCookFeedback">
          <text class="postcook-option-icon">ğŸ™‚</text>
          <text class="postcook-option-label">è¿˜ä¸é”™</text>
        </view>
        <view class="postcook-option" data-feedback="dislike" bindtap="onPostCookFeedback">
          <text class="postcook-option-icon">ğŸ˜</text>
          <text class="postcook-option-label">ä¸å¤ªå¯¹</text>
        </view>
      </view>
    </view>
  </view>
</view>
