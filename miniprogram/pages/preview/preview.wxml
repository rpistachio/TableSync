<view class="preview-page {{isTiredMode ? 'preview-page-tired' : ''}} {{isHelperMode ? 'preview-page-helper' : ''}}">
  <view class="preview-page-scroll">
    <view class="preview-scroll-content">
      <view class="preview-header">
        <view class="preview-header-text">
          <image wx:if="{{professionalTalkBgUrl}}" class="preview-header-avatar" src="{{professionalTalkBgUrl}}" mode="aspectFill" />
          <view class="preview-header-text-body">
            <text class="preview-header-title">营养师推荐理由</text>
            <text class="preview-narrative">{{previewNarrativeText}}</text>
          </view>
        </view>
        <view class="preview-header-divider"></view>
      </view>

      <scroll-view wx:if="{{isHelperMode || previewDashboard.estimatedTime || previewDashboard.stoveCount > 0 || previewDashboard.categoryLabels}}" class="dashboard-bar" scroll-x enable-flex>
        <block wx:if="{{isHelperMode}}">
          <view class="dash-item dash-item-helper">
            <text class="dash-value">上手难度：极简</text>
          </view>
        </block>
        <block wx:else>
          <view class="dash-item">
            <text class="dash-value">{{previewDashboard.estimatedTime}}</text>
          </view>
          <view class="dash-item">
            <text class="dash-value">{{previewDashboard.stoveCount}}火</text>
          </view>
          <view class="dash-item" wx:if="{{previewDashboard.categoryLabels}}">
            <text class="dash-value">{{previewDashboard.categoryLabels}}</text>
          </view>
        </block>
      </scroll-view>

      <view class="preview-menu-header">
        <view class="preview-menu-titles">
          <text class="preview-menu-label">{{previewPageTitle}}</text>
          <view class="preview-person-picker-wrap" catchtap="onTogglePersonPicker">
            <text class="preview-person-picker-label">{{adultCount}}人份 ▾</text>
            <view class="preview-person-bubble" wx:if="{{showPersonPicker}}">
              <view wx:for="{{[1,2,3,4]}}" wx:key="*this" class="preview-person-option" data-value="{{item}}" catchtap="onChangeAdultCount">{{item}}人</view>
            </view>
          </view>
        </view>
      </view>
      <view class="preview-baby-hint" wx:if="{{previewHasBaby && !isHelperMode}}">下方标「宝宝」的为宝宝辅食</view>

      <block wx:if="{{isHelperMode}}">
        <view class="helper-card-wrap">
          <helper-card
            mergedTitle="{{helperData.mergedTitle}}"
            combinedPrepItems="{{helperData.combinedPrepItems}}"
            combinedActions="{{helperData.combinedActions}}"
            heartMessage="{{helperData.heartMessage}}"
          />
        </view>
      </block>

      <view wx:if="{{!isHelperMode}}" class="preview-dish-list">
        <view wx:for="{{previewMenuRows}}" wx:key="index" class="dish-card-wrap" data-index="{{index}}" bindtap="onCheckRow">
          <view class="dish-card-modern {{item.checked ? '' : 'is-unchecked'}} {{item.hasCover ? '' : 'no-cover'}}" style="animation-delay: {{index * 120}}ms">
            <image wx:if="{{item.hasCover && isImageReady && item.coverTempUrl}}" class="card-bg" src="{{item.coverTempUrl}}" mode="aspectFill" />
            <view class="card-overlay"></view>
            <view class="airfryer-tag" wx:if="{{isTiredMode && item.cookType === 'air_fryer'}}">空气炸锅</view>
            <view class="card-info">
              <view class="card-header">
                <text class="dish-name">{{item.adultName}}</text>
                <view class="check-badge" wx:if="{{item.checked}}">✓</view>
                <view class="replace-badge" wx:else catchtap="onReplaceSingle" data-index="{{index}}">换这道</view>
              </view>
              <view class="card-footer">
                <text class="dish-reason">{{item.recommendReason}}</text>
                <view class="baby-tag-floating" wx:if="{{item.babyName}}">宝宝吃：{{item.babyName}}</view>
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- 统筹预览：串行 vs 并行对比（仅当有感知效率时展示） -->
      <view wx:if="{{!isHelperMode && schedulePreview.savedTime > 0 && schedulePreview.efficiency > 10}}" class="schedule-compare-section">
        <view class="compare-row compare-row-serial">
          <text class="compare-label">常规烹饪</text>
          <view class="compare-bar-track">
            <view class="compare-bar-fill compare-bar-serial" style="width:100%"></view>
          </view>
          <text class="compare-time compare-time-serial">{{schedulePreview.serialTime}}分钟</text>
        </view>
        <view class="compare-row compare-row-parallel">
          <text class="compare-label">TableSync 统筹</text>
          <view class="compare-bar-track">
            <view class="compare-bar-fill compare-bar-parallel" style="width:{{schedulePreview.parallelPercent}}%"></view>
          </view>
          <text class="compare-time compare-time-parallel">{{schedulePreview.totalTime}}分钟</text>
        </view>
        <view wx:if="{{!isTiredMode}}" class="efficiency-stamp">
          <text class="efficiency-stamp-text">节省 {{schedulePreview.savedTime}} 分钟</text>
        </view>
        <view wx:if="{{isTiredMode}}" class="tired-mode-hint">
          <text class="tired-hint-text">已开启极简统筹，减少 60% 手动操作</text>
        </view>
        <view class="cooking-timeline" wx:if="{{schedulePreview.cookingOrder && schedulePreview.cookingOrder.length > 0}}">
          <view class="timeline-title">
            <text class="timeline-title-text">最佳烹饪顺序</text>
          </view>
          <view class="timeline-list">
            <view class="timeline-item {{item.noWatch ? 'timeline-item-no-watch' : ''}}" wx:for="{{schedulePreview.cookingOrder}}" wx:key="phase">
              <view class="timeline-dot-wrap">
                <view class="timeline-dot">
                  <text class="timeline-dot-icon">{{item.icon}}</text>
                </view>
                <view class="timeline-line" wx:if="{{index < schedulePreview.cookingOrder.length - 1}}"></view>
              </view>
              <view class="timeline-content">
                <view class="timeline-phase-row">
                  <text class="timeline-phase">{{item.phase}}</text>
                  <text class="timeline-time">{{item.time}}</text>
                </view>
                <text class="timeline-dishes">{{item.dishesText}}</text>
                <text class="timeline-note">{{item.note}}</text>
              </view>
            </view>
          </view>
        </view>
      </view>

      <view class="preview-add-dish-placeholder" catchtap="onAddDish">
        <text class="preview-add-dish-text">+ 再加个菜？</text>
      </view>
      <view class="preview-avoid-bar">
        <view wx:for="{{avoidCapsules}}" wx:key="key" class="preview-avoid-chip {{item.active ? 'is-active' : ''}}" data-key="{{item.key}}" catchtap="onToggleAvoid">
          <text class="preview-avoid-label">{{item.label}}</text>
        </view>
      </view>
    </view>
  </view>

  <view class="preview-actions">
    <button class="preview-btn preview-btn-secondary" catchtap="handleShuffle">{{shuffleBtnText}}</button>
    <button class="preview-btn preview-btn-ghost" open-type="share">发给别人</button>
    <button wx:if="{{!isHelperMode}}" class="preview-btn preview-btn-primary" catchtap="confirmAndGo">{{previewPrimaryCta}}</button>
  </view>
</view>
