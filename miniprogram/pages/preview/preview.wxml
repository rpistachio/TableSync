<view class="preview-page {{isTiredMode ? 'preview-page-tired' : ''}} {{isHelperMode ? 'preview-page-helper' : ''}}">
  <view class="preview-page-scroll">
    <view class="preview-scroll-content">
      <view class="preview-header">
        <view class="preview-header-text">
          <image wx:if="{{professionalTalkBgUrl}}" class="preview-header-avatar" src="{{professionalTalkBgUrl}}" mode="aspectFill" />
          <view class="preview-header-text-body">
            <text class="preview-header-title">è¥å…»å¸ˆæ¨èç†ç”±</text>
            <text class="preview-narrative">{{previewNarrativeText}}</text>
          </view>
        </view>
        <view class="preview-header-divider"></view>
      </view>

      <scroll-view wx:if="{{isHelperMode || previewDashboard.estimatedTime || previewDashboard.stoveCount > 0 || previewDashboard.categoryLabels}}" class="dashboard-bar" scroll-x enable-flex>
        <block wx:if="{{isHelperMode}}">
          <view class="dash-item dash-item-helper">
            <text class="dash-value">ä¸Šæ‰‹éš¾åº¦ï¼šæç®€</text>
          </view>
        </block>
        <block wx:else>
          <view class="dash-item">
            <text class="dash-value">{{previewDashboard.estimatedTime}}</text>
          </view>
          <view class="dash-item">
            <text class="dash-value">{{previewDashboard.stoveCount}}ç«</text>
          </view>
          <view class="dash-item" wx:if="{{previewDashboard.categoryLabels}}">
            <text class="dash-value">{{previewDashboard.categoryLabels}}</text>
          </view>
        </block>
      </scroll-view>

      <view class="preview-menu-header">
        <view class="preview-menu-titles">
          <text class="preview-menu-label">{{previewPageTitle}}</text>
          <view class="preview-header-pickers">
            <view class="preview-person-picker-wrap" catchtap="onTogglePersonPicker">
              <text class="preview-person-picker-label">{{adultCount}}äººä»½ â–¾</text>
              <view class="preview-person-bubble" wx:if="{{showPersonPicker}}">
                <view wx:for="{{[1,2,3,4]}}" wx:key="*this" class="preview-person-option" data-value="{{item}}" catchtap="onChangeAdultCount">{{item}}äºº</view>
              </view>
            </view>
            <view wx:if="{{!isHelperMode}}" class="preview-baby-toggle-wrap {{previewHasBaby ? 'preview-baby-toggle-active' : ''}}" catchtap="onToggleBabyPicker">
              <text class="preview-baby-toggle-label" wx:if="{{!previewHasBaby}}">+ å®å®</text>
              <view wx:else class="preview-baby-toggle-active-inner">
                <text class="preview-baby-toggle-label">å®å® {{babyMonthLabel}}</text>
                <text class="preview-baby-remove" catchtap="onRemoveBaby" data-stop="1">âœ•</text>
              </view>
              <view class="preview-baby-bubble" wx:if="{{showBabyPicker && !previewHasBaby}}">
                <view class="preview-baby-option" data-month="8" catchtap="onSelectBabyMonth">6-8æœˆ</view>
                <view class="preview-baby-option" data-month="12" catchtap="onSelectBabyMonth">9-12æœˆ</view>
                <view class="preview-baby-option" data-month="18" catchtap="onSelectBabyMonth">13-18æœˆ</view>
                <view class="preview-baby-option" data-month="24" catchtap="onSelectBabyMonth">19-24æœˆ</view>
                <view class="preview-baby-option" data-month="36" catchtap="onSelectBabyMonth">25-36æœˆ</view>
              </view>
            </view>
          </view>
        </view>
      </view>
      <view class="preview-baby-hint" wx:if="{{previewHasBaby && !isHelperMode}}">ä¸‹æ–¹æ ‡ã€Œå®å®ã€çš„ä¸ºå®å®è¾…é£Ÿ</view>

      <block wx:if="{{isHelperMode}}">
        <view class="helper-card-wrap">
          <helper-card
            mergedTitle="{{helperData.mergedTitle}}"
            combinedPrepItems="{{helperData.combinedPrepItems}}"
            combinedActions="{{helperData.combinedActions}}"
            heartMessage="{{helperData.heartMessage}}"
          />
        </view>
      </block>

      <view wx:if="{{!isHelperMode}}" class="preview-dish-list">
        <view wx:for="{{previewMenuRows}}" wx:key="index" class="dish-card-wrap" data-index="{{index}}" bindtap="onCheckRow">
          <view class="dish-card-modern {{item.checked ? '' : 'is-unchecked'}} {{item.hasCover ? '' : 'no-cover'}}" style="animation-delay: {{index * 120}}ms">
            <image wx:if="{{item.hasCover && isImageReady && item.coverTempUrl}}" class="card-bg" src="{{item.coverTempUrl}}" mode="aspectFill" />
            <view class="card-overlay"></view>
            <view class="airfryer-tag" wx:if="{{isTiredMode && item.cookType === 'air_fryer'}}">ç©ºæ°”ç‚¸é”…</view>
            <view class="card-info">
              <view class="card-header">
                <text class="dish-name">{{item.adultName}}</text>
                <view class="check-badge" wx:if="{{item.checked}}">âœ“</view>
                <view class="card-action-group" wx:else>
                  <view class="replace-badge" catchtap="onReplaceSingle" data-index="{{index}}">æ¢è¿™é“</view>
                  <view class="remove-badge" catchtap="onRemoveDish" data-index="{{index}}">åˆ æ‰</view>
                </view>
              </view>
              <view class="card-footer">
                <text class="dish-reason">{{item.recommendReason}}</text>
                <view class="baby-tag-floating" wx:if="{{previewHasBaby && item.babyName}}">å®å®åƒï¼š{{item.babyName}}</view>
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- ç»Ÿç­¹é¢„è§ˆï¼šä¸²è¡Œ vs å¹¶è¡Œå¯¹æ¯”ï¼ˆä»…å½“æœ‰æ„ŸçŸ¥æ•ˆç‡æ—¶å±•ç¤ºï¼‰ -->
      <view wx:if="{{!isHelperMode && schedulePreview.savedTime > 0 && schedulePreview.efficiency > 10}}" class="schedule-compare-section">
        <view class="compare-row compare-row-serial">
          <text class="compare-label">å¸¸è§„çƒ¹é¥ª</text>
          <view class="compare-bar-track">
            <view class="compare-bar-fill compare-bar-serial" style="width:100%"></view>
          </view>
          <text class="compare-time compare-time-serial">{{schedulePreview.serialTime}}åˆ†é’Ÿ</text>
        </view>
        <view class="compare-row compare-row-parallel">
          <text class="compare-label">TableSync ç»Ÿç­¹</text>
          <view class="compare-bar-track">
            <view class="compare-bar-fill compare-bar-parallel" style="width:{{schedulePreview.parallelPercent}}%"></view>
          </view>
          <text class="compare-time compare-time-parallel">{{schedulePreview.totalTime}}åˆ†é’Ÿ</text>
        </view>
        <view wx:if="{{!isTiredMode}}" class="efficiency-stamp">
          <text class="efficiency-stamp-text">èŠ‚çœ {{schedulePreview.savedTime}} åˆ†é’Ÿ</text>
        </view>
        <view wx:if="{{isTiredMode}}" class="tired-mode-hint">
          <text class="tired-hint-text">å·²å¼€å¯æç®€ç»Ÿç­¹ï¼Œå‡å°‘ 60% æ‰‹åŠ¨æ“ä½œ</text>
        </view>
        <view class="cooking-timeline" wx:if="{{schedulePreview.cookingOrder && schedulePreview.cookingOrder.length > 0}}">
          <view class="timeline-title">
            <text class="timeline-title-text">æœ€ä½³çƒ¹é¥ªé¡ºåº</text>
          </view>
          <view class="timeline-list">
            <view class="timeline-item {{item.noWatch ? 'timeline-item-no-watch' : ''}}" wx:for="{{schedulePreview.cookingOrder}}" wx:key="phase">
              <view class="timeline-dot-wrap">
                <view class="timeline-dot">
                  <text class="timeline-dot-icon">{{item.icon}}</text>
                </view>
                <view class="timeline-line" wx:if="{{index < schedulePreview.cookingOrder.length - 1}}"></view>
              </view>
              <view class="timeline-content">
                <view class="timeline-phase-row">
                  <text class="timeline-phase">{{item.phase}}</text>
                  <text class="timeline-time">{{item.time}}</text>
                </view>
                <text class="timeline-dishes">{{item.dishesText}}</text>
                <text class="timeline-note">{{item.note}}</text>
              </view>
            </view>
          </view>
        </view>
      </view>

      <view class="preview-add-dish-placeholder" catchtap="onAddDish">
        <text class="preview-add-dish-text">+ å†åŠ ä¸ªèœï¼Ÿ</text>
      </view>

      <!-- ä¸€å¥è¯å¾®è°ƒ -->
      <view class="tweak-bar" wx:if="{{!isHelperMode}}">
        <input
          class="tweak-input"
          placeholder="ç»™ä¸»å¨æè¦æ±‚ï¼ˆå¦‚ï¼šåˆ«æ”¾è‘± / æƒ³åƒé±¼ï¼‰"
          placeholder-class="tweak-placeholder"
          value="{{tweakText}}"
          bindinput="onTweakInput"
          confirm-type="send"
          bindconfirm="onTweakSubmit"
        />
        <view class="tweak-send {{tweakText ? 'tweak-send-active' : ''}}" catchtap="onTweakSubmit" wx:if="{{tweakText}}">
          <text class="tweak-send-text">é‡æ–°æ¨è</text>
        </view>
      </view>

      <view class="preview-avoid-bar">
        <view wx:for="{{avoidCapsules}}" wx:key="key" class="preview-avoid-chip {{item.active ? 'is-active' : ''}}" data-key="{{item.key}}" catchtap="onToggleAvoid">
          <text class="preview-avoid-label">{{item.label}}</text>
        </view>
      </view>
    </view>
  </view>

  <view class="preview-actions">
    <button class="preview-btn preview-btn-secondary" catchtap="handleShuffle">{{shuffleBtnText}}</button>
    <button class="preview-btn preview-btn-ghost" open-type="share">å‘ç»™åˆ«äºº</button>
    <button wx:if="{{!isHelperMode}}" class="preview-btn preview-btn-primary" catchtap="confirmAndGo">{{previewPrimaryCta}}</button>
  </view>

  <!-- è‡ªé€‰èœè°±å¼¹å‡ºé¢æ¿ -->
  <view class="pp-panel-mask {{showPickerPanel ? 'pp-panel-mask-visible' : ''}}" catchtap="_closePickerPanel"></view>
  <view class="pp-add-panel {{showPickerPanel ? 'pp-add-panel-visible' : ''}}">
    <view class="pp-panel-header">
      <text class="pp-panel-title">è‡ªé€‰èœè°±</text>
      <view class="pp-panel-close" catchtap="_closePickerPanel">
        <text class="pp-panel-close-icon">Ã—</text>
      </view>
    </view>
    <view class="pp-panel-tabs">
      <view class="pp-panel-tab {{pickerTab === 'native' ? 'pp-panel-tab-active' : ''}}" data-tab="native" bindtap="onPickerSwitchTab">
        <text class="pp-panel-tab-icon">ğŸ“š</text>
        <text class="pp-panel-tab-text">åŸç”Ÿèœè°±åº“</text>
      </view>
      <view class="pp-panel-tab {{pickerTab === 'imported' ? 'pp-panel-tab-active' : ''}}" data-tab="imported" bindtap="onPickerSwitchTab">
        <text class="pp-panel-tab-icon">ğŸ”—</text>
        <text class="pp-panel-tab-text">æœ€è¿‘å¯¼å…¥</text>
      </view>
    </view>
    <view class="pp-panel-content" wx:if="{{pickerTab === 'native'}}">
      <scroll-view class="pp-filter-bar" scroll-x enhanced show-scrollbar="{{false}}">
        <view class="pp-filter-bar-inner">
          <view
            wx:for="{{pickerFilterOptions}}"
            wx:key="value"
            class="pp-filter-tag {{pickerNativeFilter === item.value ? 'pp-filter-tag-active' : ''}}"
            data-filter="{{item.value}}"
            bindtap="onPickerNativeFilter"
          >
            <text class="pp-filter-tag-text">{{item.label}}</text>
          </view>
        </view>
      </scroll-view>
      <scroll-view class="pp-recipe-scroll" scroll-y enhanced show-scrollbar="{{false}}">
        <view class="pp-recipe-pick-list">
          <view
            class="pp-recipe-pick-item"
            wx:for="{{pickerFilteredNativeRecipes}}"
            wx:key="id"
            data-index="{{index}}"
            bindtap="onPickerSelectNative"
          >
            <view class="pp-recipe-pick-info">
              <text class="pp-recipe-pick-name">{{item.name}}</text>
              <view class="pp-recipe-pick-meta">
                <text class="pp-recipe-pick-meta-tag">{{item._meatLabel || item.meat}}</text>
                <text class="pp-recipe-pick-meta-tag" wx:if="{{item._cookTypeLabel || item.cook_type}}">{{item._cookTypeLabel || item.cook_type}}</text>
              </view>
            </view>
            <text class="pp-recipe-pick-add">+</text>
          </view>
        </view>
        <view class="pp-recipe-pick-empty" wx:if="{{pickerFilteredNativeRecipes.length === 0}}">
          <text class="pp-recipe-pick-empty-text">æš‚æ— èœè°±</text>
        </view>
      </scroll-view>
    </view>
    <view class="pp-panel-content" wx:if="{{pickerTab === 'imported'}}">
      <scroll-view class="pp-recipe-scroll" scroll-y enhanced show-scrollbar="{{false}}">
        <view class="pp-recipe-pick-list">
          <view
            class="pp-recipe-pick-item"
            wx:for="{{pickerImportedRecipes}}"
            wx:key="id"
            data-index="{{index}}"
            bindtap="onPickerSelectImported"
          >
            <view class="pp-recipe-pick-info">
              <text class="pp-recipe-pick-name">{{item.name}}</text>
              <view class="pp-recipe-pick-meta">
                <text class="pp-recipe-pick-meta-tag pp-recipe-pick-meta-external">å¤–éƒ¨å¯¼å…¥</text>
                <text class="pp-recipe-pick-meta-tag" wx:if="{{item.sourcePlatform}}">{{item.sourcePlatform}}</text>
              </view>
            </view>
            <text class="pp-recipe-pick-add">+</text>
          </view>
        </view>
        <view class="pp-recipe-pick-empty" wx:if="{{pickerImportedRecipes.length === 0}}">
          <text class="pp-recipe-pick-empty-text">è¿˜æ²¡æœ‰å¯¼å…¥è¿‡èœè°±</text>
        </view>
      </scroll-view>
    </view>
  </view>
</view>
