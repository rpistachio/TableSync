<view class="scan-container">

  <!-- â•â•â• é¡¶éƒ¨æ ‡é¢˜åŒº â•â•â• -->
  <view class="scan-header">
    <text class="scan-title">æ‹ç…§æ¸…å†°ç®±</text>
    <text class="scan-subtitle">æ‹ä¸€å¼ æˆ–å¤šå¼ å†°ç®±ç…§ç‰‡ï¼ŒAI å¸®ä½ æ­é…ä»Šæ™šèœè°±</text>
  </view>

  <!-- â•â•â• å›¾ç‰‡é€‰æ‹©åŒºï¼ˆå¤šå›¾æ¨ªå‘æ»‘åŠ¨ï¼‰â•â•â• -->
  <view class="photo-area">
    <!-- æœ‰å›¾ç‰‡æ—¶ï¼šæ¨ªå‘æ»‘åŠ¨å›¾ç‰‡åˆ—è¡¨ + æœ«å°¾åŠ å· -->
    <scroll-view class="photo-list" scroll-x enhanced show-scrollbar="{{false}}" wx:if="{{imageList.length > 0}}">
      <view class="photo-list-inner">
        <view class="photo-thumb-wrap" wx:for="{{imageList}}" wx:key="path">
          <image class="photo-thumb" src="{{item.path}}" mode="aspectFill" />
          <view class="photo-thumb-remove" catchtap="onRemoveImage" data-index="{{index}}">
            <text class="photo-thumb-remove-icon">Ã—</text>
          </view>
        </view>
        <!-- æœ«å°¾åŠ å·æŒ‰é’®ï¼ˆæœªæ»¡ 5 å¼ æ—¶æ˜¾ç¤ºï¼‰-->
        <view class="photo-thumb-add" bindtap="onChooseImage" wx:if="{{imageList.length < 5}}">
          <text class="photo-thumb-add-icon">+</text>
          <text class="photo-thumb-add-text">æ·»åŠ </text>
        </view>
      </view>
    </scroll-view>

    <!-- æ— å›¾ç‰‡æ—¶ï¼šç©ºçŠ¶æ€å¤§å ä½ -->
    <view class="photo-box" bindtap="onChooseImage" wx:else>
      <view class="photo-placeholder">
        <text class="photo-placeholder-icon">ğŸ“·</text>
        <text class="photo-placeholder-text">æ‹ç…§ / ä»ç›¸å†Œé€‰æ‹©</text>
        <text class="photo-placeholder-hint">æœ€å¤š 5 å¼ ï¼Œå»ºè®®æ‹æ‘„å†°ç®±æ‰“å¼€åçš„å…¨è²Œ</text>
      </view>
    </view>

    <!-- å›¾ç‰‡è®¡æ•° -->
    <view class="photo-count" wx:if="{{imageList.length > 0}}">
      <text class="photo-count-text">å·²é€‰ {{imageList.length}} / 5 å¼ </text>
    </view>
  </view>

  <!-- â•â•â• æ“ä½œæŒ‰é’®åŒº â•â•â• -->
  <view class="action-bar" wx:if="{{stage === 'idle' && imageList.length > 0}}">
    <button class="scan-btn" bindtap="onStartScan">
      <text class="scan-btn-text">å¼€å§‹è¯†åˆ«</text>
    </button>
  </view>

  <!-- â•â•â• åŠ è½½çŠ¶æ€ â•â•â• -->
  <view class="loading-area" wx:if="{{stage === 'uploading' || stage === 'scanning'}}">
    <view class="loading-ring"></view>
    <text class="loading-text">{{statusText}}</text>
    <view class="loading-steps">
      <view class="loading-step {{stage === 'uploading' || stage === 'scanning' ? 'is-done' : ''}}">
        <text class="step-dot">{{stage === 'scanning' ? 'âœ“' : 'â—'}}</text>
        <text class="step-label">ä¸Šä¼ å›¾ç‰‡</text>
      </view>
      <view class="loading-step-line {{stage === 'scanning' ? 'is-active' : ''}}"></view>
      <view class="loading-step {{stage === 'scanning' ? 'is-active' : ''}}">
        <text class="step-dot">{{stage === 'scanning' ? 'â—' : 'â—‹'}}</text>
        <text class="step-label">AI è¯†åˆ«</text>
      </view>
      <view class="loading-step-line"></view>
      <view class="loading-step">
        <text class="step-dot">â—‹</text>
        <text class="step-label">ç»„é¤æ¨è</text>
      </view>
    </view>
  </view>

  <!-- â•â•â• é”™è¯¯çŠ¶æ€ â•â•â• -->
  <view class="error-area" wx:if="{{stage === 'error'}}">
    <text class="error-icon">ğŸ˜µ</text>
    <text class="error-text">{{statusText}}</text>
    <button class="retry-btn" bindtap="onRetry">é‡æ–°å¼€å§‹</button>
  </view>

  <!-- â•â•â• é£Ÿæç¡®è®¤/ç¼–è¾‘åŒºï¼ˆPart 2aï¼‰â•â•â• -->
  <view class="result-area" wx:if="{{stage === 'ingredients_review'}}">

    <!-- é£Ÿæç¼–è¾‘åŒº -->
    <view class="result-section">
      <view class="section-header">
        <text class="section-title">ç¡®è®¤é£Ÿæ</text>
        <text class="section-badge" wx:if="{{ingredients.length > 0}}">{{ingredients.length}} ç§</text>
      </view>
      <text class="section-hint">åˆ é™¤è¯¯è¯†åˆ«çš„é£Ÿæï¼Œæˆ–æ‰‹åŠ¨æ·»åŠ é—æ¼çš„é£Ÿæ</text>

      <!-- å¯ç¼–è¾‘çš„é£Ÿææ ‡ç­¾ï¼ˆå¸¦åˆ é™¤æŒ‰é’®ï¼‰-->
      <view class="ingredient-tags" wx:if="{{ingredients.length > 0}}">
        <view class="ingredient-tag ingredient-tag--editable" wx:for="{{ingredients}}" wx:key="name">
          <text class="ingredient-icon">{{item.icon}}</text>
          <text class="ingredient-name">{{item.name}}</text>
          <text class="ingredient-qty" wx:if="{{item.quantity}}">{{item.quantity}}</text>
          <view class="ingredient-remove" catchtap="onRemoveIngredient" data-index="{{index}}">
            <text class="ingredient-remove-icon">Ã—</text>
          </view>
        </view>
      </view>

      <!-- æ— é£Ÿæç©ºçŠ¶æ€ -->
      <view class="ingredients-empty" wx:if="{{ingredients.length === 0}}">
        <text class="ingredients-empty-icon">ğŸ”</text>
        <text class="ingredients-empty-text">{{statusText || 'æš‚æ— é£Ÿæï¼Œè¯·æ‰‹åŠ¨æ·»åŠ '}}</text>
      </view>

      <!-- ç½®ä¿¡åº¦ -->
      <view class="confidence-bar" wx:if="{{confidence > 0 && ingredients.length > 0}}">
        <text class="confidence-label">è¯†åˆ«ç½®ä¿¡åº¦</text>
        <view class="confidence-track">
          <view class="confidence-fill" style="width: {{confidence * 100}}%;"></view>
        </view>
        <text class="confidence-value">{{confidence > 0 ? (confidence * 100) + '%' : ''}}</text>
      </view>

      <!-- å¤‡æ³¨ -->
      <view class="notes-tip" wx:if="{{notes}}">
        <text class="notes-icon">ğŸ’¡</text>
        <text class="notes-text">{{notes}}</text>
      </view>

      <!-- æ‰‹åŠ¨æ·»åŠ é£Ÿæ -->
      <view class="add-ingredient-area">
        <!-- æ·»åŠ æŒ‰é’® -->
        <view class="add-ingredient-btn" bindtap="onToggleAddInput" wx:if="{{!showAddInput}}">
          <text class="add-ingredient-btn-icon">+</text>
          <text class="add-ingredient-btn-text">æ‰‹åŠ¨æ·»åŠ é£Ÿæ</text>
        </view>
        <!-- è¾“å…¥è¡¨å• -->
        <view class="add-ingredient-form" wx:if="{{showAddInput}}">
          <input
            class="add-ingredient-input"
            placeholder="è¾“å…¥é£Ÿæåç§°ï¼Œå¦‚ï¼šè¥¿çº¢æŸ¿"
            value="{{newIngredientName}}"
            bindinput="onNewIngredientInput"
            bindconfirm="onAddIngredient"
            focus="{{showAddInput}}"
            maxlength="20"
          />
          <view class="add-ingredient-actions">
            <view class="add-ingredient-cancel" bindtap="onToggleAddInput">å–æ¶ˆ</view>
            <view class="add-ingredient-confirm" bindtap="onAddIngredient">æ·»åŠ </view>
          </view>
        </view>
      </view>
    </view>

    <!-- åº•éƒ¨ç¡®è®¤æ“ä½œ -->
    <view class="confirm-bar">
      <view class="timing-info" wx:if="{{totalMs > 0}}">
        <text class="timing-text">è¯†åˆ«è€—æ—¶ {{totalMs > 1000 ? (totalMs / 1000) + 's' : totalMs + 'ms'}}</text>
      </view>
      <button class="confirm-btn" bindtap="onConfirmIngredients" disabled="{{ingredients.length === 0}}">
        <text class="confirm-btn-text">å¼€å§‹æ¨èï¼ˆ{{ingredients.length}} ç§é£Ÿæï¼‰</text>
      </button>
      <button class="retry-btn-outline" bindtap="onRetry">é‡æ–°æ‰«æ</button>
    </view>
  </view>

  <!-- â•â•â• è¯†åˆ«ç»“æœ + äº¤äº’é€‰èœï¼ˆPart 2bï¼‰â•â•â• -->
  <view class="result-area" wx:if="{{stage === 'done'}}">

    <!-- å·²é€‰èœè°±è®¡æ•°ï¼ˆç½®é¡¶æç¤ºï¼‰ -->
    <view class="selected-count-bar">
      <text class="selected-count-icon">ğŸ½ï¸</text>
      <text class="selected-count-text">å·²é€‰ <text class="selected-count-num">{{selectedCount}}</text> é“èœ</text>
    </view>

    <!-- è¯†åˆ«åˆ°çš„é£Ÿæï¼ˆåªè¯»æ‘˜è¦ï¼‰ -->
    <view class="result-section" wx:if="{{ingredients.length > 0}}">
      <view class="section-header">
        <text class="section-title">è¯†åˆ«åˆ°çš„é£Ÿæ</text>
        <text class="section-badge">{{ingredients.length}} ç§</text>
      </view>
      <view class="ingredient-tags">
        <view class="ingredient-tag" wx:for="{{ingredients}}" wx:key="name">
          <text class="ingredient-icon">{{item.icon}}</text>
          <text class="ingredient-name">{{item.name}}</text>
          <text class="ingredient-qty" wx:if="{{item.quantity}}">{{item.quantity}}</text>
        </view>
      </view>
    </view>

    <!-- AI ç»„é¤æ¨èï¼ˆå¯å‹¾é€‰ï¼‰ -->
    <view class="result-section" wx:if="{{recommendations.length > 0}}">
      <view class="section-header">
        <text class="section-title">ä»Šæ™šæ¨è</text>
        <text class="section-hint-inline">ç‚¹å‡»å¡ç‰‡å¯å–æ¶ˆå‹¾é€‰</text>
      </view>

      <!-- ç»„é¤æ‘˜è¦ -->
      <view class="meal-summary" wx:if="{{mealSummary}}">
        <text class="meal-summary-icon">ğŸ‘¨â€ğŸ³</text>
        <text class="meal-summary-text">{{mealSummary}}</text>
      </view>

      <!-- æ¨èèœè°±å¡ç‰‡ï¼ˆå¯å‹¾é€‰ï¼‰ -->
      <view class="recipe-cards">
        <view class="recipe-card {{item.selected ? 'is-selected' : 'is-unselected'}}"
              wx:for="{{recommendations}}" wx:key="id"
              bindtap="onToggleRecipe" data-index="{{index}}">
          <!-- é€‰ä¸­çŠ¶æ€æŒ‡ç¤ºå™¨ -->
          <view class="recipe-check {{item.selected ? 'is-checked' : ''}}">
            <text class="recipe-check-icon">{{item.selected ? 'âœ“' : ''}}</text>
          </view>
          <image class="recipe-cover" src="{{item.coverUrl}}" mode="aspectFill" lazy-load />
          <view class="recipe-info">
            <view class="recipe-top-row">
              <text class="recipe-name">{{item.name}}</text>
              <text class="recipe-role role-{{item.roleClass}}">{{item.roleLabel}}</text>
            </view>
            <text class="recipe-reason">{{item.reason}}</text>
            <view class="recipe-meta">
              <text class="recipe-time" wx:if="{{item.cook_minutes > 0}}">â± {{item.cook_minutes}}åˆ†é’Ÿ</text>
              <block wx:if="{{item.missing_ingredients.length > 0}}">
                <view class="recipe-missing">
                  <text class="missing-label">è¿˜éœ€ï¼š</text>
                  <text class="missing-item" wx:for="{{item.missing_ingredients}}" wx:for-item="mi" wx:key="*this">{{mi}}</text>
                </view>
              </block>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- æ›´å¤šåŒ¹é…èœè°±ï¼ˆå¯å‹¾é€‰åŠ å…¥ï¼‰â€”â€” wx:if é¿å…æŠ˜å æ—¶æ¸²æŸ“é•¿åˆ—è¡¨ -->
    <view class="result-section" wx:if="{{allMatched.length > 0}}">
      <view class="section-header" bindtap="onToggleMoreMatched">
        <text class="section-title">æ›´å¤šåŒ¹é…èœè°±</text>
        <text class="section-badge">{{allMatched.length}} é“</text>
        <text class="section-arrow {{showMoreMatched ? 'is-up' : ''}}">â–¾</text>
      </view>
      <text class="section-hint" wx:if="{{!showMoreMatched}}">ç‚¹å‡»å±•å¼€ï¼Œå‹¾é€‰æƒ³åŠ å…¥çš„èœè°±</text>
      <!-- ä»…å±•å¼€æ—¶æ‰æ¸²æŸ“åˆ—è¡¨ï¼Œåˆ†æ‰¹æ˜¾ç¤ºï¼ˆvisibleMatchedCount æ§åˆ¶ï¼‰ -->
      <view class="more-matched-list is-open" wx:if="{{showMoreMatched}}">
        <view class="matched-item {{item.selected ? 'is-selected' : ''}}"
              wx:for="{{allMatched}}" wx:key="id" wx:if="{{index < visibleMatchedCount}}"
              bindtap="onToggleMatchedRecipe" data-index="{{index}}">
          <!-- å‹¾é€‰æ¡† -->
          <view class="matched-check {{item.selected ? 'is-checked' : ''}}">
            <text class="matched-check-icon">{{item.selected ? 'âœ“' : '+'}}</text>
          </view>
          <!-- å°é¢ç¼©ç•¥å›¾ -->
          <image class="matched-cover" src="{{item.coverUrl}}" mode="aspectFill" lazy-load wx:if="{{item.coverUrl}}" />
          <view class="matched-info">
            <view class="matched-top-row">
              <text class="matched-name">{{item.name}}</text>
              <text class="matched-cook-type" wx:if="{{item.cook_type}}">{{item.cook_type}}</text>
            </view>
            <view class="matched-detail">
              <view class="matched-score-bar">
                <view class="matched-score-fill" style="width: {{item.scorePercent}}%;"></view>
              </view>
              <text class="matched-score-inline">{{item.scorePercent}}%åŒ¹é…</text>
            </view>
            <!-- åŒ¹é…åˆ°çš„é£Ÿæ -->
            <view class="matched-ingredients-row" wx:if="{{item.matchedIngredients.length > 0}}">
              <text class="matched-ing-label">å·²æœ‰ï¼š</text>
              <text class="matched-ing-tag matched-ing-tag--have" wx:for="{{item.matchedIngredients}}" wx:for-item="mi" wx:key="*this">{{mi}}</text>
            </view>
            <!-- ç¼ºå°‘çš„é£Ÿæ -->
            <view class="matched-ingredients-row" wx:if="{{item.missingIngredients.length > 0}}">
              <text class="matched-ing-label matched-ing-label--miss">è¿˜éœ€ï¼š</text>
              <text class="matched-ing-tag matched-ing-tag--miss" wx:for="{{item.missingIngredients}}" wx:for-item="mi" wx:key="*this">{{mi}}</text>
            </view>
          </view>
        </view>
        <!-- ã€ŒåŠ è½½æ›´å¤šã€æŒ‰é’® -->
        <view class="matched-load-more" wx:if="{{visibleMatchedCount < allMatched.length}}" bindtap="onLoadMoreMatched">
          <text class="matched-load-more-text">åŠ è½½æ›´å¤šï¼ˆå‰©ä½™ {{allMatched.length - visibleMatchedCount}} é“ï¼‰</text>
        </view>
      </view>
    </view>

    <!-- åº•éƒ¨æ“ä½œ -->
    <view class="result-bottom">
      <view class="timing-info" wx:if="{{totalMs > 0}}">
        <text class="timing-text">è¯†åˆ«è€—æ—¶ {{totalMs > 1000 ? (totalMs / 1000) + 's' : totalMs + 'ms'}}</text>
      </view>
      <button class="confirm-btn" bindtap="onConfirmRecipes" disabled="{{selectedCount === 0}}">
        <text class="confirm-btn-text">ç¡®è®¤ {{selectedCount}} é“èœï¼ŒæŸ¥çœ‹è´­ç‰©æ¸…å•</text>
      </button>
      <button class="retry-btn-outline" bindtap="onRetry">é‡æ–°æ‰«æ</button>
    </view>
  </view>

  <!-- â•â•â• æ™ºèƒ½è´­ç‰©æ¸…å•ï¼ˆPart 2cï¼‰â•â•â• -->
  <view class="result-area" wx:if="{{stage === 'shopping'}}">

    <!-- é¡¶éƒ¨æ¦‚è§ˆ -->
    <view class="shopping-overview">
      <text class="shopping-overview-icon">ğŸ›’</text>
      <view class="shopping-overview-info">
        <text class="shopping-overview-title">æ™ºèƒ½è´­ç‰©æ¸…å•</text>
        <text class="shopping-overview-desc">å·²ä¸º {{selectedRecipes.length}} é“èœæ±‡æ€»æ‰€éœ€é£Ÿæï¼Œå†°ç®±å·²æœ‰çš„å·²è‡ªåŠ¨å»é™¤</text>
      </view>
    </view>

    <!-- å·²é€‰èœè°±æ‘˜è¦ -->
    <view class="shopping-recipes-summary">
      <text class="shopping-recipes-label">å·²é€‰èœè°±ï¼š</text>
      <view class="shopping-recipes-tags">
        <text class="shopping-recipe-tag" wx:for="{{selectedRecipes}}" wx:key="id">{{item.name}}</text>
      </view>
    </view>

    <!-- éœ€è´­ä¹°çš„é£Ÿæ -->
    <view class="result-section">
      <view class="section-header">
        <text class="section-title">éœ€è¦è´­ä¹°</text>
        <text class="section-badge" wx:if="{{smartShoppingList.length > 0}}">{{smartShoppingList.length}} é¡¹</text>
      </view>

      <view class="smart-shopping-list" wx:if="{{smartShoppingList.length > 0}}">
        <view class="smart-shopping-item" wx:for="{{smartShoppingList}}" wx:key="name">
          <view class="smart-shopping-item-main">
            <text class="smart-shopping-item-icon">ğŸ”´</text>
            <text class="smart-shopping-item-name">{{item.name}}</text>
            <view class="smart-shopping-item-remove" catchtap="onRemoveShoppingItem" data-index="{{index}}">
              <text class="smart-shopping-item-remove-icon">Ã—</text>
            </view>
          </view>
          <view class="smart-shopping-item-from" wx:if="{{item.fromRecipes.length > 0}}">
            <text class="smart-shopping-from-label">ç”¨äºï¼š</text>
            <text class="smart-shopping-from-recipe" wx:for="{{item.fromRecipes}}" wx:for-item="rname" wx:key="*this">{{rname}}</text>
          </view>
        </view>
      </view>

      <view class="shopping-empty" wx:if="{{smartShoppingList.length === 0}}">
        <text class="shopping-empty-icon">ğŸ‰</text>
        <text class="shopping-empty-text">å†°ç®±é£Ÿæå·²å…¨éƒ¨è¦†ç›–ï¼Œæ— éœ€é¢å¤–è´­ä¹°ï¼</text>
      </view>
    </view>

    <!-- å†°ç®±å·²æœ‰çš„é£Ÿæï¼ˆé»˜è®¤æ’é™¤ï¼Œå¯æ‰‹åŠ¨åŠ å›ï¼‰ -->
    <view class="result-section" wx:if="{{excludedIngredients.length > 0}}">
      <view class="section-header">
        <text class="section-title">å†°ç®±å·²æœ‰ï¼ˆå·²æ’é™¤ï¼‰</text>
        <text class="section-badge">{{excludedIngredients.length}} é¡¹</text>
      </view>
      <text class="section-hint">è¿™äº›é£Ÿæå†°ç®±é‡Œå·²æœ‰ï¼Œå¦‚éœ€å¦è´­å¯ç‚¹å‡»ã€Œ+ã€åŠ å›æ¸…å•</text>

      <view class="excluded-list">
        <view class="excluded-item" wx:for="{{excludedIngredients}}" wx:key="name">
          <view class="excluded-item-main">
            <text class="excluded-item-icon">âœ…</text>
            <text class="excluded-item-name">{{item.name}}</text>
            <view class="excluded-item-add" catchtap="onAddBackExcluded" data-index="{{index}}">
              <text class="excluded-item-add-icon">+</text>
            </view>
          </view>
          <view class="excluded-item-from" wx:if="{{item.fromRecipes.length > 0}}">
            <text class="excluded-from-label">ç”¨äºï¼š</text>
            <text class="excluded-from-recipe" wx:for="{{item.fromRecipes}}" wx:for-item="rname" wx:key="*this">{{rname}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- åº•éƒ¨æ“ä½œ -->
    <view class="result-bottom">
      <button class="confirm-btn" bindtap="onStartCooking">
        <text class="confirm-btn-text">å¼€å§‹åšé¥­</text>
      </button>
      <button class="retry-btn-outline" bindtap="onBackToRecipes">è¿”å›ä¿®æ”¹èœè°±</button>
      <button class="retry-btn-outline" bindtap="onRetry" style="margin-top: -4rpx;">é‡æ–°æ‰«æ</button>
    </view>
  </view>

</view>
