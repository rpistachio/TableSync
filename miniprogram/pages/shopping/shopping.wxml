<view class="shopping-page">
  <view class="page-header">
    <image class="page-header-bg" src="{{heroCoverImage}}" mode="aspectFill"></image>
    <view class="header-mask"></view>
    <view class="header-content">
      <text class="curation-tag">Shopping List</text>
      <text class="main-title">采购清单</text>
      <text class="sub-title">{{currentDishName}} · 所需食材</text>
      <view wx:if="{{todayPrepTime > 0 || todayAllergens.length > 0}}" class="meta-tags">
        <text wx:if="{{todayPrepTime > 0}}" class="meta-tag prep-tag">准备约 {{todayPrepTime}} 分钟</text>
        <text wx:if="{{todayAllergensText}}" class="meta-tag allergen-tag">含过敏原：{{todayAllergensText}}</text>
      </view>
    </view>
  </view>
  <view class="page-content">
    <view class="toolbar">
      <picker mode="selector" range="{{sortOptions}}" range-key="text" value="{{sortIndex}}" bindchange="onSortChange">
        <view class="picker-label">{{sortOptions[sortIndex].text}}</view>
      </picker>
    </view>

    <view wx:if="{{todayTips.length > 0}}" class="today-tips">
      <text wx:for="{{todayTips}}" wx:key="*this" class="today-tip-line">{{item}}</text>
    </view>

    <block wx:if="{{groupedTodayItems.length > 0}}">
      <view wx:for="{{groupedTodayItems}}" wx:key="category" class="category-card">
        <view class="category-card__title">{{item.category}}</view>
        <view class="category-card__list">
          <view
            wx:for="{{item.items}}"
            wx:for-item="row"
            wx:for-index="rowIndex"
            wx:key="id"
            class="list-row {{row.checked ? 'is-done' : ''}} {{rowIndex % 2 === 1 ? 'stripe' : ''}}"
            bindtap="onCheckToday"
            data-item="{{row}}"
          >
            <view class="custom-check">
              <icon wx:if="{{row.checked}}" type="success_no_circle" size="12" color="#fff"/>
            </view>
            <view class="list-row__body">
              <view class="name-amount-row">
                <text class="list-row__name">{{row.name}}</text>
                <text class="list-row__amount">{{row.amount}}</text>
              </view>
              <text wx:if="{{row.isShared}}" class="shared-tag">多菜共用</text>
              <text wx:if="{{row.hasExternalSource && !row.isShared}}" class="shared-tag external-tag">外部菜谱</text>
              <text wx:if="{{row.fromRecipesText}}" class="from-recipes-hint">{{row.fromRecipesText}}</text>
            </view>
          </view>
        </view>
      </view>
    </block>
    <view wx:else class="empty-hint">暂无数据，请先在首页生成今日菜单</view>
  </view>

  <view class="fixed-bottom-bar">
    <button class="btn-go-steps" bindtap="goToSteps">食材已买齐</button>
  </view>
</view>
