<view class="shopping-page">
  <view class="page-header">
    <text class="curation-tag">Shopping List</text>
    <text class="main-title">采购清单</text>
    <text class="sub-title">今日/本周所需食材，按分类查看</text>
    <view wx:if="{{listMode === 'today' && (todayPrepTime > 0 || todayAllergens.length > 0)}}" class="meta-tags">
      <text wx:if="{{todayPrepTime > 0}}" class="meta-tag prep-tag">准备约 {{todayPrepTime}} 分钟</text>
      <text wx:if="{{todayAllergensText}}" class="meta-tag allergen-tag">含过敏原：{{todayAllergensText}}</text>
    </view>
  </view>
  <view class="page-content">
    <view class="main-tabs">
      <view class="tab-item {{listMode === 'today' ? 'active' : ''}}" data-mode="today" bindtap="onTabChange">今日</view>
      <view class="tab-item {{listMode === 'weekly' ? 'active' : ''}}" data-mode="weekly" bindtap="onTabChange">本周</view>
    </view>
    <view class="tabs-link-hint">
      <text wx:if="{{listMode === 'today'}}">今日清单来自首页生成的菜单；切换「本周」可查看 7 天参考、查漏补缺</text>
      <text wx:else>本周清单为 7 天参考，可与今日菜单搭配采购；切换「今日」查看当前菜单所需</text>
    </view>

    <view wx:if="{{listMode === 'weekly'}}" class="notice-card">
      <text class="notice-icon">📅</text>
      <text class="notice-text">{{weeklyNoticeText}}</text>
    </view>

    <view class="toolbar">
      <picker mode="selector" range="{{sortOptions}}" range-key="text" value="{{sortIndex}}" bindchange="onSortChange">
        <view class="picker-label">{{sortOptions[sortIndex].text}}</view>
      </picker>
    </view>

    <view wx:if="{{listMode === 'today' && todayTips.length > 0}}" class="today-tips">
      <text wx:for="{{todayTips}}" wx:key="*this" class="today-tip-line">{{item}}</text>
    </view>

    <block wx:if="{{listMode === 'today'}}">
      <block wx:if="{{groupedTodayItems.length > 0}}">
        <view wx:for="{{groupedTodayItems}}" wx:key="category" class="category-card">
          <view class="category-card__title">{{item.category}}</view>
          <view class="category-card__list">
            <view wx:for="{{item.items}}" wx:for-item="row" wx:key="id" class="list-row {{row.checked ? 'is-done' : ''}}">
              <checkbox value="{{row.id}}" checked="{{row.checked}}" bindtap="onCheckToday" data-item="{{row}}"/>
              <view class="list-row__body">
                <text class="list-row__name">{{row.name}}</text>
                <text class="list-row__amount">{{row.amount}}</text>
                <view class="list-row__tags">
                  <text wx:if="{{row.isShared}}" class="tag tag-success">共用</text>
                </view>
              </view>
            </view>
          </view>
        </view>
      </block>
      <view wx:else class="empty-hint">暂无数据，请先选择食材</view>
    </block>

    <block wx:if="{{listMode === 'weekly'}}">
      <block wx:if="{{groupedWeeklyItems.length > 0}}">
        <view wx:for="{{groupedWeeklyItems}}" wx:key="category" class="category-card">
          <view class="category-card__title">{{item.category}}</view>
          <view class="category-card__list">
            <view wx:for="{{item.items}}" wx:for-item="row" wx:key="id" class="list-row {{row.checked ? 'is-done' : ''}}">
              <checkbox value="{{row.id}}" checked="{{row.checked}}" bindtap="onCheckWeekly" data-item="{{row}}"/>
              <view class="list-row__body">
                <text class="list-row__name">{{row.name}}</text>
                <text class="list-row__amount">{{row.amount}}</text>
                <view class="list-row__tags">
                  <text wx:if="{{row.isWeeklyCore}}" class="tag tag-warning">本周总计</text>
                </view>
              </view>
            </view>
          </view>
        </view>
      </block>
      <view wx:else class="empty-hint">暂无数据，请先选择食材</view>
    </block>
  </view>

  <view class="fixed-bottom-bar">
    <button class="btn-go-steps" bindtap="goToSteps">食材已买齐，去备菜做饭</button>
  </view>
</view>
