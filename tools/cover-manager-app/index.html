<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å°é¢å›¾ç®¡ç†</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, "PingFang SC", sans-serif; margin: 0; padding: 12px; background: #111; color: #e0e0e0; min-height: 100vh; }
    h1 { font-size: 1.1rem; margin: 0 0 12px 0; }
    .toolbar { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-bottom: 12px; }
    .toolbar button { padding: 8px 14px; border-radius: 8px; border: none; cursor: pointer; font-size: 13px; }
    .toolbar .primary { background: #2563eb; color: #fff; }
    .toolbar .primary:disabled { background: #555; color: #999; cursor: not-allowed; }
    .toolbar .secondary { background: #333; color: #e0e0e0; }
    .toolbar .danger { background: #b91c1c; color: #fff; }
    .status { margin-bottom: 12px; padding: 8px 12px; border-radius: 8px; background: #222; font-size: 13px; min-height: 20px; }
    .status.loading { color: #93c5fd; }
    .status.ok { color: #86efac; }
    .status.err { color: #fca5a5; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; }
    .card { border-radius: 12px; overflow: hidden; background: #1e1e1e; border: 2px solid #333; cursor: pointer; transition: border-color 0.15s; }
    .card.selected { border-color: #2563eb; box-shadow: 0 0 0 2px rgba(37,99,235,0.3); }
    .card .thumb { aspect-ratio: 1; background: #2a2a2a; position: relative; }
    .card .thumb img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .card .thumb input { position: absolute; top: 6px; left: 6px; width: 18px; height: 18px; accent-color: #2563eb; pointer-events: none; }
    .card .thumb .ref-badge { position: absolute; top: 6px; right: 6px; width: 20px; height: 20px; border-radius: 4px; background: #2563eb; color: #fff; font-size: 10px; display: flex; align-items: center; justify-content: center; pointer-events: none; }
    .card .thumb .ref-btn { position: absolute; bottom: 6px; right: 6px; width: 24px; height: 24px; border-radius: 6px; background: rgba(0,0,0,0.6); color: #fff; border: none; cursor: pointer; font-size: 12px; padding: 0; display: flex; align-items: center; justify-content: center; }
    .card .thumb .ref-btn:hover { background: #2563eb; }
    .card .thumb .history-btn { position: absolute; bottom: 6px; left: 6px; padding: 2px 6px; border-radius: 4px; background: rgba(0,0,0,0.6); color: #fff; border: none; cursor: pointer; font-size: 10px; }
    .card .thumb .history-btn:hover { background: #333; }
    .card .thumb .prompt-btn { position: absolute; top: 6px; right: 28px; width: 20px; height: 20px; border-radius: 4px; background: rgba(0,0,0,0.6); color: #fff; border: none; cursor: pointer; font-size: 11px; padding: 0; display: flex; align-items: center; justify-content: center; }
    .card .thumb .prompt-btn:hover { background: #333; }
    .card .name { padding: 8px; font-size: 12px; line-height: 1.3; text-align: center; }
    .card .audit-badge { position: absolute; bottom: 6px; left: 6px; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600; pointer-events: none; }
    .card .audit-badge.pass { background: #166534; color: #bbf7d0; }
    .card .audit-badge.warn { background: #854d0e; color: #fef08a; }
    .card .audit-badge.fail { background: #991b1b; color: #fecaca; }
    .toolbar .filter-group { display: flex; align-items: center; gap: 6px; }
    .toolbar select { padding: 6px 10px; border-radius: 6px; border: 1px solid #444; background: #222; color: #e0e0e0; font-size: 12px; }
    #refModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 200; align-items: center; justify-content: center; }
    #refModal.show { display: flex; }
    #refModal .panel { background: #1e1e1e; padding: 20px; border-radius: 12px; min-width: 320px; max-width: 90vw; }
    #refModal .panel h3 { margin: 0 0 12px 0; font-size: 14px; }
    #refModal .panel input { width: 100%; padding: 8px 10px; border-radius: 6px; border: 1px solid #444; background: #222; color: #e0e0e0; font-size: 13px; margin-bottom: 12px; }
    #refModal .panel .btns { display: flex; gap: 8px; justify-content: flex-end; }
    #refModal .panel button { padding: 8px 14px; border-radius: 8px; border: none; cursor: pointer; font-size: 13px; }
    #refModal .panel .primary { background: #2563eb; color: #fff; }
    #refModal .panel .secondary { background: #333; color: #e0e0e0; }
    #lightbox { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.92); z-index: 100; align-items: center; justify-content: center; cursor: pointer; }
    #lightbox.show { display: flex; }
    #lightbox img { max-width: 92vw; max-height: 92vh; object-fit: contain; }
    .compare-panel { margin-bottom: 16px; padding: 12px; background: #1a1a1a; border-radius: 12px; }
    .compare-panel h3 { margin: 0 0 12px 0; font-size: 14px; }
    .compare-list { display: flex; flex-wrap: wrap; gap: 16px; }
    .compare-item { background: #222; border-radius: 8px; padding: 12px; display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
    .compare-item .imgs { display: flex; gap: 12px; }
    .compare-item .imgs img { width: 100px; height: 100px; object-fit: cover; border-radius: 6px; }
    .compare-item .name { font-weight: 600; min-width: 100px; }
    .compare-item .btns { display: flex; gap: 8px; }
    .compare-item .btns button { padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; font-size: 12px; }
    .compare-item .btns .keep { background: #333; color: #e0e0e0; }
    .compare-item .btns .adopt { background: #166534; color: #bbf7d0; }
    #historyModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 210; align-items: center; justify-content: center; }
    #historyModal.show { display: flex; }
    #historyModal .panel { background: #1e1e1e; padding: 20px; border-radius: 12px; max-width: 90vw; max-height: 80vh; overflow: auto; }
    #historyModal .panel h3 { margin: 0 0 12px 0; font-size: 14px; }
    #historyModal .history-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
    #historyModal .history-item { text-align: center; }
    #historyModal .history-item img { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 8px; }
    #historyModal .history-item button { margin-top: 6px; padding: 4px 10px; font-size: 11px; border-radius: 6px; border: none; cursor: pointer; background: #2563eb; color: #fff; }
    #promptModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 220; align-items: center; justify-content: center; }
    #promptModal.show { display: flex; }
    #promptModal .panel { background: #1e1e1e; padding: 20px; border-radius: 12px; max-width: 600px; max-height: 85vh; overflow: auto; }
    #promptModal .panel h3 { margin: 0 0 12px 0; font-size: 14px; }
    #promptModal .panel textarea { width: 100%; min-height: 60px; padding: 8px; border-radius: 6px; border: 1px solid #444; background: #222; color: #e0e0e0; font-size: 12px; margin-bottom: 8px; resize: vertical; }
    #promptModal .panel .btns { display: flex; gap: 8px; justify-content: flex-end; margin-top: 12px; }
  </style>
</head>
<body>
  <h1>å°é¢å›¾ç®¡ç†</h1>
  <div class="toolbar">
    <button type="button" class="secondary" id="btnRefresh" title="é‡æ–°åŠ è½½èœè°±åˆ—è¡¨ï¼Œæ˜¾ç¤ºæœ€æ–°å…¥åº“çš„èœè°±">ğŸ”„ åˆ·æ–°</button>
    <button type="button" class="secondary" id="btnSelectAll">å…¨é€‰</button>
    <button type="button" class="secondary" id="btnSelectNone">å–æ¶ˆå…¨é€‰</button>
    <button type="button" class="secondary" id="btnSelectFail" title="å‹¾é€‰æ‰€æœ‰å®¡è®¡ä¸º Fail çš„é¡¹">ä¸€é”®é€‰ä¸­ Fail</button>
    <button type="button" class="secondary" id="btnAudit" title="å¯¹é€‰ä¸­é¡¹æˆ–å…¨éƒ¨è¿è¡Œ Kimi å®¡è®¡">è¿è¡Œå®¡è®¡</button>
    <button type="button" class="secondary" id="btnSortWorst" title="æŒ‰è¯„åˆ†ä»ä½åˆ°é«˜æ’åº">æŒ‰æœ€å·®æ’åº</button>
    <div class="filter-group">
      <label for="verdictFilter">ç­›é€‰:</label>
      <select id="verdictFilter">
        <option value="all">å…¨éƒ¨</option>
        <option value="pass">Pass</option>
        <option value="warn">Warn</option>
        <option value="fail">Fail</option>
      </select>
    </div>
    <button type="button" class="secondary" id="btnRegenOnly" title="ä»…é‡ç”Ÿæˆï¼Œä¿å­˜ä¸ºå€™é€‰å›¾ï¼Œå¯åœ¨ä¸‹æ–¹å¯¹æ¯”åé€‰æ‹©é‡‡ç”¨æˆ–ä¸¢å¼ƒ">ä»…é‡ç”Ÿæˆï¼ˆå­˜ä¸ºå€™é€‰ï¼‰</button>
    <button type="button" class="primary" id="btnRegenUpload" title="å…ˆé‡ç”Ÿæˆé€‰ä¸­å›¾ç‰‡ï¼Œå®Œæˆåè‡ªåŠ¨ä¸Šä¼ åˆ°äº‘ç«¯">é‡ç”Ÿæˆå¹¶ä¸Šä¼ é€‰ä¸­</button>
    <button type="button" class="secondary" id="btnSmartOptimize" title="å®¡è®¡å…¨éƒ¨ â†’ è‡ªåŠ¨ç­›é€‰ Fail â†’ æ‰¹é‡é‡ç”Ÿæˆå€™é€‰ â†’ è¯·åˆ°å¾…å¯¹æ¯”ç¡®è®¤">æ™ºèƒ½ä¼˜åŒ–</button>
  </div>
  <div class="status" id="status">åŠ è½½ä¸­â€¦</div>
  <div id="comparePanel" class="compare-panel" style="display: none;">
    <h3>å¾…å¯¹æ¯”ï¼ˆ<span id="compareCount">0</span>ï¼‰ <button type="button" class="secondary" id="btnAdoptAll" style="margin-left:8px;padding:4px 10px;font-size:12px;">å…¨éƒ¨é‡‡ç”¨æ–°å›¾</button></h3>
    <div id="compareList" class="compare-list"></div>
  </div>
  <div class="grid" id="grid"></div>
  <div id="lightbox"><img src="" alt="" /></div>
  <div id="refModal">
    <div class="panel">
      <h3 id="refModalTitle">å‚è€ƒå›¾ URL</h3>
      <input type="url" id="refUrlInput" placeholder="ç²˜è´´å›¾ç‰‡åœ°å€ (https://...)" />
      <div class="btns">
        <button type="button" class="secondary" id="refModalClear">æ¸…é™¤</button>
        <button type="button" class="primary" id="refModalSave">ä¿å­˜</button>
      </div>
    </div>
  </div>
  <div id="historyModal">
    <div class="panel">
      <h3 id="historyModalTitle">å†å²ç‰ˆæœ¬</h3>
      <div id="historyList" class="history-grid"></div>
    </div>
  </div>
  <div id="promptModal">
    <div class="panel">
      <h3 id="promptModalTitle">ç¼–è¾‘ Prompt</h3>
      <label>æ¨¡æ¿ Aï¼ˆä¿¯æ‹ï¼‰</label>
      <textarea id="promptInput0" rows="2"></textarea>
      <label>æ¨¡æ¿ Bï¼ˆ45Â°ï¼‰</label>
      <textarea id="promptInput1" rows="2"></textarea>
      <label>æ¨¡æ¿ Cï¼ˆè¿‘æ™¯ï¼‰</label>
      <textarea id="promptInput2" rows="2"></textarea>
      <div class="btns">
        <button type="button" class="secondary" id="promptModalSave">ä¿å­˜</button>
        <button type="button" class="primary" id="promptModalRegen">ä¿å­˜å¹¶é‡ç”Ÿæˆ</button>
      </div>
    </div>
  </div>

  <script>
    const statusEl = document.getElementById('status');
    const gridEl = document.getElementById('grid');
    const btnRegenUpload = document.getElementById('btnRegenUpload');
    const btnSelectAll = document.getElementById('btnSelectAll');
    const btnSelectNone = document.getElementById('btnSelectNone');

    let recipes = [];
    const selected = new Set();
    let currentRefRecipe = null;
    let currentPromptRecipe = null;
    let filterVerdict = 'all';
    let sortOrder = 'default';

    function setStatus(msg, type) {
      statusEl.textContent = msg;
      statusEl.className = 'status ' + (type || '');
    }

    async function fetchRecipes() {
      const res = await fetch('/api/recipes');
      const json = await res.json();
      if (!json.ok) throw new Error(json.error || 'åŠ è½½å¤±è´¥');
      return json.data;
    }

    function getBaseName(slug) {
      return (slug || '').replace(/\.(png|jpg|jpeg)$/i, '');
    }

    function renderComparePanel() {
      const withCandidate = recipes.filter((r) => r.hasCandidate);
      const panel = document.getElementById('comparePanel');
      const listEl = document.getElementById('compareList');
      const countEl = document.getElementById('compareCount');
      if (withCandidate.length === 0) {
        panel.style.display = 'none';
        return;
      }
      panel.style.display = 'block';
      countEl.textContent = withCandidate.length;
      listEl.innerHTML = withCandidate.map((r) => {
        const baseName = getBaseName(r.slug);
        const currentImg = r.imageUrl + '?t=' + (r._ts || 0);
        const candidateImg = '/images/candidates/' + baseName + '.jpg?t=' + Date.now();
        const nameEsc = r.dishName.replace(/</g, '&lt;').replace(/"/g, '&quot;');
        return `
          <div class="compare-item" data-dish="${nameEsc}">
            <span class="name">${nameEsc}</span>
            <div class="imgs">
              <img src="${currentImg}" alt="å½“å‰" title="å½“å‰å°é¢" />
              <img src="${candidateImg}" alt="å€™é€‰" title="å€™é€‰æ–°å›¾" />
            </div>
            <div class="btns">
              <button type="button" class="keep" data-action="discard">ä¿ç•™æ—§å›¾</button>
              <button type="button" class="adopt" data-action="adopt">é‡‡ç”¨æ–°å›¾</button>
            </div>
          </div>`;
      }).join('');

      listEl.querySelectorAll('.compare-item .btns button').forEach((btn) => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          const item = btn.closest('.compare-item');
          const dishName = item.dataset.dish;
          const action = btn.dataset.action;
          if (!dishName) return;
          const api = action === 'adopt' ? '/api/adopt' : '/api/discard';
          setStatus(action === 'adopt' ? 'æ­£åœ¨é‡‡ç”¨æ–°å›¾å¹¶ä¸Šä¼ â€¦' : 'æ­£åœ¨ä¸¢å¼ƒå€™é€‰å›¾â€¦', 'loading');
          try {
            const res = await fetch(api, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ dishNames: [dishName] }),
            });
            const json = await res.json();
            if (!json.ok) {
              setStatus('æ“ä½œå¤±è´¥: ' + (json.error || 'æœªçŸ¥é”™è¯¯'), 'err');
              return;
            }
            const r = recipes.find((x) => x.dishName === dishName);
            if (r) r._ts = Date.now();
            recipes = await fetchRecipes();
            renderComparePanel();
            renderGrid();
            setStatus(action === 'adopt' ? 'å·²é‡‡ç”¨æ–°å›¾å¹¶ä¸Šä¼ ' : 'å·²ä¸¢å¼ƒå€™é€‰å›¾', 'ok');
          } catch (err) {
            setStatus('è¯·æ±‚å¤±è´¥: ' + err.message, 'err');
          }
        });
      });
    }

    function getDisplayRecipes() {
      let list = recipes;
      if (filterVerdict !== 'all') {
        list = list.filter((r) => r.audit && r.audit.verdict === filterVerdict);
      }
      if (sortOrder === 'worst') {
        list = [...list].sort((a, b) => (a.audit?.overall ?? 999) - (b.audit?.overall ?? 999));
      }
      return list;
    }

    let lastDisplayRecipes = [];

    function renderGrid() {
      lastDisplayRecipes = getDisplayRecipes();
      gridEl.innerHTML = lastDisplayRecipes.map((r, i) => {
        const id = r.dishName;
        const checked = selected.has(id);
        const imgUrl = r.imageUrl + '?t=' + (r._ts || 0);
        const baseName = getBaseName(r.slug);
        const hasRef = !!(r.refImageUrl && r.refImageUrl.trim());
        const audit = r.audit;
        const auditBadge = audit ? `<span class="audit-badge ${audit.verdict}" title="overall ${audit.overall}">${audit.verdict} ${audit.overall}</span>` : '';
        return `
          <div class="card ${checked ? 'selected' : ''}" data-index="${i}" data-dish="${id.replace(/"/g, '&quot;')}">
            <div class="thumb">
              <input type="checkbox" ${checked ? 'checked' : ''} />
              ${hasRef ? '<span class="ref-badge" title="å·²è®¾å‚è€ƒå›¾">ğŸ“·</span>' : ''}
              <button type="button" class="prompt-btn" title="ç¼–è¾‘ Prompt" data-index="${i}">P</button>
              ${auditBadge}
              <button type="button" class="history-btn" title="å†å²ç‰ˆæœ¬" data-index="${i}">å†å²</button>
              <button type="button" class="ref-btn" title="è®¾ç½®å‚è€ƒå›¾ URL" data-index="${i}">ğŸ“·</button>
              <img src="${imgUrl}" alt="${id.replace(/"/g, '&quot;')}" loading="lazy" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Crect fill=%22%23333%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%22 y=%2250%22 fill=%22%23999%22 text-anchor=%22middle%22 dy=%22.3em%22%3Eæ— å›¾%3C/text%3E%3C/svg%3E'" />
            </div>
            <div class="name">${id.replace(/</g, '&lt;')}</div>
          </div>`;
      }).join('');

      gridEl.querySelectorAll('.card').forEach((el) => {
        el.addEventListener('click', (e) => {
          if (e.target.closest('.ref-btn') || e.target.closest('.history-btn') || e.target.closest('.prompt-btn')) return;
          const idx = parseInt(el.dataset.index, 10);
          const r = lastDisplayRecipes[idx];
          const name = r?.dishName;
          if (!name) return;
          if (selected.has(name)) selected.delete(name);
          else selected.add(name);
          el.classList.toggle('selected', selected.has(name));
          el.querySelector('input').checked = selected.has(name);
        });
      });

      gridEl.querySelectorAll('.card .thumb img').forEach((img) => {
        img.addEventListener('dblclick', (e) => {
          e.preventDefault();
          e.stopPropagation();
          document.getElementById('lightbox').querySelector('img').src = img.src;
          document.getElementById('lightbox').classList.add('show');
        });
      });

      gridEl.querySelectorAll('.card .thumb .ref-btn').forEach((btn) => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          const idx = parseInt(btn.dataset.index, 10);
          const r = lastDisplayRecipes[idx];
          if (!r) return;
          currentRefRecipe = { dishName: r.dishName, slug: r.slug, baseName: getBaseName(r.slug) };
          document.getElementById('refModalTitle').textContent = 'å‚è€ƒå›¾ URL Â· ' + r.dishName;
          document.getElementById('refUrlInput').value = r.refImageUrl || '';
          document.getElementById('refModal').classList.add('show');
          document.getElementById('refUrlInput').focus();
        });
      });

      gridEl.querySelectorAll('.card .thumb .history-btn').forEach((btn) => {
        btn.addEventListener('click', async (e) => {
          e.preventDefault();
          e.stopPropagation();
          const idx = parseInt(btn.dataset.index, 10);
          const r = lastDisplayRecipes[idx];
          if (!r) return;
          const baseName = getBaseName(r.slug);
          document.getElementById('historyModalTitle').textContent = 'å†å²ç‰ˆæœ¬ Â· ' + r.dishName;
          document.getElementById('historyModal').classList.add('show');
          document.getElementById('historyList').innerHTML = 'åŠ è½½ä¸­â€¦';
          try {
            const res = await fetch('/api/history/' + encodeURIComponent(baseName));
            const json = await res.json();
            if (!json.ok || !Array.isArray(json.data)) {
              document.getElementById('historyList').innerHTML = 'æ— å†å²è®°å½•';
              return;
            }
            const list = json.data;
            if (list.length === 0) {
              document.getElementById('historyList').innerHTML = 'æ— å†å²è®°å½•';
              return;
            }
            document.getElementById('historyList').innerHTML = list.map((item) => {
              const date = new Date(item.timestamp);
              const dateStr = date.toLocaleString('zh-CN');
              return `
                <div class="history-item">
                  <img src="/images/history/${item.filename}" alt="${dateStr}" />
                  <div>${dateStr}</div>
                  <button type="button" data-ts="${item.timestamp}">æ¢å¤</button>
                </div>`;
            }).join('');
            document.getElementById('historyList').querySelectorAll('button').forEach((b) => {
              b.addEventListener('click', async () => {
                const ts = b.dataset.ts;
                setStatus('æ­£åœ¨æ¢å¤å¹¶ä¸Šä¼ â€¦', 'loading');
                try {
                  const restoreRes = await fetch('/api/restore', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ dishName: r.dishName, timestamp: parseInt(ts, 10) }),
                  });
                  const restoreJson = await restoreRes.json();
                  if (!restoreJson.ok) {
                    setStatus('æ¢å¤å¤±è´¥: ' + (restoreJson.error || ''), 'err');
                    return;
                  }
                  const rec = recipes.find((x) => x.dishName === r.dishName);
                  if (rec) rec._ts = Date.now();
                  document.getElementById('historyModal').classList.remove('show');
                  recipes = await fetchRecipes();
                  renderGrid();
                  renderComparePanel();
                  setStatus('å·²æ¢å¤å¹¶ä¸Šä¼ ', 'ok');
                } catch (err) {
                  setStatus('è¯·æ±‚å¤±è´¥: ' + err.message, 'err');
                }
              });
            });
          } catch (err) {
            document.getElementById('historyList').innerHTML = 'åŠ è½½å¤±è´¥: ' + err.message;
          }
        });
      });

      gridEl.querySelectorAll('.card .thumb .prompt-btn').forEach((btn) => {
        btn.addEventListener('click', async (e) => {
          e.preventDefault();
          e.stopPropagation();
          const idx = parseInt(btn.dataset.index, 10);
          const r = lastDisplayRecipes[idx];
          if (!r) return;
          currentPromptRecipe = { dishName: r.dishName, baseName: getBaseName(r.slug) };
          document.getElementById('promptModalTitle').textContent = 'ç¼–è¾‘ Prompt Â· ' + r.dishName;
          document.getElementById('promptModal').classList.add('show');
          document.getElementById('promptInput0').value = '';
          document.getElementById('promptInput1').value = '';
          document.getElementById('promptInput2').value = '';
          try {
            const res = await fetch('/api/prompts/' + encodeURIComponent(currentPromptRecipe.baseName));
            const json = await res.json();
            if (json.ok && Array.isArray(json.prompts)) {
              document.getElementById('promptInput0').value = json.prompts[0] || '';
              document.getElementById('promptInput1').value = json.prompts[1] || '';
              document.getElementById('promptInput2').value = json.prompts[2] || '';
            }
          } catch (err) {
            setStatus('åŠ è½½ Prompt å¤±è´¥: ' + err.message, 'err');
          }
        });
      });
    }

    document.getElementById('promptModal').addEventListener('click', function (e) {
      if (e.target === this) this.classList.remove('show');
    });
    document.getElementById('promptModalSave').addEventListener('click', async () => {
      if (!currentPromptRecipe) return;
      const prompts = [
        document.getElementById('promptInput0').value.trim(),
        document.getElementById('promptInput1').value.trim(),
        document.getElementById('promptInput2').value.trim(),
      ].filter(Boolean);
      if (prompts.length === 0) {
        setStatus('è¯·è‡³å°‘å¡«å†™ä¸€æ¡ Prompt', 'err');
        return;
      }
      try {
        const res = await fetch('/api/custom-prompts', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ baseName: currentPromptRecipe.baseName, prompts }),
        });
        const json = await res.json();
        if (!json.ok) throw new Error(json.error || 'ä¿å­˜å¤±è´¥');
        document.getElementById('promptModal').classList.remove('show');
        setStatus('å·²ä¿å­˜è‡ªå®šä¹‰ Prompt', 'ok');
      } catch (e) {
        setStatus('ä¿å­˜å¤±è´¥: ' + e.message, 'err');
      }
    });
    document.getElementById('promptModalRegen').addEventListener('click', async () => {
      if (!currentPromptRecipe) return;
      const prompts = [
        document.getElementById('promptInput0').value.trim(),
        document.getElementById('promptInput1').value.trim(),
        document.getElementById('promptInput2').value.trim(),
      ].filter(Boolean);
      if (prompts.length === 0) {
        setStatus('è¯·è‡³å°‘å¡«å†™ä¸€æ¡ Prompt', 'err');
        return;
      }
      try {
        await fetch('/api/custom-prompts', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ baseName: currentPromptRecipe.baseName, prompts }),
        });
        document.getElementById('promptModal').classList.remove('show');
        setStatus('æ­£åœ¨é‡ç”Ÿæˆâ€¦', 'loading');
        const regenRes = await fetch('/api/regen', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ dishNames: [currentPromptRecipe.dishName] }),
        });
        const regenJson = await regenRes.json();
        if (!regenJson.ok) {
          setStatus('é‡ç”Ÿæˆå¤±è´¥: ' + (regenJson.error || ''), 'err');
          return;
        }
        recipes = await fetchRecipes();
        const r = recipes.find((x) => x.dishName === currentPromptRecipe.dishName);
        if (r) r._ts = Date.now();
        renderGrid();
        renderComparePanel();
        setStatus('å·²ä¿å­˜å¹¶é‡ç”Ÿæˆ', 'ok');
      } catch (e) {
        setStatus('å¤±è´¥: ' + e.message, 'err');
      }
    });

    async function saveRefImages(merged) {
      const res = await fetch('/api/ref-images', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ data: merged }),
      });
      const json = await res.json();
      if (!json.ok) throw new Error(json.error || 'ä¿å­˜å¤±è´¥');
    }

    document.getElementById('refModal').addEventListener('click', function (e) {
      if (e.target === this) this.classList.remove('show');
    });
    document.getElementById('historyModal').addEventListener('click', function (e) {
      if (e.target === this) this.classList.remove('show');
    });
    document.getElementById('refModalSave').addEventListener('click', async () => {
      const input = document.getElementById('refUrlInput');
      const url = (input.value || '').trim();
      if (!currentRefRecipe) return;
      const baseName = currentRefRecipe.baseName;
      try {
        const getRes = await fetch('/api/ref-images');
        const getJson = await getRes.json();
        const data = getJson.ok ? (getJson.data || {}) : {};
        if (url) data[baseName] = url;
        else delete data[baseName];
        await saveRefImages(data);
        document.getElementById('refModal').classList.remove('show');
        recipes = await fetchRecipes();
        renderGrid();
        setStatus(url ? 'å·²ä¿å­˜å‚è€ƒå›¾ URL' : 'å·²æ¸…é™¤å‚è€ƒå›¾', 'ok');
      } catch (e) {
        setStatus('ä¿å­˜å¤±è´¥: ' + e.message, 'err');
      }
    });
    document.getElementById('refModalClear').addEventListener('click', async () => {
      document.getElementById('refUrlInput').value = '';
      if (!currentRefRecipe) return;
      const baseName = currentRefRecipe.baseName;
      try {
        const getRes = await fetch('/api/ref-images');
        const getJson = await getRes.json();
        const data = getJson.ok ? (getJson.data || {}) : {};
        delete data[baseName];
        await saveRefImages(data);
        document.getElementById('refModal').classList.remove('show');
        recipes = await fetchRecipes();
        renderGrid();
        setStatus('å·²æ¸…é™¤å‚è€ƒå›¾', 'ok');
      } catch (e) {
        setStatus('æ¸…é™¤å¤±è´¥: ' + e.message, 'err');
      }
    });

    document.getElementById('lightbox').addEventListener('click', function () {
      this.classList.remove('show');
    });

    document.getElementById('btnRefresh').addEventListener('click', async () => {
      const btn = document.getElementById('btnRefresh');
      btn.disabled = true;
      setStatus('æ­£åœ¨åˆ·æ–°â€¦', 'loading');
      try {
        recipes = await fetchRecipes();
        renderGrid();
        renderComparePanel();
        setStatus(`å·²åˆ·æ–°ï¼Œå…± ${recipes.length} é“æˆäººèœå°é¢ã€‚`, 'ok');
      } catch (e) {
        setStatus('åˆ·æ–°å¤±è´¥: ' + e.message, 'err');
      }
      btn.disabled = false;
    });

    btnSelectAll.addEventListener('click', () => {
      recipes.forEach((r) => selected.add(r.dishName));
      renderGrid();
    });
    btnSelectNone.addEventListener('click', () => {
      selected.clear();
      renderGrid();
    });
    document.getElementById('btnSelectFail').addEventListener('click', () => {
      selected.clear();
      recipes.forEach((r) => {
        if (r.audit && r.audit.verdict === 'fail') selected.add(r.dishName);
      });
      renderGrid();
      setStatus(`å·²å‹¾é€‰ ${selected.size} é¡¹ Fail`, 'ok');
    });
    document.getElementById('btnAudit').addEventListener('click', async () => {
      const list = Array.from(selected);
      const body = list.length > 0 ? { dishNames: list } : {};
      document.getElementById('btnAudit').disabled = true;
      setStatus(list.length ? `æ­£åœ¨å®¡è®¡é€‰ä¸­çš„ ${list.length} å¼ â€¦` : 'æ­£åœ¨å®¡è®¡å…¨éƒ¨å°é¢â€¦', 'loading');
      try {
        const res = await fetch('/api/audit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });
        const json = await res.json();
        if (!json.ok) {
          setStatus('å®¡è®¡å¤±è´¥: ' + (json.error || 'æœªçŸ¥é”™è¯¯'), 'err');
          document.getElementById('btnAudit').disabled = false;
          return;
        }
        recipes = await fetchRecipes();
        renderGrid();
        setStatus(`å®¡è®¡å®Œæˆï¼Œå·²æ›´æ–° ${(json.results || []).length} æ¡ç»“æœã€‚`, 'ok');
      } catch (e) {
        setStatus('å®¡è®¡è¯·æ±‚å¤±è´¥: ' + e.message, 'err');
      }
      document.getElementById('btnAudit').disabled = false;
    });
    document.getElementById('btnSortWorst').addEventListener('click', () => {
      sortOrder = sortOrder === 'worst' ? 'default' : 'worst';
      document.getElementById('btnSortWorst').textContent = sortOrder === 'worst' ? 'æ¢å¤é»˜è®¤æ’åº' : 'æŒ‰æœ€å·®æ’åº';
      renderGrid();
    });
    document.getElementById('verdictFilter').addEventListener('change', (e) => {
      filterVerdict = e.target.value;
      renderGrid();
    });

    async function regenThenUpload() {
      const list = Array.from(selected);
      if (list.length === 0) {
        setStatus('è¯·å…ˆå‹¾é€‰è¦å¤„ç†çš„èœè°±', 'err');
        return;
      }
      btnRegenUpload.disabled = true;
      const useStream = list.length > 1;
      if (useStream) {
        setStatus(`[0/${list.length}] å‡†å¤‡ä¸­â€¦`, 'loading');
      } else {
        setStatus(`æ­£åœ¨é‡ç”Ÿæˆ 1 å¼ â€¦`, 'loading');
      }

      try {
        const body = { dishNames: list };
        if (useStream) body.streamProgress = true;
        const regenRes = await fetch('/api/regen', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });
        const regenJson = await regenRes.json();
        if (!regenJson.ok) {
          setStatus('é‡ç”Ÿæˆå¤±è´¥: ' + (regenJson.error || 'æœªçŸ¥é”™è¯¯'), 'err');
          btnRegenUpload.disabled = false;
          return;
        }
        let okRegen = [];
        let failedRegen = [];
        if (regenJson.jobId) {
          await new Promise((resolve, reject) => {
            const es = new EventSource('/api/regen/stream?jobId=' + encodeURIComponent(regenJson.jobId));
            es.onmessage = (e) => {
              const data = JSON.parse(e.data);
              if (data.type === 'progress') {
                setStatus(`[${data.done}/${data.total}] æ­£åœ¨ç”Ÿæˆï¼š${data.currentDish || 'â€¦'}${data.error ? ' å¤±è´¥' : ''}`, 'loading');
              }
              if (data.type === 'done') {
                okRegen = data.ok || [];
                failedRegen = data.failed || [];
                es.close();
                resolve();
              }
            };
            es.onerror = () => {
              es.close();
              reject(new Error('Stream æ–­å¼€'));
            };
          });
        } else {
          okRegen = regenJson.ok || [];
          failedRegen = regenJson.failed || [];
        }
        if (failedRegen.length) {
          setStatus(`é‡ç”Ÿæˆå®Œæˆï¼šæˆåŠŸ ${okRegen.length}ï¼Œå¤±è´¥ ${failedRegen.length}ï¼ˆ${failedRegen.map((f) => f.dishName + ': ' + f.error).join('; ')}ï¼‰`, 'err');
        }
        if (okRegen.length === 0) {
          btnRegenUpload.disabled = false;
          return;
        }

        setStatus(`é‡ç”Ÿæˆå®Œæˆï¼Œæ­£åœ¨ä¸Šä¼  ${okRegen.length} å¼ åˆ°äº‘ç«¯â€¦`, 'loading');
        const uploadRes = await fetch('/api/upload', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ dishNames: okRegen }),
        });
        const uploadJson = await uploadRes.json();
        if (!uploadJson.ok) {
          setStatus('ä¸Šä¼ å¤±è´¥: ' + (uploadJson.error || 'æœªçŸ¥é”™è¯¯'), 'err');
          btnRegenUpload.disabled = false;
          return;
        }
        const okUpload = uploadJson.ok || [];
        const failedUpload = uploadJson.failed || [];
        okUpload.forEach((name) => {
          const r = recipes.find((x) => x.dishName === name);
          if (r) r._ts = Date.now();
        });
        selected.clear();
        renderGrid();
        if (failedUpload.length) {
          setStatus(`å®Œæˆã€‚ä¸Šä¼ æˆåŠŸ ${okUpload.length}ï¼Œå¤±è´¥ ${failedUpload.length}ï¼š${failedUpload.map((f) => f.dishName).join('ã€')}`, 'err');
        } else {
          setStatus(`å·²é‡ç”Ÿæˆå¹¶ä¸Šä¼  ${okUpload.length} å¼ ï¼Œé¡µé¢å›¾ç‰‡å·²åˆ·æ–°ã€‚`, 'ok');
        }
      } catch (e) {
        setStatus('è¯·æ±‚å¤±è´¥: ' + e.message, 'err');
      }
      btnRegenUpload.disabled = false;
    }

    btnRegenUpload.addEventListener('click', regenThenUpload);

    document.getElementById('btnRegenOnly').addEventListener('click', async () => {
      const list = Array.from(selected);
      if (list.length === 0) {
        setStatus('è¯·å…ˆå‹¾é€‰è¦é‡ç”Ÿæˆçš„èœè°±', 'err');
        return;
      }
      const btn = document.getElementById('btnRegenOnly');
      btn.disabled = true;
      const useStream = list.length > 1;
      if (useStream) setStatus(`[0/${list.length}] å‡†å¤‡ä¸­â€¦`, 'loading');
      else setStatus('æ­£åœ¨é‡ç”Ÿæˆ 1 å¼ ï¼ˆå­˜ä¸ºå€™é€‰ï¼‰â€¦', 'loading');
      try {
        const body = { dishNames: list, saveAsCandidate: true };
        if (useStream) body.streamProgress = true;
        const regenRes = await fetch('/api/regen', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });
        const regenJson = await regenRes.json();
        if (!regenJson.ok) {
          setStatus('é‡ç”Ÿæˆå¤±è´¥: ' + (regenJson.error || 'æœªçŸ¥é”™è¯¯'), 'err');
          btn.disabled = false;
          return;
        }
        let okRegen = [];
        if (regenJson.jobId) {
          await new Promise((resolve, reject) => {
            const es = new EventSource('/api/regen/stream?jobId=' + encodeURIComponent(regenJson.jobId));
            es.onmessage = (e) => {
              const data = JSON.parse(e.data);
              if (data.type === 'progress') {
                setStatus(`[${data.done}/${data.total}] æ­£åœ¨ç”Ÿæˆï¼š${data.currentDish || 'â€¦'}`, 'loading');
              }
              if (data.type === 'done') {
                okRegen = data.ok || [];
                es.close();
                resolve();
              }
            };
            es.onerror = () => { es.close(); reject(new Error('Stream æ–­å¼€')); };
          });
        } else {
          okRegen = regenJson.ok || [];
        }
        recipes = await fetchRecipes();
        renderComparePanel();
        renderGrid();
        setStatus(`å·²ç”Ÿæˆ ${okRegen.length} å¼ å€™é€‰å›¾ï¼Œè¯·åœ¨ã€Œå¾…å¯¹æ¯”ã€ä¸­é€‰æ‹©é‡‡ç”¨æˆ–ä¿ç•™æ—§å›¾ã€‚`, 'ok');
      } catch (e) {
        setStatus('è¯·æ±‚å¤±è´¥: ' + e.message, 'err');
      }
      btn.disabled = false;
    });

    document.getElementById('btnSmartOptimize').addEventListener('click', async () => {
      const btn = document.getElementById('btnSmartOptimize');
      btn.disabled = true;
      setStatus('æ­£åœ¨å®¡è®¡å…¨éƒ¨å°é¢â€¦', 'loading');
      try {
        const auditRes = await fetch('/api/audit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({}),
        });
        const auditJson = await auditRes.json();
        if (!auditJson.ok || !Array.isArray(auditJson.results)) {
          setStatus('å®¡è®¡å¤±è´¥: ' + (auditJson.error || 'æœªçŸ¥é”™è¯¯'), 'err');
          btn.disabled = false;
          return;
        }
        const failList = auditJson.results.filter((r) => r.verdict === 'fail').map((r) => r.dishName);
        if (failList.length === 0) {
          setStatus('æ²¡æœ‰éœ€è¦ä¼˜åŒ–çš„é¡¹ï¼ˆæ—  Failï¼‰', 'ok');
          recipes = await fetchRecipes();
          renderGrid();
          renderComparePanel();
          btn.disabled = false;
          return;
        }
        setStatus(`å‘ç° ${failList.length} é¡¹ Failï¼Œæ­£åœ¨é‡ç”Ÿæˆå€™é€‰å›¾â€¦`, 'loading');
        const body = { dishNames: failList, saveAsCandidate: true };
        if (failList.length > 1) body.streamProgress = true;
        const regenRes = await fetch('/api/regen', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });
        const regenJson = await regenRes.json();
        if (!regenJson.ok) {
          setStatus('é‡ç”Ÿæˆå¤±è´¥: ' + (regenJson.error || 'æœªçŸ¥é”™è¯¯'), 'err');
          btn.disabled = false;
          return;
        }
        let okRegen = [];
        if (regenJson.jobId) {
          await new Promise((resolve, reject) => {
            const es = new EventSource('/api/regen/stream?jobId=' + encodeURIComponent(regenJson.jobId));
            es.onmessage = (e) => {
              const data = JSON.parse(e.data);
              if (data.type === 'progress') {
                setStatus(`[${data.done}/${data.total}] æ­£åœ¨ç”Ÿæˆï¼š${data.currentDish || 'â€¦'}`, 'loading');
              }
              if (data.type === 'done') {
                okRegen = data.ok || [];
                es.close();
                resolve();
              }
            };
            es.onerror = () => { es.close(); reject(new Error('Stream æ–­å¼€')); };
          });
        } else {
          okRegen = regenJson.ok || [];
        }
        recipes = await fetchRecipes();
        renderComparePanel();
        renderGrid();
        setStatus(`æ™ºèƒ½ä¼˜åŒ–å®Œæˆã€‚å·²åœ¨ã€Œå¾…å¯¹æ¯”ã€ä¸­ç”Ÿæˆ ${okRegen.length} å¼ å€™é€‰å›¾ï¼Œè¯·é€å¼ ç¡®è®¤é‡‡ç”¨æˆ–ä¿ç•™æ—§å›¾ã€‚`, 'ok');
      } catch (e) {
        setStatus('æ™ºèƒ½ä¼˜åŒ–å¤±è´¥: ' + e.message, 'err');
      }
      btn.disabled = false;
    });

    document.getElementById('comparePanel').addEventListener('click', async (e) => {
      if (e.target.id !== 'btnAdoptAll') return;
      const names = recipes.filter((r) => r.hasCandidate).map((r) => r.dishName);
      if (names.length === 0) return;
      e.target.disabled = true;
      setStatus(`æ­£åœ¨é‡‡ç”¨ ${names.length} å¼ æ–°å›¾å¹¶ä¸Šä¼ â€¦`, 'loading');
      try {
        const res = await fetch('/api/adopt', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ dishNames: names }),
        });
        const json = await res.json();
        if (!json.ok) {
          setStatus('æ“ä½œå¤±è´¥: ' + (json.error || 'æœªçŸ¥é”™è¯¯'), 'err');
          e.target.disabled = false;
          return;
        }
        recipes = await fetchRecipes();
        renderComparePanel();
        renderGrid();
        setStatus(`å·²å…¨éƒ¨é‡‡ç”¨å¹¶ä¸Šä¼  ${(json.ok || []).length} å¼ ã€‚`, 'ok');
      } catch (err) {
        setStatus('è¯·æ±‚å¤±è´¥: ' + err.message, 'err');
      }
      e.target.disabled = false;
    });

    (async function init() {
      try {
        recipes = await fetchRecipes();
        setStatus(`å…± ${recipes.length} é“æˆäººèœå°é¢ã€‚å•å‡»å¡ç‰‡å‹¾é€‰ï¼ŒåŒå‡»å›¾ç‰‡æ”¾å¤§ï¼›å‹¾é€‰åç‚¹ã€Œé‡ç”Ÿæˆå¹¶ä¸Šä¼ é€‰ä¸­ã€æˆ–ã€Œä»…é‡ç”Ÿæˆã€å­˜ä¸ºå€™é€‰å¯¹æ¯”ã€‚`, 'ok');
        renderGrid();
        renderComparePanel();
      } catch (e) {
        setStatus('åŠ è½½å¤±è´¥: ' + e.message, 'err');
      }
    })();
  </script>
</body>
</html>
