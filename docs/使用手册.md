# TableSync 下厨房交叉融合爬虫 · 使用手册

本手册说明如何用「缺口分析 → 爬取融合 → 草稿审批」流水线，让菜谱库在本地/云端自动生长，并配合 Recipe Manager 网页端做主厨级审批。

---

## 一、设计思路（Fusion Pipeline）

- **传统爬虫**：抓下来的步骤和用量往往不一致，直接入库会导致时间轴和步骤逻辑混乱。
- **本方案**：**AI 交叉审校（Cross-Validation）**  
  1. 用 **batch-planner** 算出当前最缺的维度（如：羊肉 × 蒸/凉 × 酸爽）。  
  2. 用 **recipe-crawler** 在下厨房、豆果、美食杰等站抓取该方向下排名靠前的多份做法。  
  3. 用 **LLM 融合**：比对多份做法，剔除偏方，提取共识，并强制把步骤拆成 **prep（备菜）** 和 **cook（开火）**。  
  4. 输出符合 TableSync 规范的 JSON，先入 **草稿箱**，经网页端 **Approve** 后再正式入库。

这样既保证「各地风味」的来源多样，又保证入库内容结构统一、可被时间轴与步骤页正确使用。

---

## 二、环境与依赖

- **Node.js**：建议 18+，项目 `tools/` 使用 ES Modules。
- **配置**：在 `tools/.env` 中配置 LLM（二选一或按需）：
  - `ANTHROPIC_API_KEY`（Claude）
  - `MINIMAX_API_KEY`（MiniMax，当前默认）
- **可选**：云端入库需配置腾讯云开发 TCB（`TCB_ENV_ID`、`TCB_SECRET_ID`、`TCB_SECRET_KEY`）。

安装依赖（在项目根目录或 `tools/` 下）：

```bash
cd tools && npm install
```

---

## 三、命令行使用

所有命令均在 **`tools/`** 目录下执行（或通过 `npm run` 调用）。

### 1. 缺口分析（batch-planner）

先看当前库在「肉 × 口味 × 风味」矩阵里缺什么：

```bash
npm run plan              # 本地 recipes.js 分析 + 报告
npm run plan -- --cloud   # 用云端数据做分析
npm run plan:gen          # 输出可执行的 generate 命令
npm run plan:json         # 输出 JSON（gaps、batches）
npm run plan:baby         # 聚焦宝宝菜缺口
npm run plan:cook         # 聚焦烹饪方式（如空气炸锅、蒸）缺口
```

输出中的「高优先级空白」即可作为融合目标（如：羊肉 蒸/凉 酸爽）。

### 2. 融合爬虫（recipe-fusion-spider）

**批量融合（按缺口自动取前 N 道）**

```bash
npm run auto-grow
# 默认 10 道；指定数量示例：
node recipe-fusion-spider.js --count 50
```

- 会先调用 batch-planner 的缺口逻辑，取前 50 个高优先级缺口。  
- 每道菜串行：爬取参考 → LLM 融合 → 可选自动校验。  
- 每道之间间隔约 2 分钟（可配），结果写入 `tools/drafts/YYYY-MM-DD_fusion_batch.json`。

**单道菜融合（自定义关键词）**

```bash
npm run fuse
# 需带参数，例如：
node recipe-fusion-spider.js --single "空气炸锅羊排"
node recipe-fusion-spider.js --single "微波炉 羊肉"
```

**仅预览、不执行**

```bash
node recipe-fusion-spider.js --dry-run        # 默认前 10 道
node recipe-fusion-spider.js --dry-run --count 50
```

会打印将要融合的菜单列表，不写草稿、不调 LLM。

---

## 四、网页端：Recipe Manager + 融合车间

### 1. 启动服务

```bash
cd tools && npm run recipe-manager
```

浏览器打开：**http://localhost:3847**。

### 2. 融合车间 Tab

- **左侧 · 缺口雷达**  
  - 点击「加载缺口」：请求 `GET /api/spider/gaps`，展示当前高优先级缺口（如：羊肉 × 蒸/凉 × 酸爽）。  
  - 每条缺口旁有 **「派 AI 去学」**：触发单道融合，请求 `POST /api/spider/fuse`，结果进入草稿箱。

- **右侧 · 批量融合与待审批草稿**  
  - **批量融合**：输入数量，点击「批量融合」，后台按缺口列表依次融合，进度通过 SSE 推送到页面。  
  - **待审批草稿**：列出 `draft_recipes.json` 中的单道融合结果，以及批量生成的 `*_fusion_batch.json` 中的条目（通过「菜谱生成」Tab 的草稿选择器可查看批次文件）。  
  - 每条草稿可：**Approve（批准）** 或 **丢弃**。批准后写入本地 `miniprogram/data/recipes.js` 并同步到云端（若已配置 TCB）。

### 3. 推荐流程

1. 打开「融合车间」→ 点击「加载缺口」。  
2. 对感兴趣的缺口点「派 AI 去学」，或设置数量后点「批量融合」。  
3. 在「待审批草稿」中查看步骤与校验分，确认无误后点 **Approve**。  
4. 需要封面时，可在「步骤校验」或「封面管理」中为已入库菜谱生成/上传封面。

---

## 五、API 说明（供前端或脚本调用）

Base URL：`http://localhost:3847`（Recipe Manager 启动后）。

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/spider/gaps` | 获取当前缺口清单（matrix_gaps + cook_type_gaps）及统计 |
| POST | `/api/spider/fuse` | 单道融合，body: `{ dishHint, constraints? }`，结果写入草稿箱 |
| POST | `/api/spider/batch` | 提交批量融合，body: `{ count, intervalMs?, autoReview? }`，返回 `jobId` |
| GET | `/api/spider/batch/stream?jobId=xxx` | SSE 流式进度 |
| GET | `/api/spider/draft-recipes` | 获取单道融合草稿列表（draft_recipes.json） |
| POST | `/api/spider/approve-draft` | 批准单道草稿，body: `{ index }` |
| POST | `/api/spider/discard-draft` | 丢弃单道草稿，body: `{ index }` |

**单道融合示例**

```json
POST /api/spider/fuse
{ "dishHint": "羊肉 空气炸锅 酸爽", "constraints": { "meat": "lamb", "cook_type": "air_fryer", "flavor_profile": "sour_fresh" } }
```

**批量融合示例**

```json
POST /api/spider/batch
{ "count": 10, "intervalMs": 120000, "autoReview": true }
```

---

## 六、草稿与审批

- **单道融合**：结果追加到 `tools/drafts/draft_recipes.json`，每条带 `status: 'pending_review'`、`recipe`、`ref_recipes`、`review`（若开启自动校验）。  
- **批量融合**：结果写入 `tools/drafts/YYYY-MM-DD_fusion_batch.json`，结构类似「菜谱生成」的 batch 草稿，可在「步骤校验」Tab 选择该草稿文件逐条审阅、通过、同步云端。  
- **批准**：  
  - 单道：在融合车间点 Approve，或调 `POST /api/spider/approve-draft`，会写入本地 recipes 并调用云端入库（若已配置）。  
  - 批次：在「步骤校验」里选对应草稿文件，对单条做「通过」/「通过并生成封面」等操作，与现有流程一致。

---

## 七、常见问题

**Q：融合很慢？**  
- 单道约 30 秒～2 分钟（爬取 + LLM）。批量默认每道间隔 2 分钟，可在 `intervalMs` 或 CLI 逻辑里调小（注意站点限流）。

**Q：没有联网搜索？**  
- 当前实现使用 **HTTP 爬虫**（recipe-crawler）抓取下厨房/豆果/美食杰等站，未接 Kimi/Gemini 的 `use_search`。若后续接入联网搜索 API，只需在融合前增加「联网检索」步骤即可，流程不变。

**Q：草稿在哪里？**  
- 单道：`tools/drafts/draft_recipes.json`。  
- 批量：`tools/drafts/YYYY-MM-DD_fusion_batch.json`。

**Q：批准后如何生成封面？**  
- 在「封面管理」或「步骤校验」中，对已入库菜谱使用「重新生成封面」/ 上传逻辑；若接好 audit-covers 与 MiniMax，可再做成「批准后自动触发展图」的闭环。

**Q：`npm run auto-grow --count=50` 不生效？**  
- npm 传参需用 `--` 透传：`npm run auto-grow -- --count=50`，或直接：`node recipe-fusion-spider.js --count 50`。

---

## 八、文件与脚本速查

| 路径 | 说明 |
|------|------|
| `tools/recipe-fusion-spider.js` | 融合爬虫入口（CLI + 导出 fuseOneRecipe / fuseBatch） |
| `tools/batch-planner.js` | 缺口分析（CLI + 导出供 spider/server 调用） |
| `tools/templates/recipe-fusion-prompt.md` | 融合用 LLM 系统提示词 |
| `tools/recipe-manager-server.js` | 本地服务（含 /api/spider/* 与融合车间静态页） |
| `tools/recipe-manager-app/index.html` | 管理面板（含「融合车间」Tab） |
| `tools/drafts/` | 草稿目录（draft_recipes.json + *_fusion_batch.json） |

| npm 脚本（在 tools 下） | 说明 |
|------------------------|------|
| `npm run recipe-manager` | 启动 Recipe Manager（3847） |
| `npm run plan` | 缺口分析报告 |
| `npm run auto-grow` | 批量融合（默认 10 道） |
| `npm run fuse` | 单道融合（需在命令后加 `--single "菜名"`） |

---

*本手册对应「下厨房交叉融合爬虫与草稿审批流水线」实现，与 wabi-sabi 风格管理面板一致，以草稿审批为核心，保证入库质量。*
