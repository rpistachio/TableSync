# TableSync · Daily Nourish — 产品与技术架构全景文档

> **版本**: v4.9 · 2026年2月  
> **定位**: 面向投资人的产品全景分析——产品结构、技术架构、数据模型、AI能力、竞争优势与增长路径  
> **产品形态**: 微信小程序（WeChat Mini Program）  
> **Slogan**: Eat. Connect. Automate.  
> **v4.9 更新**: Omakase 摇一摇盲盒模式上线——首页摇一摇/FAB 触发惊喜菜单推荐（视觉准入过滤 + 14 天防重复 + AI omakase 策略 + ≤15字手账风微文案 + 揭菜仪式）；首页交互重构为 Context Dashboard Sheet（底部半屏抽屉含场景/口味/状态/厨具四区，Vibe Card 精简为日期+问候）；我的菜谱库新增「做过的菜」Tab（烹饪日志 + 再做一次 + 改评价反向修正亲和度）；设备模型扩展电饭煲/微波炉；口味亲和度加权随机选菜 + 风味互补矩阵（FLAVOR_COMPLEMENT）；统筹预览整合到 preview 页；工具链新增参考菜谱爬取（recipe-crawler）与 AI 交叉校验（recipe-reviewer），LLM 截断修复。详见 §15.0d。  
> **v4.8 更新**: 口味档案全链路上线——Taste Profile 持久化用户口味/食材偏好、需求探针内嵌 Vibe Card（跳过时优雅降级）、口味模糊匹配双口味灵活搭配；冰箱入口与本地库存管理（fridgeStore），临期食材驱动 AI 推荐；预览页「一句话微调」输入栏 + 换菜不喜欢反馈 → smartMenuGen 严格回避；做完饭三选项反馈卡 → 口味学习 + 自动冰箱扣减；数据模型扩展（羊肉/鸭肉/贝类/焗烤 + 辣度细分 + 16 种自动标签 + 亲和度排序）；封面图链路从 HTTP 直链重构为 cloud:// + getTempFileURL；问候引擎三层优先级（上下文感知/天气/通用）；封面风格从暗调极简转为暖光诱人；MJ Prompt Builder 完全重写（100+ 中英食材/智能容器/氛围注入）。详见 §15.0c。  
> **v4.7 更新**: 需求探针与 Zen 偏好降级：用户跳过口味探针时沿用本地口味档案（仪式感不强迫）；口味模糊匹配：当历史前两名口味分数接近（第二名≥第一名 70%）时，AI 收到双口味灵活搭配指令（如「平时爱吃清淡和辣味，两种方向都可以」），推荐更有人情味。详见 §7.2 口味档案与跳过探针降级。  
> **v4.6 更新**: 导入极速解析：链接导入改为先提取食材（Gemini/Kimi 二选一），步骤按需二次生成，避免云函数超时；新增 generateSteps 云函数模式；宝宝菜谱占位符按月龄替换；混合组餐封面 HTTP 直链与批量解析；统筹引擎支持空气炸锅；菜单多样性优化（番茄主料、疲惫素槽）；新增 20+ 道菜。详见 §15.1。  
> **v4.5 更新**: 混合组餐页（mix）UI 优化：菜名下方标签去药丸化，改为来源微标签 + 纯文字 · 分隔；底部三按钮由竖排改为横排（购物清单 | 让别人做 | 开始做），与预览页等风格统一。  
> **v4.4 更新**: 导入页能力与存储兼容：导入菜谱预览页新增「加入混搭组餐」「随机配一桌」入口（英雄卡片 + 5 按钮布局、AI 辅助信息合并）；今日菜单存储格式与导入菜兼容（canSafelySlimMenus：含无 id 或 ext- 菜谱时仅存完整格式，避免 preview/steps 反序列化丢失导致「未知菜谱」与步骤配料缺失）。详见 §6.3。  
> **v4.3 更新**: 端侧移除天气能力（首页仅保留时段问候，不再请求定位与 getWeather，app 权限精简）；预览页增加营养师插图与忌口胶囊简写、人数变更时按荤素道数智能重生成菜单、分享带图；步骤页双模式背景图（helper/自己做）、自己做模式 hero 区折叠动画、viewSteps 缓存与单次 setData 性能优化；购物页移除今日小贴士与调料特殊展示、底部栏微调；烟火集贴纸单元格与火漆/emoji 尺寸增强可读性；新增 i18n 基础配置与 miniapp 工程配置。  
> **v4.2 更新**: 用户行为埋点通用上报（utils/tracker.js）已实现，支持 spec 定义的 7 个核心事件 + 投篮(basket_add)、统筹预览(schedule_preview_view) 自动记录；云数据库 users 集合设计（OpenID 主键、family_id）已写入 spec 4.6.1；数据分析由「无埋点」更新为「已实现通用上报与投篮/统筹预览」。  
> **v4.1 更新**: 首页高级功能入口顺序与 UI 与当前一致；产品以 Zen Mode 为主路径，已无「今日灵感页/今日灵感篮」。

---

## 目录

1. [产品概述与愿景](#1-产品概述与愿景)
2. [核心用户画像与使用场景](#2-核心用户画像与使用场景)
3. [产品功能全景图](#3-产品功能全景图)
4. [用户旅程与核心流程](#4-用户旅程与核心流程)
5. [技术架构总览](#5-技术架构总览)
6. [数据架构与模型](#6-数据架构与模型)
7. [AI 能力矩阵](#7-ai-能力矩阵)
8. [核心算法深度解析](#8-核心算法深度解析)
9. [UI/UX 设计体系](#9-uiux-设计体系)
10. [云端基础设施](#10-云端基础设施)
11. [竞争优势分析（SWOT）](#11-竞争优势分析swot)
12. [技术壁垒与护城河](#12-技术壁垒与护城河)
13. [可扩展性与增长路径](#13-可扩展性与增长路径)
14. ["烟火集" — 游戏化增长引擎（规划中）](#14-烟火集--游戏化增长引擎规划中)
15. [附录：技术规格表](#15-附录技术规格表)

---

## 1. 产品概述与愿景

### 1.1 产品定义

**TableSync（家庭餐桌智能助手）** 是一款基于 AI 的家庭餐饮全流程管理微信小程序。它不只是菜谱工具——它是一个**厨房调度系统**，将多道菜的烹饪过程编排为并行流水线，像工厂排产一样高效利用灶台、蒸锅和时间窗口。

### 1.2 解决的核心痛点

| 痛点 | TableSync 解法 | 技术实现 |
|------|---------------|----------|
| 每天纠结"吃什么" | Zen Mode 一键出菜 / AI 智能推荐 | `smartMenuGen` 云函数 + 本地三层生成算法 |
| 买菜不知道买多少 | 智能购物清单（按人数动态缩放 + 合理上限） | 食材合并 + `getReasonableCap` + 共用标记 |
| 宝宝辅食和大人菜怎么兼顾 | 一菜两做：自动生成宝宝变体 | 月龄适配引擎（6-36个月） |
| 多菜同做手忙脚乱 | 并行烹饪流水线 + 设备冲突检测 | 间隙填充算法 + 设备追踪器 + 甘特图可视化 |
| 看到好菜谱想收藏 | 截图/链接一键导入结构化 | Kimi 多模态提取 + `normalizer.js` 自动归一化 |

### 1.3 产品愿景

> 让每个家庭的厨房，都拥有一位懂营养、会统筹、能调度的 AI 副厨。

---

## 2. 核心用户画像与使用场景

### 2.1 用户群体

| 用户类型 | 特征 | 核心需求 | 对应功能 |
|----------|------|----------|----------|
| **新手父母** (25-35) | 有6-36月宝宝 | 成人+宝宝一体化菜谱 | 月龄适配 + 过敏原管理 |
| **职场新厨** (22-30) | 工作忙、经验少 | 快手菜 + 分步教学 | Zen Mode + Cook Mode |
| **家庭主厨** (30-45) | 每天做3-4道菜 | 多菜并行 + 省时 | 流水线调度 + 甘特图 |
| **阿姨/帮佣** | 需清晰指令 | 简洁步骤 + 无干扰 | Ayi Mode（简化模式）|
| **美食爱好者** | 跨平台收集菜谱 | 导入 + 管理 + 混搭 | Import + MyRecipes + Mix |

### 2.2 双路径使用场景

```
场景A — "懒人模式" (Zen Mode)
打开App → 一键出菜 → 看预览 → 去买菜 → 照着做
(全程 < 30秒决策)

场景B — "定制模式" (混合组餐 / 导入)
混合组餐：从菜谱库或导入菜中多选 → 统筹预览 → 一键生成步骤与购物清单。  
导入：小红书/抖音链接或截图 → AI 提取 → 保存到我的菜谱 → 可「加入混搭组餐」或「随机配一桌」直接开做。

```

---

## 3. 产品功能全景图

### 3.1 功能架构（11个页面模块）

```
┌──────────────────────────────────────────────────────────────────┐
│                      TableSync 功能架构                           │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌───────────────────────────────────────────────────────────┐   │
│  │                      🏠 首页 Home                          │   │
│  │  Zen Mode · 摇一摇Omakase盲盒 · Context Sheet偏好设置    │   │
│  │  我的冰箱🧊入口 · 情境问候 · 更多高级功能(展开)          │   │
│  └───────────┬──────────────────────────────────────────────┘   │
│              │                                                     │
│    ┌─────────▼──────────────────────────────────┐                  │
│    │           📋 菜单预览 Preview               │                  │
│    │  仪表盘·节奏环·主厨报告·换菜·一句话微调·统筹  │                  │
│    └─────────┬─────────────────┬───────────────┘                  │
│              │                 │                                  │
│    ┌─────────▼──────┐  ┌──────▼──────────────┐                  │
│    │ 🛒 购物 Shopping │  │ 👨‍🍳 步骤 Steps        │                  │
│    │ 分类·缩放·勾选   │  │ Cook/Ayi双模式       │                  │
│    │ 共用标记·合理上限 │  │ 节奏环·甘特图        │                  │
│    └────────────────┘  │ 焦点卡·流水线预览    │                  │
│                         │ 浮动并行状态栏       │                  │
│                         └─────────────────────┘                  │
│                                                                   │
│  ── 高级功能入口 (首页「更多高级功能」展开后) ────────────────────  │
│  ┌────────────┐ ┌────────────┐ ┌────────────┐                       │
│  │ 🔗 导入    │ │ 🍳 混合组餐 │ │ 📚 我的菜谱库│                       │
│  │ 赛博菜谱   │ │            │ │            │                       │
│  └────────────┘ └────────────┘ └────────────┘                       │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

### 3.2 功能矩阵（含新增功能标记）

| 模块 | 核心功能 | AI加持 | 新增/增强 |
|------|---------|--------|----------|
| **首页** | Zen Mode + 摇一摇Omakase盲盒、Context Dashboard Sheet(场景/口味/状态/厨具)、口味档案降级、情境问候(上下文感知)、我的冰箱🧊入口 | 情境问候(三层优先级) + 口味档案驱动 AI 推荐 + Omakase 惊喜策略 | 🆕 Omakase · 🆕 Sheet |
| **预览** | 仪表盘、节奏环、主厨报告、一句话微调(Tweak Bar)、换菜不喜欢反馈、统筹对比与时间线、Omakase揭菜仪式 | 风味平衡 + userTweak 微调 + 不喜欢回避 + Omakase 微文案 | 🆕 Omakase揭菜 |
| **步骤** | Cook/Ayi双模式、节奏环、甘特图、焦点卡、做完饭反馈卡、自动冰箱扣减 | 流水线调度算法 | 🆕 反馈卡 · 🆕 冰箱扣减 |
| **购物** | 分类清单、动态缩放、勾选、共用食材标注、合理上限 | — | ✅ 已完善 |
| **导入** | 小红书/抖音链接、截图识别、编辑保存、保存后「加入混搭组餐」「随机配一桌」 | Kimi多模态 | ✅ 已完善 |
| **混合组餐** | 原生+导入自由组合、统筹预览、效率评分、3新肉类+焗烤筛选+电饭煲/微波炉 | 并行调度算法 | ✅ 已完善 |
| **我的菜谱** | 做过的菜Tab(日志/再做一次/改评价) + 导入菜谱Tab、云端+本地合并 | 改评价反向修正口味亲和度 | 🆕 做过的菜 |
| **烟火集** | 贴纸收集、手账视觉、口味画像卡片（偏好条/食材标签/忌口/做饭计数） | — | 🆕 口味画像 |
| **冰箱** | 食材库存管理、临期提醒、AI 推荐联动 | 临期食材 → heroIngredient | 🆕 冰箱管理 |

---

## 4. 用户旅程与核心流程

### 4.1 主路径：Zen Mode 菜单生成

```
                    ┌─────────────┐
                    │   🏠 首页    │
                    └──────┬──────┘
                           │
                           ▼
     ┌─────────────────┐
     │ ⚡ Zen Mode      │
     │ 一键生成          │
     │ (用上次偏好/默认) │
     └────────┬────────┘
              │
              ▼
     ┌─────────────────┐
     │ 📋 预览 Preview  │
     │ ·仪表盘(时间/灶台)│
     │ ·节奏环(并行可视化)│
     │ ·主厨报告(营养师推荐理由)│
     │ ·统筹对比与时间线 │
     │ ·可换菜           │
     └────────┬────────┘
              │ 确认
              ▼
     ┌─────────────────┐
     │ 🛒 购物 Shopping │
     │ ·分类清单         │
     │ ·合理上限         │
     │ ·共用食材标注     │
     └────────┬────────┘
              │ 买齐了
              ▼
     ┌─────────────────┐
     │ 👨‍🍳 步骤 Steps    │
     │ ·Cook Mode / Ayi │
     │ ·节奏环(并行进度)  │
     │ ·甘特图(全局纵览)  │
     │ ·焦点卡(当前步骤)  │
     │ ·浮动并行状态栏    │
     └────────┬────────┘
              │ 完成
              ▼
     🎉 料理完成 → 历史记录(7天)
```

### 4.2 高级路径：混合组餐与导入

```
定制路径 (非 Zen 一键出菜时):
    ├── 🍳 混合组餐：从菜谱库/导入菜多选 → 统筹预览 → 生成步骤与购物清单
    └── 🔗 导入：链接/截图 → AI 提取 → 预览页（英雄卡片+5 按钮）→「加入混搭组餐」或「随机配一桌」→ 跳转 mix 或 preview
```

导入页预览区：菜名/来源/标签合并为英雄卡片，食材与步骤为卡片化区块，置信度与耗时合并为一行；操作区为「直接开始做」+「加入混搭组餐」「随机配一桌」+「保存到菜谱」「重新导入」5 按钮布局。「随机配一桌」会以导入菜为第一道并生成其余搭配，写入今日菜单（存储格式见 §6.3）。

混合组餐页（mix）UI（v4.5）：已选菜谱卡片下标签改为来源微标签（原生/导入）+ 烹饪方式与荤素纯文字 · 分隔，去药丸化以减凌乱；底部操作栏三按钮（购物清单、让别人做、开始做）横排单行展示，与预览页等保持一致。

---

## 5. 技术架构总览

### 5.1 系统架构图

```
┌──────────────────────────────────────────────────────────────────┐
│                       客户端层 (Client Layer)                     │
│                                                                   │
│   ┌──────────────────────────────────────────────────────────┐   │
│   │            微信小程序 (WeChat Mini Program)                │   │
│   │                                                           │   │
│   │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐   │   │
│   │  │ 页面层    │ │ 逻辑层    │ │ 数据层    │ │ 工具层    │   │   │
│   │  │Pages(12) │ │ Logic    │ │ Data     │ │ Utils    │   │   │
│   │  │·WXML模板 │ │·comboOpt │ │·menuData │ │·cloudSvc │   │   │
│   │  │·WXSS样式 │ │·dashboard│ │·menuGen  │ │·imageLib │   │   │
│   │  │·JS控制器 │ │·probeEng │ │·recipes  │ │·stepHelp │   │   │
│   │  │·WXS脚本 │ │·protocol │ │·tastePro │ │·history  │   │   │
│   │  │          │ │          │ │·fridgeSt │ │·vibeGreet│   │   │
│   │  └──────────┘ └──────────┘ └──────────┘ └──────────┘   │   │
│   └──────────────────────────────────────────────────────────┘   │
│                                                                   │
├──────────────────────────────────────────────────────────────────┤
│                     云函数层 (4 Cloud Functions)                   │
│                                                                   │
│  ┌───────────┐ ┌───────────┐ ┌──────────┐                        │
│  │smartMenu  │ │ recipe    │ │recipeCov-│                        │
│  │  Gen      │ │  Import   │ │  erGen   │                        │
│  │·Kimi Chat │ │·链接抓取  │ │·MiniMax  │                        │
│  │·联网搜索  │ │·截图识别  │ │·DALL·E   │                        │
│  │·历史去重  │ │·归一化    │ │·MJ风格   │                        │
│  │          │ │·结构化    │ │          │                        │
│  └───────────┘ └───────────┘ └──────────┘                        │
│  ┌───────────┐                                                   │
│  │getWeather │ (端侧已停用，云函数保留可选)                        │
│  └───────────┘                                                   │
│                                                                   │
├──────────────────────────────────────────────────────────────────┤
│                    数据存储层 (三级降级)                           │
│                                                                   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────┐       │
│  │ 云DB (MongoDB)│  │ 云存储 (COS) │  │ 本地 Storage     │       │
│  │ ·recipes     │  │ ·封面图片    │  │ ·菜谱缓存        │       │
│  │ ·imported    │  │ ·步骤图片    │  │ ·菜单历史(7天)   │       │
│  │ ·users       │  │ ·Logo/封面   │  │ ·用户偏好        │       │
│  │ (OpenID+家庭)│  │              │  │ ·口味档案        │       │
│  │              │  │              │  │ ·冰箱库存        │       │
│  └──────────────┘  └──────────────┘  └──────────────────┘       │
│  兜底: miniprogram/data/recipes.js (离线slim版，仅算法字段)      │
│                                                                   │
├──────────────────────────────────────────────────────────────────┤
│                    外部 API 层                                    │
│                                                                   │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐           │
│  │Kimi(月之 │ │MiniMax   │ │OpenAI    │           │
│  │暗面)     │ │Image     │ │DALL·E 2  │           │
│  │·Vision   │ │·文生图   │ │·文生图   │           │
│  │·Chat     │ │          │ │(备选)    │           │
│  │·联网搜索 │ │          │ │          │           │
│  └──────────┘ └──────────┘ └──────────┘           │
│  (和风天气 QWeather 已从端侧移除，云函数可选保留)                 │
│                                                                   │
├──────────────────────────────────────────────────────────────────┤
│                    开发工具链 (tools/)                             │
│                                                                   │
│  菜谱生成(Claude) · 云端同步 · 批量导入 · 数据清洗               │
│  菜谱优化 · 一致性校验 · 趋势挖掘 · slim版生成                   │
└──────────────────────────────────────────────────────────────────┘
```

### 5.2 技术栈

| 层级 | 选型 | 说明 |
|------|------|------|
| 前端 | 微信小程序原生 | 12个页面（含冰箱），无框架依赖，性能最优 |
| 云开发 | 微信云开发 (TCB) | 免运维，原生微信集成 |
| 云函数 | Node.js × 4 | 无服务器，按需执行（fridgeScan/getWeather 已下线或端侧停用） |
| AI主力 | Kimi (月之暗面) | Vision + Chat + 联网搜索 |
| 图像生成 | MiniMax / DALL·E 2 | 封面图自动生成 |
| 情境问候 | 本地 vibeGreeting | 三层优先级（上下文感知/天气/通用）+ 5 种状态问候 |
| 数据库 | 云开发 MongoDB | 文档型，菜谱存储 |
| 工具链 | Anthropic Claude | 菜谱批量生产 |

### 5.3 架构设计原则

| 原则 | 实现 |
|------|------|
| **离线优先** | 三级降级：云DB → 本地缓存 → recipes.js兜底 |
| **纯函数设计** | 逻辑层不调用`wx.*`，输入→输出，可测试 |
| **设备感知** | 根据用户实际灶台数/设备动态调整调度策略 |
| **状态机驱动** | Import 页面以 stage 状态机管理复杂流程 |
| **增量同步** | 仅同步 `updateTime > lastSyncTime` 的数据 |

---

## 6. 数据架构与模型

### 6.1 核心数据模型

#### 菜谱 (Recipe)

```javascript
{
  id: "chicken_kung_pao",
  name: "宫保鸡丁",
  type: "adult" | "baby",
  meat: "chicken|pork|beef|fish|shrimp|lamb|duck|shellfish|vegetable",  // v4.8+: lamb/duck/shellfish
  taste: "quick_stir_fry|slow_stew|steamed_salad",
  flavor_profile: "spicy|salty_umami|light|sweet_sour|sour_fresh",
  cook_type: "stir_fry|stew|steam|cold_dress|bake",  // v4.8+: bake(焗/烤)
  dish_type: "soup" | null,
  prep_time: 15,                    // 备菜(分钟)
  cook_minutes: 20,                 // 烹饪(分钟)
  base_serving: 2,                  // 基准人数
  is_baby_friendly: true,
  can_share_base: true,
  common_allergens: ["peanut", "cilantro"],  // v4.8+: cilantro(香菜)
  tags: ["quick", "comfort", ...],  // v4.8+: 16种自动标签
  ingredient_group: "...",          // v4.8+: 食材分组
  spicy_sub: "mala|xianla|xiangla",// v4.8+: 辣度细分
  main_ingredients: [...],          // 云端格式
  seasonings: [...],                // 云端格式
  ingredients: [{                   // 本地合并格式
    name: "鸡胸肉", baseAmount: 300, unit: "g",
    category: "肉类", sub_type: "去骨"
  }],
  steps: [{
    step_type: "prep|cook",
    actionType: "long_term|active|idle_prep",
    duration_num: 5,
    waitTime: 30,                   // 被动等待(长耗时)
    parallel: true,
    text: "..."
  }],
  baby_variant: { name: "宝宝版鸡丁", month: 12, stages: [...] }
}
```

#### 用户偏好 (UserPreference) — 增强

```javascript
{
  adultCount: 1-6,
  hasBaby: boolean,
  babyMonth: 6-36,
  meatCount: 1-3,
  vegCount: 0-3,
  soupCount: 0-1,
  avoidList: ["spicy", "seafood", ...],
  dietStyle: "home|light|rich|quick",
  isTimeSave: boolean,
  kitchenConfig: {
    burners: 2,
    hasSteamer: true,
    hasAirFryer: false,
    hasOven: false,
    hasRiceCooker: false,          // v4.9+
    hasMicrowave: false            // v4.9+
  },
  // v4.8+ 口味档案驱动的新字段
  preferredMeats: ["chicken", "pork"],
  flavorHint: "偏好清淡口味",
  topFlavorKey: "light",
  secondFlavorKey: "spicy",          // 仅 flavorAmbiguous 时非空
  flavorAmbiguous: true,             // 前二名口味差距≤30%
  urgentIngredient: "鸡胸肉",        // 冰箱急用食材
  fridgeExpiring: ["鸡蛋", "豆腐"],   // 临期食材列表
  heroIngredient: "鸡蛋"             // 今日主角食材
}
```

#### 口味档案 (TasteProfile) — v4.8 新增

> 持久化到 `wx.setStorageSync('taste_profile')`，字段分为 volatile（session-only）和 persistent 两类。

```javascript
{
  scene: "couple",                 // volatile: solo/couple/family/gathering
  headcount: 2,                    // volatile
  flavorAffinity: {                // persistent: 累计口味偏好计数
    light: 5, spicy: 7, sour_fresh: 2, salty_umami: 3, sweet_sour: 1
  },
  ingredientAffinity: {            // persistent: 累计肉类偏好计数
    chicken: 8, pork: 5, fish: 3, beef: 2
  },
  avoidList: ["cilantro"],         // persistent: 忌口/过敏
  urgentIngredient: null,          // volatile: 冰箱急用
  kitchenConfig: {                 // persistent
    burners: 2, hasSteamer: true, hasAirFryer: false, hasOven: false,
    hasRiceCooker: false,          // v4.9+: 电饭煲
    hasMicrowave: false            // v4.9+: 微波炉
  },
  visitCount: 42,                  // persistent
  totalCooks: 18,                  // persistent
  lastProbeAt: "2026-02-24",       // persistent
  version: 1
}
```

### 6.2 数据存储策略

| 数据类型 | 存储位置 | 策略 | TTL |
|----------|---------|------|-----|
| 菜谱库 | 云DB + 缓存 + 兜底js | 增量同步 | 永久 |
| 导入菜谱 | 云DB + 本地 | 双写 | 永久 |
| 用户档案 (users) | 云DB | OpenID 主键、family_id 家庭组；详见 spec 4.6.1 | 永久 |
| 菜单历史 | 本地Storage | 本地 | 7天清理 |
| 用户偏好 | 本地Storage | 本地 | 永久 |
| 口味档案 (taste_profile) | 本地Storage | 本地；volatile 字段 session-only，persistent 累计 | 永久 |
| 冰箱库存 (fridge) | 本地Storage | 本地；做饭后自动扣减 | 永久 |
| 不喜欢菜品 | 本地Storage (via tasteProfile) | 本地；换菜时积累 | 永久 |
| 烹饪日志 (recipe_cook_log) | 本地Storage | 本地；做完饭自动记录，支持改评价 | 永久 |
| 封面视觉评分 (recipeCoverAudit) | 本地JS模块 | Omakase 视觉准入过滤 | 随代码版本 |

### 6.3 今日菜单存储格式与导入菜兼容（v4.4）

- **背景**：今日菜单（`today_menus`）在本地 Storage 中可存为 **slim**（仅菜谱 ID + 荤素/口味/勾选）或 **full**（完整菜谱对象）。反序列化时依赖 `getAdultRecipeById` 仅能解析**内置菜谱 id**；导入菜无 id 或 id 为 `ext-*` 时无法解析，会得到 `adultRecipe: null`，导致预览页显示「未知菜谱」、步骤与配料丢失。
- **约定**：写入 `today_menus` 前通过 **menuData.canSafelySlimMenus(menus)** 判断——仅当每道菜的 `adultRecipe` 均有内置可解析 id（有 id 且不以 `ext-` 开头）时才存 slim，否则一律存**完整菜单**。
- **调用点**：import 页「随机配一桌」写 storage、preview 页 onLoad 写回、「开始做饭」流程写 storage、人数变更持久化（若存在）等处，均需先判断再决定 slim 或 full。
- **产品价值**：用户从导入页「随机配一桌」或混合组餐中加入导入菜后，整桌菜单在预览与步骤页正确展示菜名、步骤与配料，无数据丢失。

### 6.4 数据流转

```
云数据库 ──增量同步──→ 本地缓存 ──降级──→ 本地兜底
    │                      │                │
    └──────────┬───────────┘                │
               ▼                            │
      cloudRecipeService ◄──────────────────┘
               │
               ▼
      全局菜谱缓存 (app.globalData)
               │
    ┌──────────┼──────────┬──────────┐
    ▼          ▼          ▼
 menuGen    import      mix
    │          │          │
    └──────────┼──────────┘
               ▼
      菜单 → 购物清单 → 步骤 → 历史(7天)
```

---

## 7. AI 能力矩阵

### 7.1 四大 AI 场景

| 场景 | AI服务 | 输入 | 输出 | 降级策略 |
|------|--------|------|------|----------|
| **智能推荐** | Kimi Chat + 联网搜索 | 偏好/历史/时段 | 推荐菜品ID列表 | 本地随机生成 |
| **菜谱导入** | Kimi Vision/Chat | 截图/链接 | 结构化Recipe JSON | 错误提示 |
| **封面生成** | MiniMax / DALL·E 2 | 菜品名 | MJ风格封面图 | 默认封面 |
| **情境问候** | 本地 vibeGreeting | — | 时段问候 | 天气能力已从端侧移除 |

### 7.2 AI 决策维度（smartMenuGen）— v4.8 全面升级

```
输入信号:
├── ⏰ 时段与上下文 → 上下文摘要参与推荐
├── 👨‍👩‍👧 家庭 → 有宝宝偏温和，人数/荤素/汤/忌口/饮食风格
├── ⚠️ 忌口 → 精确排除过敏原
├── 📅 历史 → 避免连续重复菜品（普通7天 / Omakase14天）
├── 🍽 口味档案 → flavorHint / topFlavorKey；模糊态 secondFlavorKey + 双口味灵活搭配
├── 🧊 冰箱临期 → fridgeExpiring 列表 + heroIngredient 主角食材锚点
├── 🚫 不喜欢 → dislikedDishNames 严格回避（换菜反馈积累）
├── ✏️ 用户微调 → userTweak（最高优先级，如「别放葱/想吃鱼」）
├── 🍳 设备 → 厨房配置参与调度（含电饭煲/微波炉）
└── 🎲 Omakase → 摇一摇盲盒心情策略 + 视觉准入 + omakaseCopy 微文案

新增 Prompt 段落:
├── 「用户特别要求」(userTweak，最高优先级)
├── 「冰箱临期食材」(fridgeExpiring)
├── 「今日主角食材」(heroIngredient)
├── 「用户近期不想吃的菜」(dislikedDishNames，严格回避)
├── 「口味语义对齐」(抽象标签→烹饪指令，如 light→清蒸/白灼/水煮)
├── 「P3.5 口味档案适配」
└── 「Omakase 微文案」(omakaseCopy ≤15字，场景感性理由，v4.9+)

心情策略: +omakase（惊喜感优先、故事感组合、视觉冲击力）
候选池: 80 → 500，超过 500 按肉类均匀截断；Omakase 额外视觉准入过滤
dishHighlights: 可选 → 必填因果推理

降级链: Kimi联网搜索 → Kimi普通Chat → 本地算法随机生成
```

**口味档案与跳过探针降级**：首页需求探针（场景/口味）内嵌在 Vibe Card；用户可直接点「想想吃什么」不回答。未回答时降级到本地 Taste Profile（`tasteProfile.get()` 的 scene / flavorAffinity），保证仪式感不变成强迫感。偏好构建顺序：Session 本次选择 &gt; 本地持久化 &gt; 默认配置。

**口味模糊匹配**：当 `flavorAffinity` 中第二名得分 ≥ 第一名 70% 时视为「模糊」（如辣 7、清淡 5）。此时 `preference` 传入 `secondFlavorKey` 与 `flavorAmbiguous`；prompt-builder 注入「用户平时爱吃 X 和 Y，两种方向都可以，请在套餐中灵活搭配」及两方向的烹饪语义，AI 可在一餐中混搭两种风格。

**做饭后口味学习闭环（v4.8）**：步骤页完成 → 三选项反馈（很喜欢/还不错/不太对）→ `tasteProfile.applyPostCookFeedback` 调整亲和度权重 → 下次推荐更懂用户 → 冰箱自动扣减已用食材。

### 7.3 食材匹配算法（fridgeScan，已下线）

> 端侧已无扫冰箱页面，云函数保留可选。算法逻辑（同义词 55+ 组、加权评分）可复用。

```
score = (主料匹配 / 主料总数) × 0.7 + (调料匹配 / 调料总数) × 0.1 + 类别加成 × 0.2
同义词映射: 55+组 | 类别加成: 有鸡肉→鸡类菜+0.2 | 精确匹配 > 类别匹配 > 同义词匹配
```

---

## 8. 核心算法深度解析

### 8.1 三层菜单生成算法

```
第一层: 预过滤 (Pre-Filter)
├── 过敏原排除 (avoidList → 食材映射)
├── 饮食风格 (home/light/rich/quick → 标签匹配)
├── 去重 (ID + 名称双重匹配)
└── 多样性 (主料去重、做法限频、命名前缀去重)

第二层: 设备感知选择 (Device-Aware Selection)
├── 动态设备上限 (基于 kitchenConfig.burners)
│   ├── wok + stove_long + pot 共享火眼池
│   ├── steamer: 独立设备(0或1)
│   └── 单灶模式: stove_long=0, pot=0 (自动退化)
├── 设备追踪器 (createDeviceTracker)
│   ├── 模拟设备占用时间线
│   ├── allocate(device, duration) → 建议startAt
│   └── 火眼池模式(共享) + 独立设备模式
├── 炖菜平衡: 最多1道慢炖
└── 风味平衡: applyFlavorBalance + applyVisualDiversity

第三层: 动态缩放 (Dynamic Scaling)
├── 非调料: amount = (adultCount / base_serving) × baseAmount
├── 调料: 保持"适量"
└── 合理上限: getReasonableCap 防止异常值
```

### 8.2 并行烹饪流水线调度算法

**这是产品最核心的技术壁垒。**

#### 8.2.1 五阶段流水线

```
输入: N道菜的独立步骤序列 + 用户厨房设备配置
    │
    ▼
Stage 1 — 规范化 (Normalize)
├── 补全 step_type, actionType, duration_num, waitTime
├── 文本估时: 从步骤描述中提取时间("炖30分钟"→30)
├── 推断设备类型
└── 交叉校验: 文本估时 vs duration_num

Stage 2 — 全局备菜合并 (Merge Prep)
├── mergeEssentialPrep: 合并所有菜的备菜步骤
├── 去重: 同一食材只处理一次
└── 输出: 统一备菜清单

Stage 3 — 间隙填充 (Gap Filling) ★核心
├── First-Fit-Decreasing: 按duration降序
├── 在长耗时等待窗口中穿插:
│   ├── active: 需要注意力的(快炒)
│   └── idle_prep: 可同时进行的(洗菜)
├── 尊重步骤依赖 (dependsOn)
├── 尊重设备上限 (burners共享池)
├── 单灶模式: 连续wok步骤间插入3分钟洗锅缓冲
└── 输出: 优化后的并行步骤序列

Stage 4 — 并行上下文注入 (Parallel Context)
├── 维护 activeLongTasks 列表
├── 为每步注入:
│   ├── parallelContext.activeTaskName (此时正在...)
│   ├── parallelContext.remainingMinutes (还剩X分钟)
│   └── parallelContext.hint (利用等待时间...)
└── 阶段切换标记 (prep→long_term→gap→cook→finish)

Stage 5 — 阶段标记 + 甘特图数据 (Annotate)
├── phaseTimeline 数据用于甘特图可视化
├── 阶段标题: "切配阶段"/"炖煮阶段"/"快炒阶段"/"收尾装盘"
└── 输出: 完整的统一步骤序列
```

#### 8.2.2 设备冲突检测

```
┌────────────────────────────────────────────────────────┐
│            家庭厨房设备约束建模                          │
│                                                         │
│  设备         实体映射        约束规则                   │
│  ───────────────────────────────────────                │
│  wok         炒锅/平底锅     共享火眼池                 │
│  stove_long  炖锅/砂锅       共享火眼池 + 长时间占用    │
│  pot         汤锅            共享火眼池                 │
│  steamer     蒸锅            独立设备(0或1)             │
│  air_fryer   空气炸锅        独立设备(0或1)             │
│  rice_cooker 电饭煲          独立设备(0或1) (v4.9+)     │
│  microwave   微波炉          独立设备(0或1) (v4.9+)     │
│  oven        烤箱            独立设备(0或1)             │
│  none        凉菜/拌菜       无设备需求                 │
│                                                         │
│  动态上限 (基于 kitchenConfig.burners):                 │
│  ├── 4灶: wok≤3, stove_long≤2, pot≤1                  │
│  ├── 2灶: wok≤2, stove_long≤1, pot≤1                  │
│  ├── 1灶: wok≤1, stove_long=0, pot=0 (严格串行)       │
│  └── 超限提示: "炒菜较多建议分批" / "灶台压力大"       │
│                                                         │
│  设备追踪器 (createDeviceTracker):                      │
│  ├── 模拟时间线上的设备占用                             │
│  ├── allocate(device, duration) → 最早可用时间          │
│  └── 支持火眼池共享(wok+stove_long+pot竞争同一灶台)    │
└────────────────────────────────────────────────────────┘
```

#### 8.2.3 效率对比

```
━━━ 传统串行 ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

时间 →  0    10    20    30    40    50    60    70    80分钟
        ├─备菜A─┤
                ├──── 红烧排骨 ────┤
                                   ├─备菜B─┤
                                           ├── 清蒸鱼 ──┤
                                                        ├─备菜C─┤
                                                                ├─快炒─┤
总时间: ≈80分钟


━━━ TableSync 并行流水线 ━━━━━━━━━━━━━━━━━━━━━━

时间 →  0    10    20    30    40    50分钟
        ├──统一备菜──┤
                     ├──── 🔥排骨(炖锅) ─────────────┤
                     ├── 🐟蒸鱼(蒸锅) ──┤             │
                     │                   ├─ 🥬快炒 ─┤ │
                     │              🍲汤锅同时煲汤──────┤
                                                 ├─收尾─┤

总时间: ≈45分钟  |  节省: ≈35分钟 (44%)

实测: 4菜 35-50% | 3菜 25-40% | 2菜 15-25%
```

---

## 9. UI/UX 设计体系

### 9.1 设计语言

| 维度 | 定义 |
|------|------|
| 设计风格 | 温暖食物感 (Warm Food-centric) |
| 主色调 | 暖橙 `#E8A87C` / 赭石 `#D4956A` |
| 背景色 | 米白 `#FDF8F2` / `#FAF9F7` |
| 文字色 | 深炭 `#2d2d2d` / 柔灰 `#7d746d` |
| 圆角 | 大圆角 24-48rpx |
| 图标 | Emoji驱动 (🍳🥗🛒👶) |
| 字体 | 系统字体栈 (-apple-system, BlinkMacSystemFont) |

### 9.2 交互设计亮点

| 设计点 | 说明 |
|--------|------|
| **Zen Mode** | 首页一键出菜，30秒内完成决策，极致减少认知负担；Context Sheet 精准设定偏好 |
| **Omakase 盲盒** | 摇一摇触发惊喜菜单推荐，全屏揭菜仪式 + ≤15字手账风微文案，0决策成本 |
| **Cook/Ayi 双模式** | Cook Mode面向主厨(完整信息)，Ayi Mode面向帮佣(简化指令) |
| **节奏环 (Rhythm Rings)** | 多环可视化并行任务进度，一眼看清所有在进行的烹饪 |
| **甘特图** | 底部弹出式全局时间线纵览，类似项目管理的排期视图 |
| **焦点卡** | 当前步骤突出显示，前后步骤半透明预览 |
| **浮动并行状态栏** | 顶部常驻显示正在进行的长任务(如"排骨还剩15分钟") |
| **冰箱贴日历视觉** | 购物清单的类别分组用冰箱贴风格卡片展示 |

---

## 10. 云端基础设施

### 10.1 云函数性能

| 云函数 | 触发场景 | 超时 | 内存 | AI调用 | 降级 |
|--------|---------|------|------|--------|------|
| **smartMenuGen** | 菜单推荐 | 30s | 128MB | Kimi Chat+搜索 | 本地随机 |
| **recipeImport** | 菜谱导入(image/link/generateSteps) | 60s | 256MB | Kimi Vision/Chat、Gemini(可选) | 错误提示 |
| **recipeCoverGen** | 封面生成 | 60s | 256MB | MiniMax/DALL·E | 默认封面 |
| **getWeather** | 天气获取(端侧已停用) | 15s | — | — | 静默失败 |

### 10.2 可靠性设计

| 机制 | 实现 |
|------|------|
| 重试 | MAX_RETRIES=2，指数退避 |
| 并行优化 | recipeImport 中 Vision 识别与 DB 查询并行 |
| 安全网 | 云端数据不足50%时合并本地fallback |
| 密钥管理 | secret-config.json + .gitignore |

---

## 11. 竞争优势分析（SWOT）

### 11.1 优势 (Strengths)

| 维度 | 核心优势 | 详细说明 |
|------|----------|----------|
| **调度算法** | 并行流水线+设备追踪器 | 模拟厨房物理约束（灶台火眼池+设备互斥），业内唯一 |
| **设备感知** | 动态适配用户厨房 | 根据实际灶台数(1-4)和设备(蒸锅/烤箱)自动调整调度策略 |
| **双模式** | Cook/Ayi | 同一份步骤，主厨看完整版，帮佣看简化版——精准适配不同角色 |
| **AI全链路** | 4个端侧AI场景 | 视觉识别→推荐→导入→封面，AI渗透率极高（天气已从端侧移除） |
| **母婴双轨** | 月龄适配 | 同菜自动生成宝宝变体(6-36个月)，切入新手父母痛点 |
| **离线能力** | 三级降级 | 云端→缓存→本地兜底，无网也能用核心功能 |
| **工具链** | 自动化菜谱生产 | Claude驱动批量生产+优化，可快速扩充高质量菜谱库 |

### 11.2 劣势与预防策略

| 维度 | 现状 | 风险 | 预防策略 | 优先级 |
|------|------|------|----------|--------|
| **用户画像** | 本地口味档案已上线 | 🟡中 | Taste Profile 本地持久化已完成（口味/食材偏好/忌口/做饭历史）；OpenID 云端同步待实现 | Phase 1.5 |
| **组件化** | 无通用组件库 | 🟡中 | 抽取RecipeCard/StepTimeline等 | Phase 2 |
| **数据分析** | 通用上报已实现 | 🟢低 | utils/tracker.js：7 个核心事件 + 投篮/统筹预览自动记录；steps 页内 7 事件待接入（spec 9.8） | 已实现基础能力 |
| **测试** | 无自动化测试 | 🟡中 | 纯函数架构天然适配单测 | Phase 2 |
| **平台** | 仅微信小程序 | 🟠低 | 有Vue Web版雏形(共享逻辑层) | Phase 4 |
| **商业化** | 无变现入口 | 🟡中 | 三条路径已规划(详见13.2) | Phase 2-3 |
| **菜谱规模** | ~200道 | 🟢低 | 自动化工具链+UGC导入飞轮 | 持续 |

### 11.3 机会

| 机会 | 说明 | 战略对齐 |
|------|------|----------|
| **游戏化增长** | "烟火集"贴纸收集体系 | 详见第14章 |
| **生鲜电商** | 购物清单→一键下单 | Phase 3 |
| **家庭协作** | 厨房看板同步(主厨+配偶实时联动) | Phase 3 |
| **品牌食材库** | 食材关联品牌→CPS导流 | Phase 2-3 |
| **虚拟冰箱** | 购买→存储→消耗→补货完整闭环 | Phase 2-3 |
| **B端SaaS** | 幼儿园/月子中心/养老院营养配餐 | Phase 4 |

---

## 12. 技术壁垒与护城河

```
┌────────────────────────────────────────────────────────┐
│                技术护城河层级                            │
│                                                         │
│  Level 4 (最难复制)                                     │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 并行流水线 + 设备追踪器 + 动态灶台适配           │   │
│  │ + 甘特图可视化 + Cook/Ayi双模式                   │   │
│  │ = 完整的厨房调度系统(3300+行核心算法)             │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  Level 3                                                │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 五重菜单平衡 (风味/设备/食材/营养/视觉)          │   │
│  │ 宝宝辅食月龄适配引擎                              │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  Level 2                                                │
│  ┌─────────────────────────────────────────────────┐   │
│  │ AI全链路集成 (4个端侧场景，含联网搜索)              │   │
│  │ 结构化菜谱Schema + 自动化生产工具链               │   │
│  │ 55+组同义词匹配 + 加权评分算法                    │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  Level 1                                                │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 三级离线降级 · 跨平台菜谱导入 · 增量同步         │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
└────────────────────────────────────────────────────────┘
```

---

## 13. 可扩展性与增长路径

### 13.1 技术路线图

```
Phase 1 — 当前已完成 ✅ ────────────────────────────────
✅ 微信小程序 (12个完整页面，含冰箱)
✅ 5大AI功能 + 联网搜索增强
✅ 并行流水线调度 + 设备追踪器 + 甘特图
✅ Zen Mode + Omakase 摇一摇盲盒 + Context Dashboard Sheet
✅ Zen Mode + Cook/Ayi双模式
✅ 口味档案全链路 (Taste Profile + 探针 + 反馈学习 + 做过的菜)
✅ 冰箱入口 + 临期食材 AI 联动
✅ 一句话微调 + 换菜反馈 + smartMenuGen 大升级 (含 omakase 策略)
✅ 数据模型扩展 (9种肉类 + 6种烹饪方式 + 16种标签 + 电饭煲/微波炉)
✅ 口味驱动加权选菜 + 风味互补矩阵
✅ 自动化菜谱工具链 + MJ Prompt Builder + 参考菜谱爬取/AI 校验
✅ 技术规范文档 (spec.md v4.9)

Phase 1.5 — 最优先 (1-2个月) ─────────────────────────
✅ 口味档案本地持久化 (忌口/过敏/口味/食材偏好/做饭历史)
□ OpenID 云端同步口味档案（users 集合设计已就绪，见 spec 4.6.1）
✅ 通用埋点与投篮/统筹预览已接入（steps 页内 7 个核心事件待接入）
□ 菜单卡片分享 (社交裂变种子)

Phase 2 — 近期 (3-6个月) ──────────────────────────────
□ "烟火集" Phase A-B: 贴纸掉落 + 日历 + 图鉴 + 段位
□ 虚拟冰箱镜像 v1 (购物入库 + 烹饪扣减)
□ 品牌食材库 (CPS导流基础)
□ 通用组件库重构
□ 菜谱库扩充至 500+

Phase 3 — 中期 (6-12个月) ─────────────────────────────
□ "烟火集" Phase C-D: 节气限定 + 付费贴纸 + 品牌联名 + 年报
□ 厨房看板同步 (家庭协作)
□ 生鲜电商对接
□ 营养计算与追踪
□ 菜谱社区 (UGC)

Phase 4 — 远期 (12-24个月) ────────────────────────────
□ 多平台 (iOS/Android/Web)
□ B端SaaS (幼儿园/月子中心)
□ 国际化 (多语言/多菜系)
□ 智能硬件对接
```

### 13.2 商业化路径

```
Layer 1: 免费增值 (Freemium)
├── 基础免费: 菜单生成·购物清单·烹饪步骤
└── VIP (¥19.9/月): AI无限次·甘特图·厨房看板·高级贴纸

Layer 2: 情绪资产 + 审美付费 ("烟火集")
├── 贴纸包 (¥6-12): 像素风/莫奈风/水墨风 主题贴纸
├── 实体商品 (¥49-199): 年度台历·冰箱贴·礼盒
└── 社交裂变: 烟火墙分享·年度味道年报(Spotify Wrapped模式)

Layer 3: 品牌合作 (B2B)
├── 品牌联名贴纸: 品牌→TableSync导流 (CAC=0)
├── 品类年度独占: ¥50-200K/年
├── 品牌定制菜谱: 内容营销
└── 购物清单→电商导流: CPS 5-15%

Layer 4: B端 SaaS
├── 幼儿园/月子中心/养老院 营养配餐系统
└── ¥500-2000/月/机构
```

---

## 14. "烟火集" — 游戏化增长引擎（规划中）

> **核心洞察**: 传统菜谱App让用户"花钱看菜谱"，"烟火集"让用户觉得自己在**"积累资产"** —— 每做一顿饭就多一张数字藏品。把"体力劳动"重新定义为"艺术创作"。

### 14.1 核心机制

| 机制 | 说明 |
|------|------|
| **盲盒贴纸** | 完成烹饪→掉落精美食物贴纸(普卡79.5%/限定15%/闪卡5%/传说0.5%) |
| **冰箱贴日历** | 月历看板，每做一顿饭多一张贴纸，月底满满的"我在好好生活" |
| **段位系统** | 菜鸟学徒→家常新手→备菜达人→流水线大师→烟火传说 |
| **节气厨房** | 24节气限定菜谱+限定贴纸，全年自带运营节点 |
| **食愈处方** | 追踪"心情→做饭→满足感"闭环，生成趣味处方卡 |
| **味道年报** | 年度数据可视化(Spotify Wrapped模式)，强社交传播 |
| **品牌联名** | 品牌限定贴纸，双向导流(品牌包装扫码→获贴纸→获用户) |

### 14.2 技术可行性

```
已有基础设施 → 直接复用:
├── recipeCoverGen 云函数框架 → 改为 stickerGen
├── MiniMax Image API → 切换prompt风格(插画/3D黏土/水墨)
├── cover-prompt.js 模板系统 → 扩展贴纸prompt
├── steps.js 完成逻辑 (L1449 markCurrentCompleted) → 注入贴纸掉落
└── menuHistory.js → 扩展为日历数据

新增开发量:
├── stickerDrop 页面 (掉落动画)
├── calendar 页面 (月历看板)
├── collection 页面 (图鉴)
└── 贴纸元数据模型 + 概率引擎
```

### 14.3 对标与预期

> **烟火集 = 多邻国的留存 × 泡泡玛特的收藏 × Spotify Wrapped的传播**

- K系数(病毒系数)预估: 1.2-1.8 (>1即自增长)
- 月度烟火墙分享预估: 活跃用户20-30%
- 年度味道年报分享预估: 活跃用户30-50%

---

## 15. 附录：技术规格表

### 15.0 近期产品与体验更新（2026-02-14 · v4.6）

以下为 v4.6 对应的产品与技术优化摘要。

| 维度 | 变更摘要 | 产品价值 |
|------|----------|----------|
| **导入云函数** | 链接导入改为极速解析：优先 Gemini（免费层），否则 Kimi 仅提取食材；步骤留待二次请求 generateSteps 按需生成；截图仍用 Kimi Vision 完整提取。 | 链接导入不再超时，国内可配置 MOONSHOT_API_KEY 使用 Kimi；步骤按需生成降低首屏等待。 |
| **宝宝菜谱** | menuGenerator.processBabyRecipePlaceholders：将 {{process_action}}/{{seasoning_hint}} 按月龄替换；menuData 反序列化与 generateSteps 时调用。 | 宝宝菜谱步骤正确显示，无占位符残留。 |
| **菜单多样性** | 素菜池番茄/西红柿不因主料排除；疲惫模式素槽凉拌池可跳过命名前缀去重。 | 避免总剩番茄炒蛋、总推老醋花生。 |
| **封面与图片** | recipeCoverSlugs.getRecipeCoverHttpUrl（HTTPS 直链）；imageLib.batchResolveTempUrls（批量解析+缓存）；mix 页原生用直链、导入用 getTempFileURL。 | 混合组餐封面加载更快，减少重复解析。 |
| **统筹引擎** | 支持 air_fryer 菜谱；烹饪顺序：空气炸锅→炖煮→蒸→快炒→凉菜；空气炸锅阶段 noWatch。 | 疲惫模式空气炸锅菜谱统筹展示正确。 |
| **菜谱数据** | 移除番茄炖牛腩（与番茄牛腩合并）；新增西芹炒虾仁、糖醋里脊、凉拌秋葵等 20+ 道。 | 菜谱库扩充，封面映射完善。 |
| **工具链** | llm-client count≥6 拆两批并行；getTextFromContent 处理 MiniMax 格式。 | 批量生成耗时减半。 |

### 15.0d Omakase 盲盒、Context Sheet 与做过的菜（2026-02-26 · v4.9）

| 维度 | 变更摘要 | 产品价值 |
|------|----------|----------|
| **Omakase 摇一摇盲盒** | 首页加速计手势检测 + FAB 按钮；模糊转场「正在为你安排…」；视觉准入过滤（recipeCoverAudit appetizing≥8 && styleConsistency≥8）；14天防重复窗口；smartMenuGen 新增 omakase 心情策略（惊喜感 + 故事感组合）；AI 返回 ≤15 字手账风微文案（omakaseCopy）；preview 全屏揭菜仪式（hero image + 菜名 + 微文案 + 配菜），摇一摇可换一组。 | 0 决策成本的惊喜体验——用户摇一摇即获得精心策划的一桌菜，增加「每天打开看看」的动机。 |
| **Context Dashboard Sheet** | 首页探针从 Vibe Card 内嵌改为底部半屏 Sheet（场景 pills 横滑 + 口味选择 + 疲惫/还好 toggle + 厨具多选）；Vibe Card 精简为日期+问候；底部固定操作栏（主 CTA + 摇一摇 FAB）。 | 偏好设定更清晰直观，首页视觉更干净，交互更符合移动端习惯。 |
| **做过的菜 Tab** | 我的菜谱库新增 Tab 切换（做过的菜 / 导入菜谱）；recipe_cook_log 持久化烹饪日志（每道菜保留最近 5 次历史）；展示反馈 emoji/次数/日期/备注；「再做一次」按菜名生成步骤跳转；「改评价」底部 Sheet 修改反馈+备注，反向修正全局亲和度。 | 用户的烹饪记忆可视化，形成「做→评→改→再做」的完整闭环；改评价即时影响下次推荐。 |
| **设备模型扩展** | 新增电饭煲(rice_cooker)、微波炉(microwave)；全链路适配：COOK_TYPE_TO_DEVICE/DEVICE_LIMITS/computeDeviceLimits/initDeviceCounts/createDeviceTracker/probeEngine/tasteProfile kitchenConfig。 | 覆盖更多真实厨房场景，设备感知调度更精准。 |
| **口味驱动选菜** | _affinityWeight 基于 flavorAffinity/preferredMeats 给候选菜谱加权；pickOneWithDeviceBalance 改为加权随机；menuData 传入 topFlavorKey/flavorAffinity/preferredMeats。 | 用户越做越合口味——偏好辣味的用户，辣味菜概率自然提升。 |
| **风味互补矩阵** | constant.js 新增 FLAVOR_COMPLEMENT（如 spicy→[light, sour_fresh]）；applyFlavorBalance 从硬编码改为查矩阵决定互补风味。 | 口味搭配更科学（辣配清淡/酸甜），避免全桌同一口味。 |
| **统筹预览整合** | preview.js 引用 scheduleEngine，展示串行 vs 并行时间对比。 | 用户在预览阶段即可看到效率提升。 |
| **菜谱数据优化** | recipes.js 大幅精简（-5003/+2872 行）；recipeCoverSlugs 新增映射；新建 recipeCoverAudit.js 视觉评分数据。 | 数据更精练，封面质量可量化。 |
| **工具链增强** | generate.js --with-ref 参考菜谱爬取 + --auto-review AI 交叉校验；llm-client max_tokens 16384 + tryRepairTruncatedJson 截断修复 + callLlmForJson 通用接口；排除列表本地+云端合并。 | 菜谱生产可交叉验证，LLM 调用更鲁棒。 |

### 15.0c 口味档案全链路、冰箱入口与 AI 推荐大升级（2026-02-24 · v4.8）

| 维度 | 变更摘要 | 产品价值 |
|------|----------|----------|
| **口味档案系统** | 新建 tasteProfile.js：持久化 flavorAffinity / ingredientAffinity / avoidList / kitchenConfig；getTastePortrait / applyPostCookFeedback / addDislikedRecipe / inferDietStyle 等 20+ API。 | 用户越用越懂——推荐从「随机」进化为「个性化」。 |
| **需求探针** | probeEngine.js：场景/口味探针内嵌 Vibe Card，单选自动提交、多选含确认键；上次选择金色呼吸光晕；dismiss 进退场动画。 | 低侵入式数据采集，首次用户 2 秒内完成场景设定。 |
| **冰箱入口** | 首页「我的冰箱」🧊 + fridgeStore.js 本地库存管理；临期食材作为 fridgeExpiring / heroIngredient 注入 AI prompt。 | 「冰箱里的XX该用掉了」→ AI 主动消耗临期食材。 |
| **一句话微调** | 预览页底部 Tweak Bar：输入自然语言 → smartMenuGen userTweak 最高优先级 → 智能关键词 boost。 | 「别放葱」「想吃鱼」→ 菜单秒级重新推荐。 |
| **换菜不喜欢反馈** | 替换时 ActionSheet 四项理由 → tasteProfile → dislikedDishNames 严格回避。 | 用户不再反复看到不喜欢的菜。 |
| **做完饭反馈卡** | 三选项评价 → applyPostCookFeedback → 自动冰箱扣减 → recordCookComplete。 | 完成烹饪后口味学习 + 冰箱自动更新，形成「推荐→做饭→反馈→更好推荐」闭环。 |
| **口味画像卡片** | 烟火集页展示偏好口味进度条 + 食材标签 + 忌口标签 + 做饭计数。 | 用户可视化自己的「味觉画像」，增强归属感。 |
| **数据模型扩展** | 新增 lamb/duck/shellfish 肉类 + bake 烹饪方式 + spicy_sub 辣度细分 + 16 种自动标签 + rankByAffinity 亲和度排序。 | 菜系覆盖更广，候选排序更精准。 |
| **smartMenuGen 升级** | 4 新参数 + 6 新 prompt 段落 + 口味语义对齐 + 候选池 80→500 + dishHighlights 必填因果推理。 | AI 推荐质量质变——从「随机挑」到「有理由的推荐」。 |
| **封面图链路重构** | HTTP 直链 → cloud:// FileID + getTempFileURL；imageLib 顺序批次避免竞态。 | 统一图片管理，消除直链失效风险。 |
| **问候引擎** | 三层优先级（上下文感知 > 天气 > 通用）；5 种状态问候（深夜/冰箱/连续做饭/首访/上次菜品）。 | 打开App的第一句话就「懂你」。 |
| **封面风格** | Krautkopf 暗调极简 → 暖光诱人丰富色彩；MJ Prompt Builder 完全重写（100+ 中英食材/智能容器/氛围注入）。 | 封面图更温暖更有食欲，视觉品质跃升。 |
| **Zen 偏好构建** | _buildZenPreference 从硬编码重写为 Taste Profile 动态构建（场景/口味/肉类/设备全从档案读取）。 | 偏好一次设置终身沿用，每餐推荐自动适配。 |
| **工具链** | mj-prompt-builder 重写 +298 行；recipe-system-prompt 新 cooking logic 8A-8E；validate-recipe-consistency +74 行校验；optimize-recipes 重试 + partial save。 | 菜谱生产质量与鲁棒性提升。 |

### 15.0b 需求探针与口味模糊匹配（v4.7）

| 维度 | 变更摘要 | 产品价值 |
|------|----------|----------|
| **跳过探针降级** | 用户不回答口味/场景探针直接点「想想吃什么」时，沿用本地 Taste Profile（session &gt; 持久化 &gt; 默认），仪式感不变成强迫感。 | 减少决策压力，老用户一键出菜更顺畅。 |
| **口味模糊匹配** | tasteProfile.getTopFlavors：前两名分数接近（第二名≥第一名 70%）时标记 ambiguous；preference 传 secondFlavorKey + flavorAmbiguous；prompt-builder 注入双口味灵活搭配指令。 | AI 推荐更有人情味（如「平时爱吃清淡和辣味，两种方向都可以」），一餐可混搭两种风格。 |
| **确认文案** | buildSessionSummary 模糊态展示「偏好辣味或清淡」。 | 与 AI 侧信息一致，用户感知更自然。 |

### 15.0a 近期产品与体验更新（2026-02-13 · v4.3）

以下为 v4.3 对应的产品与体验优化摘要，便于投资人对「持续打磨体验与性能」有直观把握。

| 维度 | 变更摘要 | 产品价值 |
|------|----------|----------|
| **首页与权限** | 移除天气能力：首页仅保留时段问候（vibeGreeting），不再请求定位与 getWeather；app 移除定位/天气相关权限。 | 降低隐私门槛、简化首屏依赖、体验更稳定。 |
| **预览页** | 营养师区增加插图（云存储 professional_talk_background）；忌口胶囊文案简写（如「忌辣」）、布局改为换行展示；人数变更时按荤/素道数智能判断——道数变化则重生成整桌菜单，否则仅缩放份量；分享卡片带图（help_background）。 | 提升信任感与可读性，人数调整更符合直觉，分享转化更优。 |
| **步骤页** | Helper 模式：顶部背景图（helper_step_background）+ 渐变遮罩，标题「今晚做：A、B、C」；自己做模式：hero 区（self_step_background + 今日菜名 + 鼓励文案），约 1.8s 后自动折叠；viewSteps 按引用缓存、静态字段单次设置、时间轴与并行任务合并进单次 setData；节奏环展示全部环；分享带图。 | 双模式视觉区分清晰，自己做更有仪式感，步骤页渲染性能提升。 |
| **购物页** | 移除「今日小贴士」（如鱼/虾提示）；调料统一展示用量，不再使用「按包装说明」；底部栏与按钮尺寸微调。 | 界面更简洁，信息更一致。 |
| **烟火集** | 贴纸单元格 padding、火漆容器与 emoji 尺寸增大，可读性增强。 | 收藏页视觉层次更清晰。 |
| **工程与配置** | 新增 i18n/base.json 多语言基础配置；miniprogram/app.miniapp.json、project.miniapp.json 工程配置。 | 为后续多语言与多端构建做准备。 |

技术侧重点：**端侧去天气**（云函数 getWeather 保留可选）、**步骤页 viewSteps 缓存与单次 setData** 降低重复计算与 setData 频次、**人数变更时的道数逻辑** 与菜单重生成保证荤素搭配合理。

### 15.1 项目规模

| 指标 | 数值 |
|------|------|
| 页面总数 | 12（新增冰箱页） |
| 云函数数量 | 4 |
| 核心算法文件 (menuGenerator.js) | 3,800+ 行 |
| 数据层文件 (menuData.js) | 1,526 行 |
| 步骤页控制器 (steps.js) | 1,500+ 行 |
| 口味档案 (tasteProfile.js) | 20+ API + recipe_cook_log |
| 需求探针 (probeEngine.js) | 含 Sheet 数据导出 |
| 冰箱库存 (fridgeStore.js) | 本地库存管理 |
| 云函数总代码 | ~3,500+ 行 |
| 菜谱数据量 | ~220道 (结构化，含 lamb/duck/shellfish) |
| 封面视觉评分 (recipeCoverAudit.js) | 供 Omakase 视觉准入过滤 |
| 自动标签系统 | 16 种标签 + rankByAffinity + _affinityWeight |
| 同义词匹配库 | 55+ 组 |
| AI集成点 | 4个端侧场景（smartMenuGen + omakase 策略） |
| 外部API | 3个 (Kimi/MiniMax/DALL·E)；QWeather 已从端侧移除 |
| 技术规范文档 | spec.md v4.9 |

### 15.2 代码规模对比（展示成熟度）

| 文件 | 行数 | 说明 |
|------|------|------|
| menuGenerator.js | 3,800+ | 核心算法引擎(三层生成+流水线+设备追踪+标签系统+亲和度排序+加权随机) |
| menuData.js | 1,526 | 数据层(套餐生成+购物清单+序列化) |
| steps.js | 1,500+ | 步骤页(双模式+甘特图+焦点卡+做完饭反馈+冰箱扣减) |
| tasteProfile.js | 新建 | 口味档案(20+ API：偏好/亲和度/反馈/画像/降级/烹饪日志/改评价) |
| probeEngine.js | 新建 | 需求探针(session管理/答案处理/确认文案) |
| fridgeStore.js | 新建 | 冰箱库存(临期检测/扣减/计数) |
| import.js | 956 | 导入页(双模式+AI提取+编辑) |
| cloudRecipeService.js | 696 | 云同步(增量+三级降级) |
| preview.js | 900+ | 预览页(节奏环+主厨报告+统筹对比+Tweak Bar+换菜反馈+Omakase揭菜) |
| home.js | 780+ | 首页(Zen Mode+Omakase+Context Sheet+冰箱入口+口味档案偏好构建) |
| normalizer.js (云函数) | 500+ | 归一化(自动推断所有字段+新肉类/烹饪方式) |
| prompt-builder.js (云函数) | 500+ | Prompt构建(口味档案+冰箱+微调+不喜欢+语义对齐) |
| mj-prompt-builder.js (tools) | 400+ | MJ封面Prompt(100+食材翻译+容器推断+氛围注入) |
| matcher.js (云函数) | 373 | 匹配算法(同义词+加权评分) |

---

> **文档编制**: TableSync 产品与技术团队  
> **最后更新**: 2026年2月26日  
> **版本**: v4.9  
> **保密等级**: 投资人内部参阅  
> **基于代码版本**: spec.md v4.9 · 12 页面 · 4 云函数 · Zen Mode + Omakase 摇一摇盲盒 + Context Dashboard Sheet · 做过的菜 Tab · 口味档案全链路 · 冰箱入口 · 口味驱动加权选菜 + 风味互补矩阵 · 设备扩展(电饭煲/微波炉) · smartMenuGen omakase 策略 · 参考菜谱爬取与 AI 交叉校验

---

*Eat. Connect. Automate.* 🍽
