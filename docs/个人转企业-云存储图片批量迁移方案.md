# 个人主体转企业：云存储图片批量迁移方案

## 先确认你是哪种情况

| 方式 | AppID | 云开发环境 | 是否需要迁图片 |
|------|--------|------------|----------------|
| **主体变更**（设置 → 主体信息 → 小程序主体变更） | **不变** | **不变** | **一般不需要**，变更后重新登录、重签协议即可 |
| **账号迁移**（原小程序迁到另一个已存在的企业小程序） | **会变**（用目标小程序的 AppID） | 原小程序被注销，需用**新环境** | **需要**迁移云存储 + 数据库 + 代码中的环境 ID |

- 若你只是「主体变更」：**不用做图片迁移**，云存储和数据库都还在同一账号下。
- 若你是「账号迁移」或「新注册企业小程序、从零开始」：需要按下面步骤做**云存储 + 数据库 + 代码**的批量迁移。

---

## 一、当前项目里图片都在哪

### 1. 云存储目录（当前环境：`cloud1-7g5mdmib90e9f670`）

| 目录/文件 | 用途 | 引用位置 |
|-----------|------|----------|
| `adults_recipes/*.png` | 菜谱封面图 | `recipes.js`、云端 `recipes` 集合的 `coverFileID` |
| `recipe_imports/*.jpg` | 用户导入的截图 | 导入流程上传，云函数处理 |
| `recipe_covers/*` | AI 生成的菜谱封面 | `imported_recipes` 集合的 `coverUrl` |
| `frontpage_stickers/*.png` | 首页贴纸、背景图 | `stickerCollection.js`、`home.js` |
| `logo/*.png` | Logo | `home.wxml` |
| `basic_cut_0_3_ar4.5.jpeg` | 默认封面 | `recipeCoverSlugs.js` |

### 2. 数据库里的图片引用（fileID）

- **云数据库集合 `recipes`**：字段 `coverFileID`，形如 `cloud://cloud1-7g5mdmib90e9f670.xxx/adults_recipes/xxx.png`
- **云数据库集合 `imported_recipes`**：字段 `coverUrl`，形如 `cloud://.../recipe_covers/xxx.jpg` 或 `recipe_imports/xxx.jpg`

### 3. 代码里写死的 cloud 前缀（需随新环境改）

需要替换为新环境 ID 的文件：

- `miniprogram/utils/cloudInitRecipes.js` → `DEFAULT_ENV`
- `miniprogram/data/recipeResources.js` → `CLOUD_ROOT`
- `miniprogram/data/recipeCoverSlugs.js` → `CLOUD_STORAGE_BASE`、`DEFAULT_COVER_URL`
- `miniprogram/data/stickerCollection.js` → `CLOUD_STICKERS_BASE`
- `miniprogram/pages/home/home.js` → `HOME_BG_CLOUD_PATH`、贴纸相关 cloud 路径
- `miniprogram/pages/home/home.wxml` → logo 的 `src`（若为 cloud://）
- `miniprogram/data/recipes.js` → 每条菜谱的 `coverFileID`（若仍用本地数据源，同步后以云端为准）

---

## 二、批量迁移云存储图片的几种方式

前提：新小程序已开通云开发，并记下**新环境 ID**（如 `cloud2-xxxx`）。

### 方式 1：控制台手动导出 / 上传（适合文件量不大）

1. **旧环境导出**
   - 登录 [腾讯云开发控制台](https://tcb.cloud.tencent.com)，进入**旧环境**。
   - 打开「云存储」→ 按目录（如 `adults_recipes`、`recipe_imports`、`recipe_covers`、`frontpage_stickers`、`logo`）逐个下载或「批量下载」到本地。

2. **新环境上传**
   - 切换到**新环境**（或新小程序关联的云环境）。
   - 在云存储中建立相同目录结构，把下载好的文件**按相同路径**上传（如 `adults_recipes/xxx.png`）。

3. **注意**
   - 保持**路径和文件名一致**，这样后面批量替换 fileID 时只需换「环境前缀」，逻辑简单。

### 方式 2：云函数 + 新环境上传（适合文件多、想自动化）

思路：在**旧环境**写一个「迁移用」云函数，遍历云存储文件，下载到 buffer，再通过 HTTP 或新环境 API 上传到新环境。

- 旧环境云函数：用 `cloud.downloadFile` 或存储 API 取文件 → 得到临时链接或 buffer。
- 新环境接收：需要在新环境有一个「接收上传」的云函数或 HTTP 接口，把文件按原路径写入新环境云存储。
- 跨环境时需在新环境配置好权限/密钥，或使用同一腾讯云账号下的云开发 REST API（若开放）。

实现细节依赖腾讯云开发是否支持「从云函数往另一环境写存储」，可查当前文档或提工单确认。

### 方式 3：Node 脚本（本地拉取 + 上传到新环境）

若你能在本地用 Node 访问「旧环境」和「新环境」（例如通过腾讯云 API、或导出为 COS 再对接云开发），可以：

1. 从旧环境**列出所有文件**（按前缀/目录），再逐个**下载到本地**。
2. 用新环境的**上传 API**（云开发 HTTP API 或 SDK）按**相同路径**上传到新环境。

这样不依赖控制台手工操作，适合大批量。具体 API 以 [微信云开发文档](https://developers.weixin.qq.com/miniprogram/dev/wxcloudservice/storage/api.html) 和腾讯云开发服务端 API 为准。

---

## 三、数据库里的 fileID 批量替换

迁移完云存储后，旧环境数据库里的 `cloud://旧环境ID/...` 要改成 `cloud://新环境ID/...`。

1. **导出旧环境数据库**
   - 控制台 → 数据库 → 选中集合（如 `recipes`、`imported_recipes`）→ 导出。

2. **本地批量替换**
   - 用文本编辑器或脚本，把导出 JSON 中所有：
     - `cloud://cloud1-7g5mdmib90e9f670.636c-cloud1-7g5mdmib90e9f670-1401654193/`
     替换为：
     - `cloud://新环境ID.xxx/`（新环境的完整 fileID 前缀，以控制台或文档为准）。

3. **导入新环境**
   - 在新环境创建同名集合（若没有），再导入替换后的 JSON。

注意：若新环境 fileID 格式与旧环境不同（例如多了一段后缀），要以新环境实际返回的 fileID 格式为准，做「路径一致」的替换规则。

---

## 四、代码中环境 ID 与 cloud 前缀的替换

在新小程序项目中，全局替换**旧环境 ID** 为**新环境 ID**。

当前项目中的旧环境标识：

- 完整前缀：`cloud://cloud1-7g5mdmib90e9f670.636c-cloud1-7g5mdmib90e9f670-1401654193`
- 简写 env：`cloud1-7g5mdmib90e9f670`

需要修改的位置（替换为你的新环境 ID）：

| 文件 | 内容 |
|------|------|
| `miniprogram/utils/cloudInitRecipes.js` | `DEFAULT_ENV = '新环境ID'` |
| `miniprogram/data/recipeResources.js` | `CLOUD_ROOT = "cloud://新环境完整前缀"` |
| `miniprogram/data/recipeCoverSlugs.js` | `CLOUD_STORAGE_BASE`、`DEFAULT_COVER_URL` 中的 cloud 前缀 |
| `miniprogram/data/stickerCollection.js` | `CLOUD_STICKERS_BASE` |
| `miniprogram/pages/home/home.js` | `HOME_BG_CLOUD_PATH` 及贴纸 cloud 路径 |
| `miniprogram/pages/home/home.wxml` | logo 的 `src`（若为 cloud://） |
| `miniprogram/data/recipes.js` | 各条目的 `coverFileID`（若仍保留本地 fallback） |

云函数若在代码里写死了环境，也要改为新环境或使用「当前环境」的写法。

---

## 五、推荐操作顺序（账号迁移 / 新企业小程序时）

1. 新小程序开通云开发，创建新环境，记下**新环境 ID** 和 **fileID 前缀**。
2. **先迁云存储**：按「方式 1」或「方式 3」把旧环境云存储按目录批量下载，再按相同路径上传到新环境。
3. **再迁数据库**：导出旧环境 `recipes`、`imported_recipes` 等，本地替换 fileID 为 New 环境前缀，导入新环境。
4. **最后改代码**：在项目里全局替换旧环境 ID 为新环境 ID，并上传/部署云函数到新环境。
5. 在新小程序后台配置 **downloadFile 合法域名**（新环境对应的域名），参考：`docs/云存储封面图-downloadFile合法域名配置.md`。

若你只是**主体变更**且 AppID 不变，通常只需在后台完成主体变更流程，**无需做上述迁移**；若有异常，再联系微信或腾讯云支持确认当前环境的归属。
